<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GAFFER26 ‚Äî ACFC presents</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Inter:wght@400;500;600&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* Fallback: ensure text is visible even before Google Fonts load */
@font-face { font-family: 'Oswald'; font-display: swap; }
@font-face { font-family: 'Inter'; font-display: swap; }
@font-face { font-family: 'Poppins'; font-display: swap; }
</style>
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --gold: #d4af37;
  --gold-light: #f0d060;
  --dark: #0a0a0f;
  --dark-card: #12121a;
  --gk: #4a90d9;
  --def: #e74c3c;
  --mid: #f39c12;
  --str: #2ecc71;
  --gk-bg: rgba(74,144,217,0.12);
  --def-bg: rgba(231,76,60,0.12);
  --mid-bg: rgba(243,156,18,0.12);
  --str-bg: rgba(46,204,113,0.12);
  --war-red: #ff2244;
}

body {
  font-family: 'Inter', sans-serif;
  background: var(--dark);
  color: #fff;
  min-height: 100vh;
  overflow-x: hidden;
  user-select: none;
}

/* ‚îÄ‚îÄ TITLE SCREEN ‚îÄ‚îÄ */
#title-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  text-align: center;
  padding: 2rem;
}

#title-screen h1 {
  font-family: 'Oswald', sans-serif;
  font-size: clamp(3rem, 9vw, 6rem);
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  background: linear-gradient(135deg, #fff, var(--gold-light), var(--gold), #b8960c);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  line-height: 1.05;
  text-shadow: none;
  filter: drop-shadow(0 2px 8px rgba(212,175,55,0.3));
}

#title-screen .subtitle {
  font-family: 'Oswald', sans-serif;
  font-size: clamp(1rem, 3vw, 1.5rem);
  color: #888;
  text-transform: uppercase;
  letter-spacing: 0.3em;
  margin-top: 0.5rem;
}

#title-screen .tagline {
  color: #666;
  font-size: 0.95rem;
  margin-top: 1.5rem;
  max-width: 500px;
  line-height: 1.6;
}

.btn-deal {
  margin-top: 2.5rem;
  font-family: 'Oswald', sans-serif;
  font-size: 1.4rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  padding: 1rem 3.5rem;
  border: 2px solid var(--gold);
  background: transparent;
  color: var(--gold);
  cursor: pointer;
  transition: all 0.3s;
}

.btn-deal:hover {
  background: var(--gold);
  color: var(--dark);
  box-shadow: 0 0 30px rgba(212,175,55,0.3);
}

/* ‚îÄ‚îÄ TITLE SCREEN ANIMATIONS ‚îÄ‚îÄ */
#title-screen.title-animate-in > img {
  opacity: 0; transform: scale(0.6) translateY(30px);
  animation: titleLogoIn 1s cubic-bezier(0.2,0,0.1,1) 0.2s forwards;
}
#title-screen.title-animate-in > h1 {
  opacity: 0; transform: translateY(40px);
  animation: titleTextIn 0.8s cubic-bezier(0.2,0,0.1,1) 0.6s forwards;
}
#title-screen.title-animate-in > .subtitle {
  opacity: 0; transform: translateY(30px);
  animation: titleTextIn 0.7s cubic-bezier(0.2,0,0.1,1) 0.9s forwards;
}
#title-screen.title-animate-in > .tagline {
  opacity: 0; transform: translateY(20px);
  animation: titleTextIn 0.6s ease-out 1.1s forwards;
}
#title-screen.title-animate-in > #name-entry {
  opacity: 0; transform: translateY(20px);
  animation: titleTextIn 0.6s ease-out 1.3s forwards;
}
#title-screen.title-animate-in > div {
  opacity: 0; transform: translateY(15px);
  animation: titleTextIn 0.5s ease-out 1.5s forwards;
}
#title-screen.title-animate-in > div:last-child {
  opacity: 0; transform: none;
  animation: titleFadeIn 0.6s ease-out 1.8s forwards;
}
@keyframes titleLogoIn {
  0% { opacity: 0; transform: scale(0.6) translateY(30px); filter: drop-shadow(0 0 0px rgba(212,175,55,0)); }
  60% { opacity: 1; transform: scale(1.05) translateY(-5px); filter: drop-shadow(0 0 50px rgba(212,175,55,0.6)); }
  100% { opacity: 1; transform: scale(1) translateY(0); filter: drop-shadow(0 0 30px rgba(212,175,55,0.3)); }
}
@keyframes titleTextIn {
  0% { opacity: 0; transform: translateY(30px); }
  100% { opacity: 1; transform: translateY(0); }
}
@keyframes titleFadeIn {
  0% { opacity: 0; }
  100% { opacity: 0.4; }
}

/* ‚îÄ‚îÄ EXIT / HOME BUTTON ‚îÄ‚îÄ */
.exit-btn {
  position: fixed;
  top: 0.6rem;
  right: 0.6rem;
  z-index: 150;
  font-family: 'Oswald', sans-serif;
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  padding: 0.35rem 0.8rem;
  border: 1px solid #333;
  background: rgba(10,10,15,0.8);
  color: #666;
  cursor: pointer;
  transition: all 0.3s;
  display: none;
  backdrop-filter: blur(4px);
}
.exit-btn:hover {
  border-color: var(--war-red);
  color: var(--war-red);
  background: rgba(255,34,68,0.08);
}

/* ‚îÄ‚îÄ GAME SCREEN ‚îÄ‚îÄ */
#game-screen {
  display: none;
  flex-direction: column;
  height: 100vh;
  padding: 0.5rem 1rem;
  overflow: hidden;
}

/* Scoreboard */
.scoreboard {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1.5rem;
  padding: 0.5rem 0;
  font-family: 'Oswald', sans-serif;
  flex-shrink: 0;
}

.score-side {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 1rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.score-side .count {
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--gold);
  min-width: 2ch;
  text-align: center;
}

.score-divider { color: #333; font-size: 1.2rem; }

.turn-indicator {
  text-align: center;
  font-family: 'Oswald', sans-serif;
  font-size: clamp(1.6rem, 5.5vw, 2.6rem);
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--gold);
  min-height: 1.5em;
  flex-shrink: 0;
  text-shadow: 0 0 18px rgba(212,175,55,0.4);
  padding: 0.5rem 0.8rem;
  line-height: 1.2;
}

/* War pile indicator */
.war-pile {
  text-align: center;
  font-family: 'Oswald', sans-serif;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--war-red);
  min-height: 1.1em;
  flex-shrink: 0;
}

/* Comeback indicator */
.comeback-indicator {
  display: none;
  text-align: center;
  font-family: 'Oswald', sans-serif;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.2em;
  padding: 0.2rem 0.8rem;
  border-radius: 3px;
  animation: comebackPulse 1.5s ease infinite;
  flex-shrink: 0;
}

.comeback-indicator.player-comeback {
  display: block;
  color: var(--gold);
  border: 1px solid var(--gold);
  background: rgba(212,175,55,0.08);
}

.comeback-indicator.cpu-comeback {
  display: block;
  color: var(--war-red);
  border: 1px solid var(--war-red);
  background: rgba(255,34,68,0.08);
}

@keyframes comebackPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ‚îÄ‚îÄ PLAY AREA (center stage) ‚îÄ‚îÄ */
.play-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0.8rem;
  min-height: 0;
  position: relative;
  z-index: 10;
}

.battlefield {
  display: flex;
  align-items: flex-start;
  justify-content: center;
  gap: clamp(0.8rem, 3vw, 2rem);
}

.card-column {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.3rem;
}

.card-label {
  font-family: 'Oswald', sans-serif;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.2em;
  color: #555;
}

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card-wrapper {
  perspective: 800px;
  width: clamp(180px, 32vw, 280px);
  height: clamp(370px, 60vw, 500px);
}

.card {
  width: 100%;
  height: 100%;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.card.flipped { transform: rotateY(180deg); }

.card-face {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  border-radius: 10px;
  overflow: hidden;
}

.card-back {
  background: var(--dark-card);
  border: 2px solid #222;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 0.3rem;
}

.card-back-logo {
  font-family: 'Oswald', sans-serif;
  font-size: 1rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: #333;
}

.card-back-sub {
  font-size: 0.55rem;
  text-transform: uppercase;
  letter-spacing: 0.3em;
  color: #222;
}

.card-front {
  background: var(--dark-card);
  border: 2px solid var(--gold);
  transform: rotateY(180deg);
  display: flex;
  flex-direction: column;
  padding: clamp(0.6rem, 1.5vw, 1rem);
}

.card-front::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
}

.card-front.pos-gk::before { background: var(--gk); }
.card-front.pos-def::before { background: var(--def); }
.card-front.pos-mid::before { background: var(--mid); }
.card-front.pos-str::before { background: var(--str); }

.card-front.pos-gk { background: linear-gradient(180deg, var(--gk-bg), var(--dark-card) 40%); }
.card-front.pos-def { background: linear-gradient(180deg, var(--def-bg), var(--dark-card) 40%); }
.card-front.pos-mid { background: linear-gradient(180deg, var(--mid-bg), var(--dark-card) 40%); }
.card-front.pos-str { background: linear-gradient(180deg, var(--str-bg), var(--dark-card) 40%); }

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.2rem;
}

.card-suit { font-size: clamp(1rem, 2.5vw, 1.3rem); }
.card-rank {
  font-family: 'Oswald', sans-serif;
  font-size: clamp(1rem, 2.5vw, 1.3rem);
  font-weight: 700;
  color: var(--gold);
}

.card-position {
  font-family: 'Oswald', sans-serif;
  font-size: clamp(0.5rem, 1.2vw, 0.6rem);
  text-transform: uppercase;
  letter-spacing: 0.25em;
  margin-bottom: 0.1rem;
}

.card-front.pos-gk .card-position { color: var(--gk); }
.card-front.pos-def .card-position { color: var(--def); }
.card-front.pos-mid .card-position { color: var(--mid); }
.card-front.pos-str .card-position { color: var(--str); }

.card-photo-wrapper {
  width: calc(100% + 2rem);
  margin-left: -1rem;
  height: clamp(120px, 28vw, 210px);
  border-radius: 0;
  margin-top: 0.15rem;
  margin-bottom: 0.25rem;
  overflow: hidden;
  border: none;
  border-top: 1px solid rgba(212,175,55,0.2);
  border-bottom: 1px solid rgba(212,175,55,0.2);
  background: rgba(255,255,255,0.03);
  flex-shrink: 0;
  position: relative;
}

.card-photo {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: top center;
  display: block;
  filter: contrast(1.1) saturate(1.05);
  transition: filter 0.3s;
}

.card-photo-wrapper::after {
  content: '‚öΩ';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 2rem;
  opacity: 0.2;
  pointer-events: none;
  z-index: 0;
}

.card-photo-wrapper:has(.card-photo[data-loaded="true"])::after {
  display: none;
}

/* Cinematic vignette on photo */
.card-photo-wrapper::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, transparent 50%, rgba(18,18,26,0.85) 100%);
  z-index: 1;
  pointer-events: none;
}

.card-name {
  font-family: 'Oswald', sans-serif;
  font-size: clamp(0.9rem, 2.2vw, 1.2rem);
  font-weight: 700;
  text-transform: uppercase;
  line-height: 1.15;
  margin-bottom: 0.1rem;
}

.card-nickname {
  font-size: clamp(0.48rem, 1.1vw, 0.58rem);
  color: #888;
  font-style: italic;
  line-height: 1.3;
  margin-bottom: auto;
  min-height: 1.5em;
}

/* Ability badge on card */
.card-ability {
  font-family: 'Oswald', sans-serif;
  font-size: clamp(0.48rem, 1.1vw, 0.56rem);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--gold);
  background: rgba(212,175,55,0.1);
  border: 1px solid rgba(212,175,55,0.25);
  border-radius: 3px;
  padding: 0.15rem 0.35rem;
  margin-bottom: 0.3rem;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.card-stats {
  display: flex;
  flex-direction: column;
  gap: clamp(0.25rem, 0.8vw, 0.4rem);
}

.stat-row {
  display: flex;
  align-items: center;
  gap: 0.35rem;
}

.stat-icon { font-size: clamp(0.6rem, 1.5vw, 0.75rem); width: 1.2em; text-align: center; flex-shrink: 0; }
.stat-label {
  font-family: 'Oswald', sans-serif;
  font-size: clamp(0.48rem, 1.2vw, 0.6rem);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: #aaa;
  width: 4em;
  flex-shrink: 0;
}

.stat-bar-bg {
  flex: 1;
  height: clamp(8px, 2vw, 11px);
  background: #1a1a25;
  border-radius: 2px;
  overflow: hidden;
}

.stat-bar-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.6s ease, background 0.3s;
  background: #555;
}

.stat-value {
  font-family: 'Oswald', sans-serif;
  font-size: clamp(0.55rem, 1.3vw, 0.7rem);
  font-weight: 600;
  width: 2ch;
  text-align: right;
  flex-shrink: 0;
}

.stat-row.won .stat-bar-fill { background: var(--gold) !important; box-shadow: 0 0 8px rgba(212,175,55,0.5); }
.stat-row.won .stat-value { color: var(--gold); font-weight: 700; }
.stat-row.lost .stat-bar-fill { background: #e74c3c !important; }
.stat-row.lost .stat-value { color: #e74c3c; }

/* ‚îÄ‚îÄ STAT BUTTONS (blind pick) ‚îÄ‚îÄ */
.stat-buttons {
  display: none;
  flex-wrap: wrap;
  justify-content: center;
  gap: 0.6rem;
  margin-top: 0.4rem;
  padding: 0.5rem 0.3rem;
  flex-shrink: 0;
  position: relative;
  z-index: 50;
}

.stat-buttons.active { display: flex; }

/* When stat buttons are visible, dim hand cards and push them back */
#game-screen:has(.stat-buttons.active) .hand-card {
  pointer-events: none;
  opacity: 0.35;
  transform: scale(0.9);
}
#game-screen:has(.stat-buttons.active) .hand-area {
  z-index: 0;
  position: relative;
}

.stat-btn {
  font-family: 'Oswald', sans-serif;
  font-size: clamp(0.85rem, 2.2vw, 1.1rem);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 0.65rem 1.4rem;
  border: 2px solid #444;
  background: rgba(255,255,255,0.05);
  color: #ddd;
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s;
  min-height: 44px;
  touch-action: manipulation;
}

.stat-btn:hover {
  border-color: var(--gold);
  color: var(--gold);
  background: rgba(212,175,55,0.08);
}

.stat-btn:active {
  transform: scale(0.95);
}

/* ‚îÄ‚îÄ ABILITY BUTTON (SUPERPOWER) ‚Äî BIG & UNMISSABLE ‚îÄ‚îÄ */
.ability-btn {
  display: none;
  font-family: 'Oswald', sans-serif;
  font-size: clamp(1.1rem, 3vw, 1.5rem);
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  padding: 1rem 2.5rem;
  border: 3px solid var(--gold);
  background: linear-gradient(135deg, rgba(212,175,55,0.25), rgba(212,175,55,0.08));
  color: var(--gold);
  cursor: pointer;
  border-radius: 12px;
  transition: all 0.2s;
  margin-top: 0.6rem;
  position: relative;
  z-index: 10;
  width: 90%;
  max-width: 360px;
}

.ability-btn.active {
  display: block;
  animation: abilityPulse 1s ease infinite, abilityBlink 0.5s ease-in-out infinite, abilityShake 0.3s ease-in-out infinite;
  box-shadow: 0 0 25px rgba(212,175,55,0.4), 0 0 60px rgba(212,175,55,0.15);
}

.ability-btn.active::before {
  content: '‚ö° TAP TO DEPLOY SUPERPOWER ‚ö°';
  position: absolute;
  top: -2.2rem;
  left: 50%;
  transform: translateX(-50%);
  font-family: 'Oswald', sans-serif;
  font-size: 0.65rem;
  font-weight: 700;
  letter-spacing: 0.3em;
  color: #000;
  background: var(--gold);
  padding: 0.2rem 1rem;
  border-radius: 4px;
  white-space: nowrap;
  animation: bounceCallout 0.8s ease infinite;
}

.ability-btn.active::after {
  content: '';
  position: absolute;
  inset: -6px;
  border: 2px dashed var(--gold);
  border-radius: 16px;
  animation: abilityRing 1.5s linear infinite;
  pointer-events: none;
}

.ability-btn:hover {
  background: linear-gradient(135deg, rgba(212,175,55,0.45), rgba(212,175,55,0.2));
  box-shadow: 0 0 40px rgba(212,175,55,0.6), inset 0 0 20px rgba(212,175,55,0.15);
  transform: scale(1.05);
}

@keyframes abilityPulse {
  0%, 100% { box-shadow: 0 0 15px rgba(212,175,55,0.3), 0 0 30px rgba(212,175,55,0.15); }
  50% { box-shadow: 0 0 30px rgba(212,175,55,0.6), 0 0 60px rgba(212,175,55,0.3), 0 0 90px rgba(212,175,55,0.1); }
}

@keyframes abilityBlink {
  0%, 100% { border-color: var(--gold); background: linear-gradient(135deg, rgba(212,175,55,0.25), rgba(212,175,55,0.08)); }
  50% { border-color: #fff; background: linear-gradient(135deg, rgba(212,175,55,0.4), rgba(212,175,55,0.18)); color: #fff; }
}

@keyframes abilityShake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-2px); }
  75% { transform: translateX(2px); }
}

@keyframes abilityRing {
  0% { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(1.15); }
}

@keyframes bounceCallout {
  0%, 100% { transform: translateX(-50%) translateY(0); }
  50% { transform: translateX(-50%) translateY(-5px); }
}

@keyframes spCallout {
  0%, 100% { border-color: var(--gold); box-shadow: 0 0 10px rgba(212,175,55,0.1); }
  50% { border-color: #fff; box-shadow: 0 0 25px rgba(212,175,55,0.3); }
}

@keyframes spHudPulse {
  0%, 100% { opacity: 0.7; }
  50% { opacity: 1; text-shadow: 0 0 8px rgba(212,175,55,0.4); }
}

/* ‚îÄ‚îÄ HAND (bottom of screen) ‚îÄ‚îÄ */
.hand-area {
  flex-shrink: 0;
  padding: 0.3rem 0 0.5rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.3rem;
  position: relative;
  z-index: 1;
}

.hand-label {
  font-family: 'Oswald', sans-serif;
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.2em;
  color: #444;
}

.hand {
  display: flex;
  justify-content: center;
  gap: clamp(0.3rem, 1vw, 0.5rem);
  min-height: 90px;
}

.hand-card {
  width: clamp(60px, 13vw, 80px);
  height: clamp(85px, 18vw, 110px);
  background: var(--dark-card);
  border: 2px solid #333;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 0.3rem;
  transition: all 0.25s;
  position: relative;
  overflow: hidden;
}

.hand-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
}

.hand-card.pos-gk::before { background: var(--gk); }
.hand-card.pos-def::before { background: var(--def); }
.hand-card.pos-mid::before { background: var(--mid); }
.hand-card.pos-str::before { background: var(--str); }

.hand-card:hover {
  transform: translateY(-6px);
  border-color: var(--gold);
  box-shadow: 0 4px 20px rgba(212,175,55,0.2);
  z-index: 2;
}

.hand-card.selected {
  transform: translateY(-12px);
  border-color: var(--gold);
  box-shadow: 0 4px 25px rgba(212,175,55,0.35);
  background: rgba(212,175,55,0.06);
}

.hand-card .hc-suit {
  font-size: clamp(0.8rem, 2vw, 1rem);
  line-height: 1;
}

.hand-card .hc-name {
  font-family: 'Oswald', sans-serif;
  font-size: clamp(0.42rem, 1vw, 0.52rem);
  font-weight: 600;
  text-transform: uppercase;
  text-align: center;
  line-height: 1.15;
  color: #ccc;
  margin-top: 0.15rem;
}

.hand-card .hc-rank {
  font-family: 'Oswald', sans-serif;
  font-size: clamp(0.6rem, 1.5vw, 0.75rem);
  font-weight: 700;
  color: var(--gold);
}

/* Ability dot on hand card */
.hand-card .hc-ability-dot {
  position: absolute;
  top: 4px;
  right: 4px;
  width: 6px;
  height: 6px;
  background: var(--gold);
  border-radius: 50%;
  animation: abilityGlow 2s ease infinite;
}

/* ‚îÄ‚îÄ COMMENTARY OVERLAY ‚îÄ‚îÄ */
.commentary-overlay {
  position: fixed;
  inset: 0;
  z-index: 150;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(5,5,10,0.92);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s;
}

.commentary-overlay.show {
  opacity: 1;
  pointer-events: auto;
}

.commentary-name {
  font-family: 'Oswald', sans-serif;
  font-size: clamp(2.5rem, 8vw, 5rem);
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.02em;
  line-height: 1;
  animation: slamIn 0.4s cubic-bezier(0.2, 0, 0.1, 1);
}

.commentary-nickname {
  font-family: 'Inter', sans-serif;
  font-size: clamp(0.9rem, 2.5vw, 1.3rem);
  color: #888;
  font-style: italic;
  margin-top: 0.4rem;
  animation: fadeUp 0.5s ease 0.15s both;
}

.commentary-ability-name {
  font-family: 'Oswald', sans-serif;
  font-size: clamp(0.8rem, 2vw, 1.1rem);
  color: var(--gold);
  text-transform: uppercase;
  letter-spacing: 0.15em;
  margin-top: 0.8rem;
  animation: fadeUp 0.5s ease 0.3s both;
}

@keyframes slamIn {
  0% { transform: scale(2.5); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}

@keyframes fadeUp {
  0% { transform: translateY(15px); opacity: 0; }
  100% { transform: translateY(0); opacity: 1; }
}

/* ‚îÄ‚îÄ RESULT BANNER ‚îÄ‚îÄ */
.result-banner {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  font-family: 'Oswald', sans-serif;
  font-size: clamp(1.6rem, 5vw, 3rem);
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 0.6rem 2rem;
  border-radius: 4px;
  opacity: 0;
  pointer-events: none;
  z-index: 160;
  transition: opacity 0.3s, transform 0.3s;
  white-space: nowrap;
}

.result-banner.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
.result-banner.win { color: var(--gold); background: rgba(10,10,15,0.95); border: 2px solid var(--gold); text-shadow: 0 0 20px rgba(212,175,55,0.4); }
.result-banner.lose { color: #e74c3c; background: rgba(10,10,15,0.95); border: 2px solid #e74c3c; }
.result-banner.draw { color: #aaa; background: rgba(10,10,15,0.95); border: 2px solid #555; }
.result-banner.war { color: var(--war-red); background: rgba(10,10,15,0.95); border: 2px solid var(--war-red); text-shadow: 0 0 20px rgba(255,34,68,0.5); font-size: clamp(2rem, 6vw, 4rem); }
.result-banner.ability { color: var(--gold); background: rgba(10,10,15,0.95); border: 2px solid var(--gold); }

/* ‚îÄ‚îÄ ABILITY POPUP ‚îÄ‚îÄ */
.ability-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 170;
  background: rgba(10,10,15,0.97);
  border: 2px solid var(--gold);
  border-radius: 8px;
  padding: 1.5rem 2.5rem;
  text-align: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
  max-width: 90vw;
}

.ability-popup.show { opacity: 1; pointer-events: auto; }

.ability-popup h3 {
  font-family: 'Oswald', sans-serif;
  font-size: 1.4rem;
  color: var(--gold);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 0.4rem;
}

.ability-popup p {
  font-size: 0.9rem;
  color: #aaa;
  margin-bottom: 1rem;
  line-height: 1.4;
}

.ability-popup .popup-btns {
  display: flex;
  justify-content: center;
  gap: 0.8rem;
}

.ability-popup .popup-btn {
  font-family: 'Oswald', sans-serif;
  font-size: 0.9rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 0.5rem 1.5rem;
  border: 1px solid;
  background: transparent;
  cursor: pointer;
  border-radius: 4px;
  transition: all 0.2s;
}

.popup-btn.confirm { border-color: var(--gold); color: var(--gold); }
.popup-btn.confirm:hover { background: var(--gold); color: var(--dark); }
.popup-btn.cancel { border-color: #555; color: #888; }
.popup-btn.cancel:hover { border-color: #888; color: #ccc; }

/* ‚îÄ‚îÄ BLUFF CALL UI ‚îÄ‚îÄ */
.bluff-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 180;
  background: rgba(10,10,15,0.97);
  border: 2px solid var(--war-red);
  border-radius: 8px;
  padding: 1.5rem 2.5rem;
  text-align: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}

.bluff-popup.show { opacity: 1; pointer-events: auto; }

.bluff-popup h3 {
  font-family: 'Oswald', sans-serif;
  font-size: 1.3rem;
  color: var(--war-red);
  text-transform: uppercase;
  margin-bottom: 0.4rem;
}

.bluff-popup p {
  font-size: 0.85rem;
  color: #aaa;
  margin-bottom: 1rem;
}

/* ‚îÄ‚îÄ SUPERPOWER TUTORIAL ‚îÄ‚îÄ */
.tutorial-overlay {
  position: fixed;
  inset: 0;
  z-index: 500;
  background: rgba(0,0,0,0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  animation: tutFadeIn 0.3s ease;
}

@keyframes tutFadeIn { from { opacity: 0; } to { opacity: 1; } }

.tutorial-box {
  background: linear-gradient(135deg, #0f0f18, #161625);
  border: 2px solid var(--gold);
  border-radius: 12px;
  padding: 2rem 2.5rem;
  max-width: 420px;
  text-align: center;
  position: relative;
  box-shadow: 0 0 60px rgba(212,175,55,0.15);
  animation: tutSlideUp 0.4s cubic-bezier(0.2,0,0.1,1);
}

@keyframes tutSlideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.tutorial-box .tut-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }

.tutorial-box h3 {
  font-family: 'Oswald', sans-serif;
  font-size: 1.6rem;
  color: var(--gold);
  text-transform: uppercase;
  letter-spacing: 0.12em;
  margin-bottom: 0.8rem;
}

.tutorial-box p {
  font-size: 0.92rem;
  color: #bbb;
  line-height: 1.6;
  margin-bottom: 0.6rem;
}

.tutorial-box .tut-highlight {
  color: var(--gold);
  font-weight: 600;
}

.tutorial-box .tut-example {
  background: rgba(212,175,55,0.08);
  border: 1px solid rgba(212,175,55,0.2);
  border-radius: 6px;
  padding: 0.7rem 1rem;
  margin: 1rem 0;
  font-size: 0.85rem;
  color: #ccc;
  line-height: 1.5;
}

.tutorial-box .tut-btn {
  font-family: 'Oswald', sans-serif;
  font-size: 1.1rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  padding: 0.7rem 2.5rem;
  border: 2px solid var(--gold);
  background: transparent;
  color: var(--gold);
  cursor: pointer;
  border-radius: 4px;
  transition: all 0.2s;
  margin-top: 0.5rem;
}

.tutorial-box .tut-btn:hover {
  background: var(--gold);
  color: var(--dark);
}

/* ‚îÄ‚îÄ VOLUME CONTROL ‚îÄ‚îÄ */
.volume-control {
  position: fixed;
  bottom: 12px;
  right: 12px;
  z-index: 200;
  display: flex;
  align-items: center;
  gap: 6px;
  opacity: 0.5;
  transition: opacity 0.2s;
}

.volume-control:hover { opacity: 1; }

.vol-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 1px solid #333;
  background: rgba(10,10,15,0.9);
  color: #888;
  font-size: 0.9rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.vol-btn:hover { border-color: var(--gold); color: var(--gold); }
.vol-btn.muted { color: #555; }

/* ‚îÄ‚îÄ SCREEN SHAKE ‚îÄ‚îÄ */
@keyframes shake {
  0%, 100% { transform: translate(0, 0); }
  10% { transform: translate(-4px, 2px); }
  20% { transform: translate(4px, -2px); }
  30% { transform: translate(-3px, 3px); }
  40% { transform: translate(3px, -1px); }
  50% { transform: translate(-2px, 1px); }
  60% { transform: translate(2px, -2px); }
  70% { transform: translate(-1px, 2px); }
  80% { transform: translate(1px, -1px); }
  90% { transform: translate(-1px, 1px); }
}

body.shake { animation: shake 0.5s ease; }

/* ‚îÄ‚îÄ FLASH EFFECTS ‚îÄ‚îÄ */
.screen-flash {
  position: fixed;
  inset: 0;
  z-index: 140;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.1s;
}

.screen-flash.gold { background: rgba(212,175,55,0.15); }
.screen-flash.red { background: rgba(255,34,68,0.15); }
.screen-flash.white { background: rgba(255,255,255,0.1); }
.screen-flash.show { opacity: 1; }

/* ‚îÄ‚îÄ GAME OVER ‚îÄ‚îÄ */
#game-over {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(5,5,10,0.97);
  z-index: 200;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 2rem;
}

#game-over h2 {
  font-family: 'Oswald', sans-serif;
  font-size: clamp(2.5rem, 7vw, 4.5rem);
  font-weight: 700;
  text-transform: uppercase;
  margin-bottom: 0.5rem;
}

#game-over .go-sub { font-size: 1rem; color: #888; margin-bottom: 2rem; }

#game-over.victory h2 {
  background: linear-gradient(135deg, var(--gold-light), var(--gold));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

#game-over.defeat h2 { color: #e74c3c; }

#game-over .go-stats {
  display: flex;
  gap: 1.5rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
  justify-content: center;
}

#game-over .go-stat {
  text-align: center;
}

#game-over .go-stat-val {
  font-family: 'Oswald', sans-serif;
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--gold);
}

#game-over .go-stat-label {
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: #666;
}

#game-over .go-score {
  font-family: 'Oswald', sans-serif;
  font-size: 1.2rem;
  color: var(--gold);
  margin-bottom: 0.3rem;
}

.name-input-row {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  align-items: center;
  justify-content: center;
}

.name-input-row input {
  font-family: 'Oswald', sans-serif;
  font-size: 1rem;
  padding: 0.5rem 1rem;
  background: rgba(255,255,255,0.05);
  border: 1px solid #333;
  color: #fff;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  width: 180px;
  outline: none;
}

.name-input-row input:focus { border-color: var(--gold); }

.name-input-row button {
  font-family: 'Oswald', sans-serif;
  font-size: 0.85rem;
  padding: 0.5rem 1rem;
  background: var(--gold);
  color: var(--dark);
  border: none;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  font-weight: 600;
}

/* ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ */
#leaderboard-screen {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(5,5,10,0.98);
  z-index: 300;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 3rem 2rem;
  overflow-y: auto;
}

#leaderboard-screen h2 {
  font-family: 'Oswald', sans-serif;
  font-size: clamp(1.8rem, 5vw, 3rem);
  font-weight: 700;
  text-transform: uppercase;
  background: linear-gradient(135deg, var(--gold-light), var(--gold));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 0.3rem;
}

.lb-subtitle {
  font-size: 0.75rem;
  color: #555;
  text-transform: uppercase;
  letter-spacing: 0.3em;
  margin-bottom: 2rem;
}

.lb-table {
  width: 100%;
  max-width: 500px;
  border-collapse: collapse;
}

.lb-table th {
  font-family: 'Oswald', sans-serif;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: #555;
  padding: 0.4rem 0.6rem;
  text-align: left;
  border-bottom: 1px solid #222;
}

.lb-table th:last-child,
.lb-table td:last-child { text-align: right; }

.lb-table td {
  font-family: 'Inter', sans-serif;
  font-size: 0.85rem;
  padding: 0.6rem;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  color: #aaa;
}

.lb-table tr.lb-gold td { color: var(--gold); font-weight: 600; }
.lb-table tr.lb-silver td { color: #c0c0c0; }
.lb-table tr.lb-bronze td { color: #cd7f32; }
.lb-table tr.lb-highlight td { background: rgba(212,175,55,0.08); }

.lb-rank {
  font-family: 'Oswald', sans-serif;
  font-weight: 700;
  font-size: 1rem;
  width: 2rem;
}

.lb-name { font-weight: 500; }

.lb-score {
  font-family: 'Oswald', sans-serif;
  font-weight: 700;
  font-size: 1.1rem;
  color: var(--gold) !important;
}

.lb-empty {
  text-align: center;
  color: #444;
  padding: 2rem;
  font-style: italic;
}

.lb-buttons {
  display: flex;
  gap: 1rem;
  margin-top: 2rem;
}

.btn-lb {
  font-family: 'Oswald', sans-serif;
  font-size: 1rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  padding: 0.7rem 2rem;
  border: 2px solid var(--gold);
  background: transparent;
  color: var(--gold);
  cursor: pointer;
  transition: all 0.3s;
}

.btn-lb:hover { background: var(--gold); color: var(--dark); }

.btn-lb.danger {
  border-color: #e74c3c;
  color: #e74c3c;
  font-size: 0.75rem;
}

.btn-lb.danger:hover { background: #e74c3c; color: #fff; }

.btn-play-again {
  font-family: 'Oswald', sans-serif;
  font-size: 1.2rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  padding: 0.8rem 3rem;
  border: 2px solid var(--gold);
  background: transparent;
  color: var(--gold);
  cursor: pointer;
  transition: all 0.3s;
}

.btn-play-again:hover { background: var(--gold); color: var(--dark); }

/* ‚îÄ‚îÄ DRAFT CARDS ‚îÄ‚îÄ */
.draft-card {
  width: clamp(140px, 22vw, 180px);
  height: clamp(190px, 30vw, 240px);
  background: var(--dark-card);
  border: 3px solid #333;
  border-radius: 10px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 0.8rem 0.5rem;
  transition: all 0.3s;
  position: relative;
  gap: 0.3rem;
}
.draft-card:hover { border-color: var(--gold); transform: translateY(-8px) scale(1.03); box-shadow: 0 6px 30px rgba(212,175,55,0.3); }
.draft-card.picked { opacity: 0.3; pointer-events: none; border-color: #222; transform: scale(0.9); }
.draft-card.cpu-picked { opacity: 0.3; pointer-events: none; border-color: #e74c3c; transform: scale(0.9); }
.draft-card .dc-name { font-family: 'Oswald',sans-serif; font-size: 0.95rem; text-transform: uppercase; text-align: center; color: #ccc; margin-top: 0.2rem; }
.draft-card .dc-rank { font-family: 'Oswald',sans-serif; font-size: 1.1rem; font-weight: 700; color: var(--gold); }
.draft-card .dc-suit { font-size: 1.3rem; }
.draft-card .dc-pos { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; font-weight: 600; }
.draft-card.pos-gk .dc-pos { color: var(--gk); }
.draft-card.pos-def .dc-pos { color: var(--def); }
.draft-card.pos-mid .dc-pos { color: var(--mid); }
.draft-card.pos-str .dc-pos { color: var(--str); }

.squad-mini {
  width: 50px; height: 60px; background: var(--dark-card); border: 1px solid #333;
  border-radius: 4px; display: flex; align-items: center; justify-content: center;
  font-size: 0.6rem; font-family: 'Oswald',sans-serif; color: #888; text-transform: uppercase;
}
.squad-mini.filled { border-color: var(--gold); color: var(--gold); font-size: 0.55rem; }
.squad-mini.cpu-filled { border-color: #e74c3c; color: #e74c3c; }

/* ‚îÄ‚îÄ GOLDEN CARD GLOW ‚îÄ‚îÄ */
.card-front.golden-card { border-color: #ffd700 !important; box-shadow: 0 0 25px rgba(255,215,0,0.4), inset 0 0 15px rgba(255,215,0,0.08); }
.card-front.golden-card::after {
  content: 'üëë GOLDEN CARD ‚Äî WORTH DOUBLE';
  position: absolute; bottom: 3px; left: 0; right: 0; text-align: center;
  font-family: 'Oswald',sans-serif; font-size: 0.45rem; text-transform: uppercase;
  letter-spacing: 0.15em; color: #ffd700; animation: goldenPulse 2s ease infinite;
}
@keyframes goldenPulse { 0%,100%{opacity:0.7} 50%{opacity:1} }
.hand-card.golden-hand { border-color: #ffd700; box-shadow: 0 0 12px rgba(255,215,0,0.3); }

/* ‚îÄ‚îÄ MOMENTUM INDICATOR ‚îÄ‚îÄ */
.momentum-bar {
  display: flex; align-items: center; justify-content: center; gap: 0.3rem;
  font-family: 'Oswald',sans-serif; font-size: 0.65rem; text-transform: uppercase;
  letter-spacing: 0.15em; color: #555; min-height: 1.2em; flex-shrink: 0;
}
.momentum-bar .streak-fire { color: var(--gold); animation: comebackPulse 1s ease infinite; }
.momentum-bar .bonus-text { color: var(--gold); font-weight: 700; }
.momentum-bar .energy-display { font-size: 0.7rem; letter-spacing: 0.05em; }

/* ‚îÄ‚îÄ STREAK GLOW (player card pulses gold when on a streak) ‚îÄ‚îÄ */
.streak-glow .card-front { box-shadow: 0 0 20px rgba(212,175,55,0.4), inset 0 0 10px rgba(212,175,55,0.1); }
@keyframes streakPulse { 0%,100%{box-shadow: 0 0 15px rgba(212,175,55,0.3)} 50%{box-shadow: 0 0 30px rgba(212,175,55,0.6)} }
.streak-glow { animation: streakPulse 1.5s ease infinite; }

/* ‚îÄ‚îÄ DYNAMIC COMMENTARY ‚îÄ‚îÄ */
.dyn-commentary {
  position: fixed; top: 8px; left: 50%; transform: translateX(-50%);
  font-family: 'Oswald',sans-serif; font-size: clamp(0.6rem,1.5vw,0.75rem);
  text-transform: uppercase; letter-spacing: 0.15em; color: #888;
  background: rgba(10,10,15,0.85); padding: 0.3rem 1rem; border-radius: 3px;
  border: 1px solid #222; z-index: 100; opacity: 0; transition: opacity 0.3s;
  white-space: nowrap; pointer-events: none;
}
.dyn-commentary.show { opacity: 1; }

/* ‚îÄ‚îÄ TRADE MINI CARDS ‚îÄ‚îÄ */
.trade-card {
  width: 60px; height: 80px; background: var(--dark-card); border: 2px solid #333;
  border-radius: 5px; cursor: pointer; display: flex; flex-direction: column;
  align-items: center; justify-content: center; padding: 0.2rem; transition: all 0.2s;
  font-family: 'Oswald',sans-serif; font-size: 0.45rem; text-transform: uppercase; color: #aaa;
}
.trade-card:hover { border-color: var(--gold); transform: translateY(-4px); }
.trade-card.selected { border-color: var(--gold); box-shadow: 0 0 15px rgba(212,175,55,0.3); background: rgba(212,175,55,0.05); }

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media (max-width: 600px) {
  .scoreboard { gap: 1rem; }
  .battlefield { gap: 0.5rem; }
  .hand { gap: 0.2rem; }
}
</style>
</head>
<body>

<!-- CINEMATIC INTRO (plays once per session) -->
<div id="intro-screen" style="display:none; position:fixed; inset:0; z-index:600; background:#000; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; overflow:hidden">
  <div id="intro-loading" style="position:absolute; bottom:2rem; font-family:sans-serif; font-size:0.7rem; letter-spacing:0.3em; color:rgba(255,255,255,0.2); text-transform:uppercase; z-index:10">tap to skip</div>
  <canvas id="intro-particles" style="position:absolute;inset:0;z-index:0"></canvas>
  <!-- Phase 1: edenic labs + ACFC presents -->
  <div id="intro-studio" style="opacity:0; text-align:center; z-index:2; transform:translateY(20px)">
    <div id="edenic-logo" style="font-family:'Poppins',sans-serif; font-size:clamp(1.2rem,4vw,1.8rem); font-weight:600; color:#12cc72; letter-spacing:0.05em; margin-bottom:1rem; opacity:0; filter:drop-shadow(0 0 20px rgba(18,204,114,0.5))">powered by edenic labs</div>
    <div style="font-family:'Oswald',sans-serif; font-size:clamp(1.5rem,4.5vw,2.4rem); font-weight:700; text-transform:uppercase; letter-spacing:0.15em; color:var(--gold); margin-top:0.8rem; opacity:0; transform:scale(0.9)" id="intro-acfc">ACFC Presents</div>
  </div>
  <!-- Phase 2: Stadium canvas (drawn procedurally) -->
  <canvas id="intro-stadium" style="position:absolute;inset:0;z-index:1;opacity:0"></canvas>
  <!-- Phase 3: Logo + title -->
  <div id="intro-title-wrap" style="position:absolute;z-index:4;text-align:center;opacity:0;transform:scale(0.3)">
    <img id="intro-logo" src="gaffer26-logo.png" alt="GAFFER26" style="max-width:min(400px,80vw); filter:drop-shadow(0 0 50px rgba(212,175,55,0.6))">
    <div style="font-family:'Oswald',sans-serif;font-size:clamp(2.5rem,8vw,5rem);font-weight:700;text-transform:uppercase;letter-spacing:0.06em;background:linear-gradient(135deg,#fff,var(--gold-light),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-top:0.5rem;filter:drop-shadow(0 2px 15px rgba(212,175,55,0.5))" id="intro-title-text">GAFFER<span style="font-size:0.55em;vertical-align:super">26</span></div>
    <div style="font-family:'Oswald',sans-serif;font-size:clamp(0.7rem,2vw,1rem);text-transform:uppercase;letter-spacing:0.35em;color:#888;margin-top:0.3rem;opacity:0" id="intro-tagline">52 Premier League Legends</div>
  </div>
  <video id="intro-video" src="gaffer26-logo-animation.mp4" muted playsinline style="max-width:100vw; max-height:100vh; object-fit:contain; opacity:0; position:absolute; display:none; z-index:5"></video>
</div>

<!-- DRAFT SCREEN -->
<div id="draft-screen" style="display:none; position:fixed; inset:0; z-index:400; background:rgba(5,5,10,0.98); flex-direction:column; align-items:center; justify-content:center; padding:1.5rem; overflow-y:auto">
  <h2 style="font-family:'Oswald',sans-serif; font-size:clamp(1.5rem,4vw,2.5rem); text-transform:uppercase; background:linear-gradient(135deg,var(--gold-light),var(--gold)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; margin-bottom:0.3rem">Pick Your Squad</h2>
  <div style="font-size:0.75rem; color:#666; text-transform:uppercase; letter-spacing:0.2em; margin-bottom:1rem" id="draft-info">Pick 5 cards ‚Äî alternating with CPU</div>
  <div id="draft-round-label" style="font-family:'Oswald',sans-serif; font-size:1rem; color:var(--gold); text-transform:uppercase; letter-spacing:0.15em; margin-bottom:0.5rem"></div>
  <div id="draft-pool" style="display:flex; flex-wrap:wrap; justify-content:center; gap:1rem; max-width:850px; margin-bottom:1rem"></div>
  <div style="display:flex; gap:2rem; margin-top:1rem">
    <div style="text-align:center">
      <div style="font-family:'Oswald',sans-serif; font-size:0.65rem; text-transform:uppercase; letter-spacing:0.2em; color:#555; margin-bottom:0.4rem">Your Squad</div>
      <div id="draft-player-squad" style="display:flex; flex-wrap:wrap; gap:0.5rem; min-height:50px"></div>
    </div>
    <div style="text-align:center">
      <div style="font-family:'Oswald',sans-serif; font-size:0.65rem; text-transform:uppercase; letter-spacing:0.2em; color:#555; margin-bottom:0.4rem">CPU Squad</div>
      <div id="draft-cpu-squad" style="display:flex; flex-wrap:wrap; gap:0.5rem; min-height:50px"></div>
    </div>
  </div>
</div>

<!-- HALF-TIME SCREEN -->
<div id="halftime-screen" style="display:none; position:fixed; inset:0; z-index:350; background:rgba(5,5,10,0.97); flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:2rem">
  <div style="font-family:'Oswald',sans-serif; font-size:clamp(0.6rem,1.5vw,0.8rem); text-transform:uppercase; letter-spacing:0.4em; color:#555; margin-bottom:0.5rem">‚è±Ô∏è Half-Time</div>
  <h2 style="font-family:'Oswald',sans-serif; font-size:clamp(2rem,6vw,3.5rem); font-weight:700; text-transform:uppercase; background:linear-gradient(135deg,var(--gold-light),var(--gold)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; margin-bottom:1rem" id="ht-title">HALF TIME</h2>
  <div id="ht-stats" style="display:flex; gap:1.5rem; flex-wrap:wrap; justify-content:center; margin-bottom:1.5rem"></div>
  <div id="ht-twist" style="font-family:'Oswald',sans-serif; font-size:1rem; color:var(--gold); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:1.5rem; max-width:500px"></div>
  <button class="btn-deal" onclick="resumeFromHalfTime()" style="font-size:1rem; padding:0.6rem 2.5rem">Second Half ‚Üí</button>
</div>

<!-- TRADE SCREEN (post-round card swap) -->
<div id="trade-screen" style="display:none; position:fixed; inset:0; z-index:350; background:rgba(5,5,10,0.97); flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:2rem">
  <h3 style="font-family:'Oswald',sans-serif; font-size:1.3rem; color:var(--gold); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:0.5rem">üîÑ Trade Window</h3>
  <p style="font-size:0.85rem; color:#888; margin-bottom:1rem">Swap one card from your hand with one from your won pile</p>
  <div style="display:flex; gap:2rem; flex-wrap:wrap; justify-content:center">
    <div style="text-align:center">
      <div style="font-size:0.65rem; text-transform:uppercase; letter-spacing:0.2em; color:#555; margin-bottom:0.4rem">Your Hand</div>
      <div id="trade-hand" style="display:flex; gap:0.4rem; flex-wrap:wrap; justify-content:center"></div>
    </div>
    <div style="text-align:center">
      <div style="font-size:0.65rem; text-transform:uppercase; letter-spacing:0.2em; color:#555; margin-bottom:0.4rem">Won Pile</div>
      <div id="trade-won" style="display:flex; gap:0.4rem; flex-wrap:wrap; justify-content:center"></div>
    </div>
  </div>
  <div style="display:flex; gap:1rem; margin-top:1.5rem">
    <button class="btn-deal" onclick="executeTrade()" id="trade-confirm-btn" style="font-size:0.85rem; padding:0.5rem 1.5rem; opacity:0.4" disabled>Swap</button>
    <button class="btn-deal" onclick="skipTrade()" style="font-size:0.85rem; padding:0.5rem 1.5rem; border-color:#555; color:#888">Skip</button>
  </div>
</div>

<!-- TITLE SCREEN -->
<div id="title-screen" style="display:none" onclick="ensureMusic()">
  <img src="gaffer26-logo.png" alt="GAFFER26" style="max-width:min(320px,70vw); margin-bottom:0.5rem; filter:drop-shadow(0 0 30px rgba(212,175,55,0.3))">
  <h1>GAFFER<span style="font-size:0.6em; vertical-align:super">26</span></h1>
  <div class="subtitle">52 Premier League Legends</div>
  <div class="tagline">Draft your legends. Deploy superpowers. Become the gaffer.</div>
  <div style="margin-top:1.2rem; background:rgba(212,175,55,0.08); border:2px solid rgba(212,175,55,0.25); border-radius:12px; padding:1.2rem 1.5rem; max-width:420px; text-align:left">
    <div style="font-family:'Oswald',sans-serif; font-size:0.85rem; text-transform:uppercase; letter-spacing:0.2em; color:var(--gold); margin-bottom:0.7rem; text-align:center">‚ö° How to Play ‚ö°</div>
    <div style="font-size:0.85rem; color:#bbb; line-height:1.8">
      <div style="margin-bottom:0.5rem; display:flex; gap:0.5rem; align-items:flex-start"><span style="color:var(--gold); font-weight:700; font-size:1.1rem; min-width:1.5rem">1.</span><span>Draft your squad ‚Äî pick 5 legends from the pool</span></div>
      <div style="margin-bottom:0.5rem; display:flex; gap:0.5rem; align-items:flex-start"><span style="color:var(--gold); font-weight:700; font-size:1.1rem; min-width:1.5rem">2.</span><span>Play a card, then choose your strongest stat</span></div>
      <div style="margin-bottom:0.5rem; display:flex; gap:0.5rem; align-items:flex-start"><span style="color:var(--gold); font-weight:700; font-size:1.1rem; min-width:1.5rem">3.</span><span>Win the round ‚Äî highest stat wins the cards!</span></div>
    </div>
    <div style="margin-top:0.8rem; background:rgba(212,175,55,0.12); border:2px solid var(--gold); border-radius:8px; padding:0.8rem 1rem; text-align:center; animation:spCallout 1.5s ease infinite">
      <div style="font-family:'Oswald',sans-serif; font-size:1rem; font-weight:700; color:var(--gold); text-transform:uppercase; letter-spacing:0.15em; margin-bottom:0.3rem">‚ö° SUPERPOWER ‚ö°</div>
      <div style="font-size:0.8rem; color:#ddd; line-height:1.5">Every card has a <strong style="color:var(--gold)">unique superpower</strong> ‚Äî a game-changing ability!<br>When the <strong style="color:#fff">big glowing button</strong> appears, <strong style="color:var(--gold)">TAP IT</strong> to unleash chaos.</div>
      <div style="font-size:0.75rem; color:#e74c3c; font-weight:600; margin-top:0.4rem">‚ö†Ô∏è Only 3 per game ‚Äî choose your moment!</div>
    </div>
  </div>
  <div id="name-entry" style="margin-top:1.2rem; display:flex; flex-direction:column; align-items:center; gap:0.6rem">
    <label style="font-family:'Oswald',sans-serif; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.2em; color:#666">Enter Your Name</label>
    <input type="text" id="player-name-input" placeholder="THE GAFFER" maxlength="15" style="font-family:'Oswald',sans-serif; font-size:1.2rem; padding:0.6rem 1.5rem; background:rgba(255,255,255,0.05); border:2px solid #333; color:var(--gold); text-transform:uppercase; letter-spacing:0.1em; text-align:center; width:220px; outline:none; border-radius:4px; transition:border-color 0.3s" onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='#333'">
  </div>
  <div style="display:flex; gap:1rem; flex-wrap:wrap; justify-content:center; margin-top:1.5rem">
    <button class="btn-deal" onclick="startGameWithName('cpu')">Full Match</button>
    <button class="btn-deal" onclick="startGameWithName('quick')" style="border-color:#f39c12; color:#f39c12">Quick Play</button>
    <button class="btn-deal" onclick="startGameWithName('draft')" style="border-color:#2ecc71; color:#2ecc71">Draft Mode</button>
  </div>
  <div style="display:flex; gap:1rem; flex-wrap:wrap; justify-content:center; margin-top:0.8rem">
    <button class="btn-deal" style="font-size:0.85rem; padding:0.5rem 1.8rem; opacity:0.6" onclick="showPvPSetup()">vs Player</button>
    <button class="btn-deal" style="font-size:0.85rem; padding:0.5rem 1.8rem; opacity:0.6" onclick="showLeaderboard()">Leaderboard</button>
  </div>
  <!-- powered by edenic labs shown in intro only -->
</div>

<!-- PvP SETUP SCREEN -->
<div id="pvp-screen" style="display:none; position:fixed; inset:0; z-index:250; background:rgba(5,5,10,0.98); flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:2rem">
  <h2 style="font-family:'Oswald',sans-serif; font-size:clamp(1.5rem,4vw,2.5rem); text-transform:uppercase; background:linear-gradient(135deg,var(--gold-light),var(--gold)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; margin-bottom:1.5rem">Multiplayer</h2>
  <div style="display:flex; gap:1.5rem; flex-wrap:wrap; justify-content:center">
    <div style="background:rgba(255,255,255,0.03); border:2px solid #333; border-radius:8px; padding:1.5rem 2rem; cursor:pointer; transition:all 0.3s; min-width:200px" onclick="createRoom()" onmouseover="this.style.borderColor='var(--gold)'" onmouseout="this.style.borderColor='#333'">
      <div style="font-size:2rem; margin-bottom:0.5rem">üèüÔ∏è</div>
      <div style="font-family:'Oswald',sans-serif; font-size:1.1rem; text-transform:uppercase; color:var(--gold); letter-spacing:0.1em">Create Room</div>
      <div style="font-size:0.75rem; color:#666; margin-top:0.3rem">Get a code to share</div>
    </div>
    <div style="background:rgba(255,255,255,0.03); border:2px solid #333; border-radius:8px; padding:1.5rem 2rem; min-width:200px">
      <div style="font-size:2rem; margin-bottom:0.5rem">üé´</div>
      <div style="font-family:'Oswald',sans-serif; font-size:1.1rem; text-transform:uppercase; color:var(--gold); letter-spacing:0.1em; margin-bottom:0.5rem">Join Room</div>
      <input type="text" id="room-code-input" placeholder="ENTER CODE" maxlength="5" style="font-family:'Oswald',sans-serif; font-size:1.1rem; padding:0.5rem; background:rgba(255,255,255,0.05); border:1px solid #444; color:#fff; text-transform:uppercase; letter-spacing:0.2em; text-align:center; width:140px; outline:none; border-radius:4px">
      <button onclick="joinRoom()" style="font-family:'Oswald',sans-serif; font-size:0.85rem; padding:0.5rem 1.2rem; border:1px solid var(--gold); background:transparent; color:var(--gold); cursor:pointer; text-transform:uppercase; letter-spacing:0.1em; margin-top:0.5rem; display:block; margin-left:auto; margin-right:auto; border-radius:4px">Join</button>
    </div>
  </div>
  <div id="pvp-status" style="font-family:'Oswald',sans-serif; font-size:0.85rem; color:#888; text-transform:uppercase; letter-spacing:0.15em; margin-top:1.5rem; min-height:2em"></div>
  <button class="btn-deal" style="font-size:0.85rem; padding:0.5rem 1.8rem; margin-top:1rem; opacity:0.6" onclick="hidePvPSetup()">Back</button>
</div>

<!-- LEADERBOARD SCREEN -->
<div id="leaderboard-screen">
  <h2>Leaderboard</h2>
  <div class="lb-subtitle">GAFFER26 ‚Äî Hall of Legends</div>
  <table class="lb-table">
    <thead><tr><th>#</th><th>Name</th><th>W/L</th><th>Streak</th><th>Score</th></tr></thead>
    <tbody id="lb-body"></tbody>
  </table>
  <div class="lb-buttons">
    <button class="btn-lb" onclick="hideLeaderboard()">Back</button>
    <button class="btn-lb danger" onclick="clearLeaderboard()">Clear All</button>
  </div>
</div>

<!-- GAME SCREEN -->
<div id="game-screen">
  <div class="scoreboard">
    <div class="score-side">
      <span id="p1-name-display">You</span>
      <span class="count" id="player-count">26</span>
    </div>
    <div class="score-divider">‚Äî</div>
    <div class="score-side">
      <span class="count" id="cpu-count">26</span>
      <span id="p2-name-display">CPU</span>
    </div>
  </div>

  <div class="turn-indicator" id="turn-indicator"></div>
  <div id="superpower-hud" style="font-family:'Oswald',sans-serif; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.15em; color:var(--gold); padding:0.3rem 0.8rem; margin-top:0.2rem; display:flex; align-items:center; justify-content:center; gap:0.4rem; animation:spHudPulse 2s ease infinite">
    <span style="font-size:1.1em">‚ö°</span>
    <span id="superpower-count">3</span>/<span id="superpower-max">3</span> SUPERPOWERS
    <span style="font-size:1.1em">‚ö°</span>
  </div>
  <div class="momentum-bar" id="momentum-bar"></div>
  <div class="war-pile" id="war-pile"></div>
  <div class="comeback-indicator" id="comeback-indicator"></div>
  <div class="dyn-commentary" id="dyn-commentary"></div>

  <div class="play-area">
    <div class="battlefield">
      <div class="card-column">
        <div class="card-label">Your Card</div>
        <div class="card-wrapper">
          <div class="card" id="player-card">
            <div class="card-face card-back">
              <div class="card-back-logo">GAFFER26</div>
              <div class="card-back-sub">ACFC</div>
            </div>
            <div class="card-face card-front" id="player-card-front"></div>
          </div>
        </div>
      </div>

      <div class="card-column">
        <div class="card-label" id="opponent-label">CPU Card</div>
        <div class="card-wrapper">
          <div class="card" id="cpu-card">
            <div class="card-face card-back">
              <div class="card-back-logo">GAFFER26</div>
              <div class="card-back-sub">ACFC</div>
            </div>
            <div class="card-face card-front" id="cpu-card-front"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="stat-buttons" id="stat-buttons">
      <button class="stat-btn" onclick="pickStat('pace')">üèÉ Pace</button>
      <button class="stat-btn" onclick="pickStat('shooting')">‚öΩ Shooting</button>
      <button class="stat-btn" onclick="pickStat('passing')">üéØ Passing</button>
      <button class="stat-btn" onclick="pickStat('defending')">üõ°Ô∏è Defending</button>
    </div>

    <button class="ability-btn" id="ability-btn" onclick="activateAbility()"></button>
  </div>

  <div class="hand-area">
    <div class="hand-label">Your Hand</div>
    <div class="hand" id="player-hand"></div>
  </div>
</div>

<!-- OVERLAYS -->
<div class="result-banner" id="result-banner"></div>
<div class="commentary-overlay" id="commentary-overlay">
  <div class="commentary-name" id="commentary-name"></div>
  <div class="commentary-nickname" id="commentary-nickname"></div>
  <div class="commentary-ability-name" id="commentary-ability-name"></div>
</div>
<div class="ability-popup" id="ability-popup">
  <h3 id="ap-title"></h3>
  <p id="ap-desc"></p>
  <div class="popup-btns" id="ap-btns"></div>
</div>
<div class="bluff-popup" id="bluff-popup">
  <h3>The Con!</h3>
  <p id="bluff-desc"></p>
  <div class="popup-btns" id="bluff-btns"></div>
</div>
<div class="screen-flash" id="screen-flash"></div>

<!-- EXIT / HOME BUTTON -->
<button class="exit-btn" id="exit-btn" onclick="goHome()">Exit</button>

<!-- VOLUME CONTROL -->
<div class="volume-control" id="volume-control" style="display:none">
  <button class="vol-btn" id="vol-btn" onclick="toggleMusic()" title="Toggle music">üîä</button>
</div>

<!-- GAME OVER -->
<div id="game-over">
  <h2 id="go-title"></h2>
  <div class="go-sub" id="go-sub"></div>
  <div class="go-stats" id="go-stats"></div>
  <div class="go-score" id="go-score"></div>
  <div class="name-input-row" id="go-name-row" style="display:none">
    <input type="text" id="go-name-input" placeholder="Your name" maxlength="15">
    <button onclick="submitScore()">Save</button>
  </div>
  <div id="go-saved-msg" style="display:none; color:var(--gold); font-size:0.85rem; margin-bottom:1rem;"></div>
  <div style="display:flex; gap:1rem; flex-wrap:wrap; justify-content:center">
    <button class="btn-play-again" onclick="startGame()">Play Again</button>
    <button class="btn-play-again" style="font-size:1rem; padding:0.6rem 2rem" onclick="showLeaderboard()">Leaderboard</button>
    <button class="btn-play-again" style="font-size:1rem; padding:0.6rem 2rem; border-color:#555; color:#888" onclick="goHome()">Home</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CINEMATIC INTRO + SESSION SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ABILITY_CAP = 3; // Max superpowers per game
let playerName = localStorage.getItem('gaffer26-name') || '';
let gameMode = 'cpu'; // 'cpu' or 'pvp'
let peer = null; // PeerJS instance
let peerConn = null; // active connection
let isHost = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MUSIC SYSTEM ‚Äî variables declared early so autoplay code can access them
// (The full music engine functions are defined later in the file)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let musicPlaying = false;
let musicMuted = false;
let currentTrack = null;
let currentAudio = null;
let fadingOutAudio = null;
let musicVolume = 0.7;
let autoAdvanceTimer = null;

const MUSIC_TRACKS = {
  intro:    'music/1960s-house.mp3',
  menu:     'music/dominoes.mp3',
  gameplay: 'music/first-d.mp3',
  intense:  'music/here-we-leave.mp3',
  halftime: 'music/leaning.mp3',
  victory:  'music/GB3AD1300096.mp3',
  defeat:   'music/GB3AD1300063.mp3',
  draw:     'music/GB3AD1300064.mp3',
};

const ALL_GAMEPLAY_TRACKS = [
  'music/first-d.mp3',
  'music/here-we-leave.mp3',
  'music/1960s-house.mp3',
  'music/dominoes.mp3',
  'music/leaning.mp3',
];

let gameplayTrackIndex = 0;
let shuffledGameplayTracks = [];

const audioCache = {};

// ‚îÄ‚îÄ Start music on first user interaction (reliable across all browsers) ‚îÄ‚îÄ
let musicStarted = false;
let musicConfirmed = false; // true only after audio is actually playing audibly

function ensureMusic() {
  if (musicConfirmed) return;
  musicStarted = true;
  const introUrl = MUSIC_TRACKS.intro;
  let audio = audioCache[introUrl];
  if (!audio) {
    audio = new Audio(introUrl);
    audio.preload = 'auto';
    audioCache[introUrl] = audio;
  }
  audio.loop = true;
  audio.currentTime = 0;
  audio.volume = 0;
  const p = audio.play();
  if (p && p.then) {
    p.then(() => {
      musicConfirmed = true;
      currentAudio = audio;
      currentTrack = introUrl;
      musicPlaying = true;
      musicVolume = 0.6;
      fadeAudio(audio, 0, 0.6, 0.8);
      document.getElementById('volume-control').style.display = 'flex';
      removeInteractionListeners();
      setTimeout(preloadTracks, 500);
    }).catch(() => {
      musicStarted = false;
    });
  }
}

// Start music on ANY first user interaction (click, tap, key)
function startMusicOnInteraction() {
  if (musicConfirmed) return;
  ensureMusic();
}

function removeInteractionListeners() {
  document.removeEventListener('click', startMusicOnInteraction);
  document.removeEventListener('touchstart', startMusicOnInteraction);
  document.removeEventListener('keydown', startMusicOnInteraction);
  document.removeEventListener('pointerdown', startMusicOnInteraction);
}

// Listen on interaction types that count as user gestures
document.addEventListener('click', startMusicOnInteraction);
document.addEventListener('touchstart', startMusicOnInteraction);
document.addEventListener('keydown', startMusicOnInteraction);
document.addEventListener('pointerdown', startMusicOnInteraction);

// FAILSAFE: if nothing is visible after 3s, force title screen
setTimeout(function() {
  const ts = document.getElementById('title-screen');
  const intro = document.getElementById('intro-screen');
  const game = document.getElementById('game-screen');
  const draft = document.getElementById('draft-screen');
  const anyVisible = [ts,intro,game,draft].some(el => el && el.style.display !== 'none');
  if (!anyVisible && ts) {
    ts.style.display = 'flex';
    ensureMusic();
  }
}, 3000);

// Run cinematic intro on first visit per session
(function runIntro() {
  if (sessionStorage.getItem('gaffer26-intro-seen')) {
    document.getElementById('title-screen').style.display = 'flex';
    document.getElementById('volume-control').style.display = 'flex';
    const ni = document.getElementById('player-name-input');
    if (playerName) ni.value = playerName;
    ensureMusic();
    return;
  }
  const intro = document.getElementById('intro-screen');
  intro.style.display = 'flex';

  // ‚îÄ‚îÄ Particle system (golden sparks) ‚îÄ‚îÄ
  const canvas = document.getElementById('intro-particles');
  const ctx2d = canvas.getContext('2d');
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  const particles = [];
  for (let i = 0; i < 80; i++) {
    particles.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, vx: (Math.random()-0.5)*0.5, vy: -Math.random()*1.5-0.3, r: Math.random()*2+1, a: Math.random(), life: Math.random() });
  }
  let particleAnim = true;
  function drawParticles() {
    if (!particleAnim) return;
    ctx2d.clearRect(0,0,canvas.width,canvas.height);
    particles.forEach(p => {
      p.x += p.vx; p.y += p.vy; p.life -= 0.003;
      if (p.life <= 0 || p.y < -10) { p.x = Math.random()*canvas.width; p.y = canvas.height+10; p.life = 1; }
      ctx2d.beginPath(); ctx2d.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx2d.fillStyle = `rgba(212,175,55,${p.life*0.4})`;
      ctx2d.fill();
    });
    requestAnimationFrame(drawParticles);
  }
  drawParticles();

  const studio = document.getElementById('intro-studio');
  const geeLogo = document.getElementById('edenic-logo');
  const acfc = document.getElementById('intro-acfc');
  const logo = document.getElementById('intro-logo');
  const video = document.getElementById('intro-video');

  // Phase 1: edenic labs fades in immediately, then "ACFC Presents" scales in
  // Start studio visible immediately so user never sees pure black
  studio.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
  studio.style.opacity = '1'; studio.style.transform = 'translateY(0)';
  setTimeout(() => {
    geeLogo.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
    geeLogo.style.opacity = '1'; geeLogo.style.transform = 'scale(1.1)';
    setTimeout(() => { geeLogo.style.transform = 'scale(1)'; }, 500);
  }, 100);
  setTimeout(() => {
    acfc.style.transition = 'opacity 0.6s ease, transform 0.6s cubic-bezier(0.2,0,0.1,1)';
    acfc.style.opacity = '1'; acfc.style.transform = 'scale(1)';
  }, 1200);

  // Phase 2: Studio fades out, logo slams in or video plays
  setTimeout(() => {
    studio.style.transition = 'opacity 0.6s ease';
    studio.style.opacity = '0';
    if (video.canPlayType && video.canPlayType('video/mp4')) {
      video.style.display = 'block';
      setTimeout(() => {
        video.style.transition = 'opacity 0.5s';
        video.style.opacity = '1';
        video.play().catch(() => {
          video.style.display = 'none';
          showLogoAnimated();
        });
      }, 200);
    } else {
      showLogoAnimated();
    }
  }, 3200);

  function showLogoAnimated() {
    logo.style.transition = 'opacity 0.6s ease, transform 0.8s cubic-bezier(0.2,0,0.1,1.2), filter 0.8s ease';
    logo.style.opacity = '1';
    logo.style.transform = 'scale(1.05) rotate(0deg)';
    logo.style.filter = 'drop-shadow(0 0 60px rgba(212,175,55,0.7))';
    setTimeout(() => {
      logo.style.transform = 'scale(1) rotate(0deg)';
      logo.style.filter = 'drop-shadow(0 0 30px rgba(212,175,55,0.4))';
    }, 800);
  }

  // Phase 3: Transition to title screen (with title animation)
  const goToTitle = () => {
    ensureMusic(); // Start music when transitioning
    particleAnim = false;
    sessionStorage.setItem('gaffer26-intro-seen', '1');
    intro.style.transition = 'opacity 0.8s ease';
    intro.style.opacity = '0';
    setTimeout(() => {
      intro.style.display = 'none';
      const ts = document.getElementById('title-screen');
      ts.style.display = 'flex';
      ts.classList.add('title-animate-in');
      document.getElementById('volume-control').style.display = 'flex';
      const ni = document.getElementById('player-name-input');
      if (playerName) ni.value = playerName;
    }, 800);
  };

  // Start music during intro (user gesture from clicking intro screen)
  ensureMusic();

  // Auto-advance after 7s, or click/tap to skip
  const timer = setTimeout(goToTitle, 7000);
  intro.addEventListener('click', () => { ensureMusic(); clearTimeout(timer); goToTitle(); });
  intro.addEventListener('touchstart', () => { ensureMusic(); clearTimeout(timer); goToTitle(); });
})();

// ‚îÄ‚îÄ EXIT / HOME ‚Äî quit game and return to title ‚îÄ‚îÄ
function goHome() {
  // Hide all screens
  document.getElementById('game-screen').style.display = 'none';
  document.getElementById('game-over').style.display = 'none';
  document.getElementById('draft-screen').style.display = 'none';
  document.getElementById('halftime-screen').style.display = 'none';
  document.getElementById('trade-screen').style.display = 'none';
  document.getElementById('leaderboard-screen').style.display = 'none';
  document.getElementById('pvp-screen').style.display = 'none';
  document.getElementById('exit-btn').style.display = 'none';
  // Show title
  const ts = document.getElementById('title-screen');
  ts.style.display = 'flex';
  ts.classList.remove('title-animate-in');
  // Restore name
  const ni = document.getElementById('player-name-input');
  if (playerName) ni.value = playerName;
  // Switch back to intro music on title screen
  if (musicPlaying) { playIntroMusic(); } else { musicStarted = false; musicConfirmed = false; ensureMusic(); }
}

function startGameWithName(mode) {
  const ni = document.getElementById('player-name-input');
  playerName = ni.value.trim() || 'THE GAFFER';
  localStorage.setItem('gaffer26-name', playerName);
  gameMode = mode;
  startGame();
}

function showPvPSetup() {
  document.getElementById('pvp-screen').style.display = 'flex';
}
function hidePvPSetup() {
  document.getElementById('pvp-screen').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PvP MULTIPLAYER (WebRTC via PeerJS)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateRoomCode() {
  const words = ['KEANE','HENRY','SHEARER','ROONEY','GAZZA','CANTONA','BECKHAM','VIDIC','VARDY','SALAH','VIEIRA','SCHOLES'];
  return words[Math.floor(Math.random() * words.length)];
}

function ensurePeer() {
  return new Promise((resolve, reject) => {
    if (peer && !peer.destroyed) return resolve(peer);
    // Load PeerJS from CDN
    if (!window.Peer) {
      const s = document.createElement('script');
      s.src = 'https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js';
      s.onload = () => {
        peer = new Peer();
        peer.on('open', () => resolve(peer));
        peer.on('error', e => reject(e));
      };
      s.onerror = () => reject(new Error('Failed to load PeerJS'));
      document.head.appendChild(s);
    } else {
      peer = new Peer();
      peer.on('open', () => resolve(peer));
      peer.on('error', e => reject(e));
    }
  });
}

async function createRoom() {
  const status = document.getElementById('pvp-status');
  status.textContent = 'Creating room...';
  try {
    const code = generateRoomCode();
    await ensurePeer();
    // Destroy and recreate with custom ID
    peer.destroy();
    peer = new Peer('gaffer26-' + code);
    await new Promise((res, rej) => { peer.on('open', res); peer.on('error', rej); });

    status.innerHTML = `Room code: <span style="color:var(--gold); font-size:1.5rem; letter-spacing:0.3em">${code}</span><br><span style="font-size:0.7rem; color:#555">Share this code with your opponent</span>`;
    isHost = true;

    peer.on('connection', conn => {
      peerConn = conn;
      setupPeerConnection(conn);
      status.textContent = 'Opponent connected! Starting...';
      setTimeout(() => {
        document.getElementById('pvp-screen').style.display = 'none';
        startGameWithName('pvp');
      }, 1000);
    });
  } catch(e) {
    status.textContent = 'Connection failed. Try vs CPU instead.';
    console.error(e);
  }
}

async function joinRoom() {
  const code = document.getElementById('room-code-input').value.trim().toUpperCase();
  if (!code) return;
  const status = document.getElementById('pvp-status');
  status.textContent = 'Connecting...';
  try {
    await ensurePeer();
    peerConn = peer.connect('gaffer26-' + code);
    peerConn.on('open', () => {
      setupPeerConnection(peerConn);
      isHost = false;
      status.textContent = 'Connected! Starting...';
      setTimeout(() => {
        document.getElementById('pvp-screen').style.display = 'none';
        startGameWithName('pvp');
      }, 1000);
    });
    peerConn.on('error', () => { status.textContent = 'Room not found. Check the code.'; });
    setTimeout(() => {
      if (!peerConn.open) status.textContent = 'Room not found. Check the code.';
    }, 5000);
  } catch(e) {
    status.textContent = 'Connection failed. Try vs CPU instead.';
  }
}

function setupPeerConnection(conn) {
  conn.on('data', data => handlePeerMessage(data));
  conn.on('close', () => {
    if (state.phase !== 'gameover') {
      alert('Opponent disconnected');
      document.getElementById('title-screen').style.display = 'flex';
      document.getElementById('game-screen').style.display = 'none';
    }
  });
}

function sendPeer(msg) {
  if (peerConn && peerConn.open) peerConn.send(msg);
}

function handlePeerMessage(data) {
  // PvP message handling
  switch(data.type) {
    case 'card-played':
      // Opponent played a card
      state.cpuCard = ALL_CARDS.find(c => c.name === data.cardName);
      if (state.cpuCard) {
        state.cpuCard = {...state.cpuCard, ability: {...state.cpuCard.ability}};
        renderCard(state.cpuCard, document.getElementById('cpu-card-front'));
        document.getElementById('cpu-card').classList.add('flipped');
        showCommentary(state.cpuCard, false);
      }
      break;
    case 'stat-picked':
      // Opponent picked a stat (they're the turn owner)
      state.cpuChosenStat = data.stat;
      setTurn(`Opponent chose ${data.stat.toUpperCase()} ‚Äî pick your card!`);
      state.phase = 'select-card';
      break;
    case 'ability-used':
      // Opponent used their ability
      applyCPUAbility();
      break;
    case 'name':
      document.getElementById('p2-name-display').textContent = data.name;
      document.getElementById('opponent-label').textContent = data.name;
      break;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALL 52 CARDS WITH ABILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ALL_CARDS = [
  // ‚ô† GOALKEEPERS
  { name:"Peter Schmeichel", nickname:"Star-fish saves, screamed at everyone", position:"Goalkeeper", suit:"‚ô†", rank:14, rankLabel:"A", pace:38, shooting:15, passing:48, defending:95,
    ability:{ name:"Star-Fish", desc:"Spread yourself impossibly wide ‚Äî block the opponent's highest stat (their chosen stat is reduced by 20 for this round).", type:"manual" }},
  { name:"Petr ƒåech", nickname:"The helmet warrior", position:"Goalkeeper", suit:"‚ô†", rank:13, rankLabel:"K", pace:30, shooting:10, passing:52, defending:93,
    ability:{ name:"The Helmet", desc:"Absorb any hit ‚Äî if you lose this round, keep your card instead of losing it.", type:"manual" }},
  { name:"Jens Lehmann", nickname:"Genuinely unhinged", position:"Goalkeeper", suit:"‚ô†", rank:12, rankLabel:"Q", pace:42, shooting:12, passing:45, defending:90,
    ability:{ name:"Unhinged", desc:"Intimidate the opponent ‚Äî their card loses 10 from ALL stats this round.", type:"manual" }},
  { name:"David Seaman", nickname:"The ponytail, the Ronaldinho lob", position:"Goalkeeper", suit:"‚ô†", rank:11, rankLabel:"J", pace:28, shooting:8, passing:42, defending:88,
    ability:{ name:"The Ponytail", desc:"Lob the result ‚Äî swap your highest stat value with your lowest for this round (confuse the AI).", type:"manual" }},
  { name:"David James", nickname:"Calamity James, Armani model", position:"Goalkeeper", suit:"‚ô†", rank:10, rankLabel:"10", pace:35, shooting:11, passing:40, defending:82,
    ability:{ name:"Calamity", desc:"Chaos! Both cards get randomized stats (30-90) for this round only.", type:"manual" }},
  { name:"Jerzy Dudek", nickname:"Wobbly legs in Istanbul", position:"Goalkeeper", suit:"‚ô†", rank:9, rankLabel:"9", pace:30, shooting:7, passing:38, defending:80,
    ability:{ name:"Wobbly Legs", desc:"Distract the opponent ‚Äî they must pick their stat randomly (CPU picks worst stat).", type:"manual" }},
  { name:"Tim Howard", nickname:"Scored a goal from his own box", position:"Goalkeeper", suit:"‚ô†", rank:8, rankLabel:"8", pace:32, shooting:18, passing:35, defending:78,
    ability:{ name:"Long Bomb", desc:"Your Shooting stat becomes 92 this round (he literally scored from his own box).", type:"manual" }},
  { name:"Shaka Hislop", nickname:"Greatest name in PL history", position:"Goalkeeper", suit:"‚ô†", rank:7, rankLabel:"7", pace:28, shooting:6, passing:33, defending:76,
    ability:{ name:"Name Power", desc:"Style points ‚Äî gain +15 to any stat you choose this round.", type:"manual" }},
  { name:"Paul Robinson", nickname:"Scored from a goal kick", position:"Goalkeeper", suit:"‚ô†", rank:6, rankLabel:"6", pace:26, shooting:22, passing:38, defending:74,
    ability:{ name:"Goal Kick", desc:"Your Shooting becomes 85 this round.", type:"manual" }},
  { name:"Neville Southall", nickname:"Now a full-time Twitter activist", position:"Goalkeeper", suit:"‚ô†", rank:5, rankLabel:"5", pace:20, shooting:5, passing:30, defending:72,
    ability:{ name:"Twitter Rant", desc:"Expose the opponent ‚Äî reveal their card's stats before you pick yours.", type:"manual" }},
  { name:"Heurelho Gomes", nickname:"Absolute chaos merchant", position:"Goalkeeper", suit:"‚ô†", rank:4, rankLabel:"4", pace:30, shooting:6, passing:28, defending:68,
    ability:{ name:"Chaos Merchant", desc:"Coin flip ‚Äî if heads, you win automatically. If tails, you lose automatically.", type:"manual" }},
  { name:"Robert Green", nickname:"The fumble", position:"Goalkeeper", suit:"‚ô†", rank:3, rankLabel:"3", pace:25, shooting:5, passing:25, defending:64,
    ability:{ name:"The Fumble", desc:"So bad it's funny ‚Äî opponent laughs and loses 15 from their chosen stat.", type:"manual" }},
  { name:"Massimo Taibi", nickname:"Let it roll through his legs on debut", position:"Goalkeeper", suit:"‚ô†", rank:2, rankLabel:"2", pace:22, shooting:4, passing:20, defending:58,
    ability:{ name:"Through the Legs", desc:"Nutmeg! Pick any stat ‚Äî if you win, take TWO extra cards from CPU's pile.", type:"manual" }},

  // ‚ô• DEFENDERS
  { name:"Rio Ferdinand", nickname:"The Rolls Royce", position:"Defender", suit:"‚ô•", rank:14, rankLabel:"A", pace:72, shooting:38, passing:78, defending:92,
    ability:{ name:"Rolls Royce", desc:"Smooth operator ‚Äî gain +8 to ALL stats this round.", type:"manual" }},
  { name:"John Terry", nickname:"Full kit weirdo, captain, leader, controversy", position:"Defender", suit:"‚ô•", rank:13, rankLabel:"K", pace:55, shooting:42, passing:62, defending:93,
    ability:{ name:"Full Kit", desc:"Captain's armband ‚Äî you pick both YOUR stat AND the opponent's stat this round.", type:"manual" }},
  { name:"Ashley Cole", nickname:"Shot a work experience kid with an air rifle", position:"Defender", suit:"‚ô•", rank:12, rankLabel:"Q", pace:82, shooting:35, passing:68, defending:88,
    ability:{ name:"Air Rifle", desc:"Snipe! Your Pace gets +15 and if you win, the opponent discards their next hand card.", type:"manual" }},
  { name:"Nemanja Vidiƒá", nickname:"Heading machine, zero fear", position:"Defender", suit:"‚ô•", rank:11, rankLabel:"J", pace:60, shooting:40, passing:48, defending:91,
    ability:{ name:"Zero Fear", desc:"Head it clear ‚Äî your Defending becomes 99 this round.", type:"manual" }},
  { name:"Stuart Pearce", nickname:"Psycho", position:"Defender", suit:"‚ô•", rank:10, rankLabel:"10", pace:68, shooting:55, passing:52, defending:85,
    ability:{ name:"Psycho", desc:"Pure aggression ‚Äî gain +20 Shooting, but lose 15 Defending.", type:"manual" }},
  { name:"Vinnie Jones", nickname:"Grabbed Gazza by the balls, literally", position:"Defender", suit:"‚ô•", rank:9, rankLabel:"9", pace:52, shooting:25, passing:18, defending:88,
    ability:{ name:"The Grab", desc:"Intimidation ‚Äî opponent's best stat is reduced by 25 this round.", type:"manual" }},
  { name:"Gary Neville", nickname:"Most annoying man in football", position:"Defender", suit:"‚ô•", rank:8, rankLabel:"8", pace:62, shooting:22, passing:60, defending:82,
    ability:{ name:"Pundit Mode", desc:"Analysis paralysis ‚Äî peek at the CPU's chosen stat before you pick yours.", type:"manual" }},
  { name:"Patrice Evra", nickname:"Raw chicken, I LOVE THIS GAME", position:"Defender", suit:"‚ô•", rank:7, rankLabel:"7", pace:75, shooting:30, passing:65, defending:80,
    ability:{ name:"Raw Chicken", desc:"I LOVE THIS GAME ‚Äî win or lose, you keep your card this round.", type:"manual" }},
  { name:"Virgil van Dijk", nickname:"The Colossus", position:"Defender", suit:"‚ô•", rank:6, rankLabel:"6", pace:70, shooting:35, passing:72, defending:92,
    ability:{ name:"Colossus", desc:"Immovable object ‚Äî if the stat difference is 15 or less, you win automatically.", type:"manual" }},
  { name:"Jaap Stam", nickname:"Bald assassin, sold for writing a book", position:"Defender", suit:"‚ô•", rank:5, rankLabel:"5", pace:65, shooting:20, passing:45, defending:90,
    ability:{ name:"The Stare", desc:"Lock eyes ‚Äî the opponent's card is frozen (all stats drop by 12).", type:"manual" }},
  { name:"Martin Keown", nickname:"That face snarling at van Nistelrooy", position:"Defender", suit:"‚ô•", rank:4, rankLabel:"4", pace:58, shooting:15, passing:40, defending:84,
    ability:{ name:"The Snarl", desc:"Get in their face ‚Äî ties count as wins for you this round.", type:"manual" }},
  { name:"Micah Richards", nickname:"Biggest laugh in punditry", position:"Defender", suit:"‚ô•", rank:3, rankLabel:"3", pace:80, shooting:30, passing:48, defending:72,
    ability:{ name:"Big Laugh", desc:"Infectious energy ‚Äî your Pace becomes 95 this round.", type:"manual" }},
  { name:"Titus Bramble", nickname:"Walking disaster, highlight reel of chaos", position:"Defender", suit:"‚ô•", rank:2, rankLabel:"2", pace:55, shooting:12, passing:28, defending:52,
    ability:{ name:"Walking Disaster", desc:"Own goal! Lose this round automatically... but steal TWO cards from CPU's won pile.", type:"manual" }},

  // ‚ô¶ MIDFIELDERS
  { name:"Paul Gascoigne", nickname:"The most talented and tragic", position:"Midfielder", suit:"‚ô¶", rank:14, rankLabel:"A", pace:78, shooting:82, passing:93, defending:30,
    ability:{ name:"Dentist's Chair", desc:"Celebrate early ‚Äî gain +10 to all stats. If you lose anyway, opponent takes an extra card.", type:"manual" }},
  { name:"David Beckham", nickname:"The brand, the free kicks", position:"Midfielder", suit:"‚ô¶", rank:13, rankLabel:"K", pace:68, shooting:86, passing:95, defending:35,
    ability:{ name:"Free Kick", desc:"Bend it ‚Äî your Shooting becomes 99 and Passing becomes 99 this round.", type:"manual" }},
  { name:"Steven Gerrard", nickname:"He slipped", position:"Midfielder", suit:"‚ô¶", rank:12, rankLabel:"Q", pace:74, shooting:85, passing:88, defending:62,
    ability:{ name:"The Slip", desc:"90% chance: win the round outright. 10% chance: lose even if you're ahead.", type:"manual" }},
  { name:"Frank Lampard", nickname:"Fat Frank to legend", position:"Midfielder", suit:"‚ô¶", rank:11, rankLabel:"J", pace:60, shooting:88, passing:82, defending:55,
    ability:{ name:"Ghost Goal", desc:"Did it cross the line? Your Shooting becomes 95. If you lose, it 'didn't count' ‚Äî draw instead.", type:"manual" }},
  { name:"Roy Keane", nickname:"Would fight his own shadow", position:"Midfielder", suit:"‚ô¶", rank:10, rankLabel:"10", pace:70, shooting:65, passing:75, defending:82,
    ability:{ name:"Red Mist", desc:"Double your chosen stat. But if you lose, opponent takes an extra card from your pile.", type:"manual" }},
  { name:"Patrick Vieira", nickname:"Tunnel wars with Keane", position:"Midfielder", suit:"‚ô¶", rank:9, rankLabel:"9", pace:72, shooting:62, passing:78, defending:80,
    ability:{ name:"Tunnel Wars", desc:"Force a showdown ‚Äî the round is decided by Defending only, regardless of what was picked.", type:"manual" }},
  { name:"Paul Scholes", nickname:"Hit a tree from 40 yards, worst tackles ever", position:"Midfielder", suit:"‚ô¶", rank:8, rankLabel:"8", pace:52, shooting:82, passing:90, defending:45,
    ability:{ name:"Tree Shot", desc:"Your Passing becomes 99. Also, randomly reduce one of the opponent's stats by 20 (bad tackle).", type:"manual" }},
  { name:"Matt Le Tissier", nickname:"Genius who refused to leave Southampton", position:"Midfielder", suit:"‚ô¶", rank:7, rankLabel:"7", pace:45, shooting:88, passing:85, defending:20,
    ability:{ name:"Loyalty", desc:"Stubborn genius ‚Äî if you play Le Tiss on your home turf (your turn), +15 to all stats.", type:"manual" }},
  { name:"Jack Grealish", nickname:"Tiny shin pads, calves, partying with the trophy", position:"Midfielder", suit:"‚ô¶", rank:6, rankLabel:"6", pace:76, shooting:68, passing:80, defending:32,
    ability:{ name:"Tiny Shin Pads", desc:"Draw the foul ‚Äî if you lose by 10 or less, it becomes a draw instead.", type:"manual" }},
  { name:"Cole Palmer", nickname:"Cold Palmer, ice in his veins", position:"Midfielder", suit:"‚ô¶", rank:5, rankLabel:"5", pace:72, shooting:82, passing:78, defending:28,
    ability:{ name:"Cold Palmer", desc:"Ice cold ‚Äî your stat cannot be affected by any opponent ability this round.", type:"manual" }},
  { name:"Joey Barton", nickname:"Stubbed a cigar out on a teammate", position:"Midfielder", suit:"‚ô¶", rank:4, rankLabel:"4", pace:58, shooting:55, passing:62, defending:60,
    ability:{ name:"Cigar Burn", desc:"Dirty play ‚Äî reduce opponent's highest stat by 30. But 25% chance you get sent off (auto-lose).", type:"manual" }},
  { name:"Lee Bowyer", nickname:"Fought his own teammate on the pitch", position:"Midfielder", suit:"‚ô¶", rank:3, rankLabel:"3", pace:62, shooting:52, passing:55, defending:55,
    ability:{ name:"Friendly Fire", desc:"Chaos ‚Äî swap one random stat between your card and the opponent's card.", type:"manual" }},
  { name:"Kieron Dyer", nickname:"The teammate Bowyer fought", position:"Midfielder", suit:"‚ô¶", rank:2, rankLabel:"2", pace:78, shooting:42, passing:50, defending:35,
    ability:{ name:"Glass Legs", desc:"Sprint! Pace becomes 95, but all other stats drop by 10.", type:"manual" }},

  // ‚ô£ STRIKERS
  { name:"Thierry Henry", nickname:"The King", position:"Striker", suit:"‚ô£", rank:14, rankLabel:"A", pace:94, shooting:93, passing:82, defending:28,
    ability:{ name:"Va Va Voom", desc:"Pure class ‚Äî gain +5 to all stats AND pick your stat after seeing the opponent's card.", type:"manual" }},
  { name:"Alan Shearer", nickname:"The celebration, the punditry", position:"Striker", suit:"‚ô£", rank:13, rankLabel:"K", pace:72, shooting:95, passing:62, defending:35,
    ability:{ name:"The Celebration", desc:"One arm raised ‚Äî Shooting becomes 99 and if you win, gain an extra card from CPU's pile.", type:"manual" }},
  { name:"Wayne Rooney", nickname:"Granny gate, hair transplant, everything", position:"Striker", suit:"‚ô£", rank:12, rankLabel:"Q", pace:80, shooting:90, passing:78, defending:42,
    ability:{ name:"Overhead Kick", desc:"Spectacular! Win automatically if your Shooting is higher than their Defending.", type:"manual" }},
  { name:"Eric Cantona", nickname:"Kung-fu kick, collar up, philosopher king", position:"Striker", suit:"‚ô£", rank:11, rankLabel:"J", pace:65, shooting:85, passing:82, defending:30,
    ability:{ name:"Kung Fu Kick", desc:"Once per game ‚Äî cancel a loss and replay the round with a new CPU card.", type:"manual" }},
  { name:"Sergio Ag√ºero", nickname:"AGUEROOOO", position:"Striker", suit:"‚ô£", rank:10, rankLabel:"10", pace:82, shooting:92, passing:72, defending:22,
    ability:{ name:"AGUEROOOO", desc:"Last-minute drama ‚Äî if you're losing, 40% chance to win instead.", type:"manual" }},
  { name:"Cristiano Ronaldo", nickname:"The ego, the talent, the SIUUU", position:"Striker", suit:"‚ô£", rank:9, rankLabel:"9", pace:92, shooting:94, passing:72, defending:35,
    ability:{ name:"SIUUU", desc:"The ego ‚Äî ALL your stats become 90 this round. You're just built different.", type:"manual" }},
  { name:"Erling Haaland", nickname:"Viking terminator", position:"Striker", suit:"‚ô£", rank:8, rankLabel:"8", pace:85, shooting:94, passing:55, defending:32,
    ability:{ name:"Viking Mode", desc:"Brute force ‚Äî your highest stat gains +15. Simple. Effective.", type:"manual" }},
  { name:"Mo Salah", nickname:"The Egyptian King", position:"Striker", suit:"‚ô£", rank:7, rankLabel:"7", pace:92, shooting:88, passing:72, defending:30,
    ability:{ name:"Cut Inside", desc:"Wrong-foot them ‚Äî swap Pace and Shooting values, then gain +10 to whichever is now higher.", type:"manual" }},
  { name:"Jamie Vardy", nickname:"Chat shit get banged, non-league to champion", position:"Striker", suit:"‚ô£", rank:6, rankLabel:"6", pace:92, shooting:80, passing:55, defending:28,
    ability:{ name:"Chat Shit", desc:"Get banged! Trash talk ‚Äî opponent's stats all drop by 8. Pace becomes 99.", type:"manual" }},
  { name:"Luis Su√°rez", nickname:"Biting, racism, genius", position:"Striker", suit:"‚ô£", rank:5, rankLabel:"5", pace:78, shooting:90, passing:80, defending:38,
    ability:{ name:"The Bite", desc:"Steal a card from the opponent's WON pile instead of playing the current round.", type:"manual" }},
  { name:"Paolo Di Canio", nickname:"The push on the ref, the volley, the salute", position:"Striker", suit:"‚ô£", rank:4, rankLabel:"4", pace:70, shooting:78, passing:68, defending:18,
    ability:{ name:"The Volley", desc:"Spectacular technique ‚Äî Shooting becomes 98 but Defending drops to 5.", type:"manual" }},
  { name:"Mario Balotelli", nickname:"Why always me, fireworks in his bathroom", position:"Striker", suit:"‚ô£", rank:3, rankLabel:"3", pace:72, shooting:78, passing:55, defending:20,
    ability:{ name:"Why Always Me", desc:"Randomize which stat is used this round ‚Äî nobody knows what's coming.", type:"manual" }},
  { name:"Ali Dia", nickname:"Pretended to be George Weah's cousin. Legend.", position:"Striker", suit:"‚ô£", rank:2, rankLabel:"2", pace:18, shooting:8, passing:12, defending:15,
    ability:{ name:"The Con", desc:"Bluff any one stat as 99 ‚Äî opponent can call your bluff. If they don't call it, you win. If they do, you auto-lose.", type:"manual" }},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STATS = ['pace','shooting','passing','defending'];
const STAT_ICONS = { pace:'üèÉ', shooting:'‚öΩ', passing:'üéØ', defending:'üõ°Ô∏è' };
const POS_CLASS = { Goalkeeper:'pos-gk', Defender:'pos-def', Midfielder:'pos-mid', Striker:'pos-str' };
const POS_COLOR = { Goalkeeper:'var(--gk)', Defender:'var(--def)', Midfielder:'var(--mid)', Striker:'var(--str)' };

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WIKIPEDIA IMAGE FETCHER ‚Äî loads real player photos at startup
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WIKI_SEARCH_NAMES = {
  "Peter Schmeichel": "Peter Schmeichel",
  "Petr ƒåech": "Petr ƒåech",
  "Jens Lehmann": "Jens Lehmann",
  "David Seaman": "David Seaman (footballer)",
  "David James": "David James (footballer)",
  "Jerzy Dudek": "Jerzy Dudek",
  "Tim Howard": "Tim Howard",
  "Shaka Hislop": "Shaka Hislop",
  "Paul Robinson": "Paul Robinson (footballer, born 1979)",
  "Neville Southall": "Neville Southall",
  "Heurelho Gomes": "Heurelho Gomes",
  "Robert Green": "Robert Green (footballer)",
  "Massimo Taibi": "Massimo Taibi",
  "Rio Ferdinand": "Rio Ferdinand",
  "John Terry": "John Terry",
  "Ashley Cole": "Ashley Cole",
  "Nemanja Vidiƒá": "Nemanja Vidiƒá",
  "Stuart Pearce": "Stuart Pearce",
  "Vinnie Jones": "Vinnie Jones",
  "Gary Neville": "Gary Neville",
  "Patrice Evra": "Patrice Evra",
  "Virgil van Dijk": "Virgil van Dijk",
  "Jaap Stam": "Jaap Stam",
  "Martin Keown": "Martin Keown",
  "Micah Richards": "Micah Richards",
  "Titus Bramble": "Titus Bramble",
  "Paul Gascoigne": "Paul Gascoigne",
  "David Beckham": "David Beckham",
  "Steven Gerrard": "Steven Gerrard",
  "Frank Lampard": "Frank Lampard",
  "Roy Keane": "Roy Keane",
  "Patrick Vieira": "Patrick Vieira",
  "Paul Scholes": "Paul Scholes",
  "Matt Le Tissier": "Matt Le Tissier",
  "Jack Grealish": "Jack Grealish",
  "Cole Palmer": "Cole Palmer (footballer)",
  "Joey Barton": "Joey Barton",
  "Lee Bowyer": "Lee Bowyer",
  "Kieron Dyer": "Kieron Dyer",
  "Thierry Henry": "Thierry Henry",
  "Alan Shearer": "Alan Shearer",
  "Wayne Rooney": "Wayne Rooney",
  "Eric Cantona": "Eric Cantona",
  "Sergio Ag√ºero": "Sergio Ag√ºero",
  "Cristiano Ronaldo": "Cristiano Ronaldo",
  "Erling Haaland": "Erling Haaland",
  "Mo Salah": "Mohamed Salah",
  "Jamie Vardy": "Jamie Vardy",
  "Luis Su√°rez": "Luis Su√°rez",
  "Paolo Di Canio": "Paolo Di Canio",
  "Mario Balotelli": "Mario Balotelli",
  "Ali Dia": "Ali Dia",
};

// Local image map ‚Äî uses generated images from images/ folder, falls back to Wikipedia
const LOCAL_IMAGES = {
  "Peter Schmeichel": "images/peter-schmeichel.png",
  "Petr ƒåech": "images/petr-cech.png",
  "Jens Lehmann": "images/jens-lehmann.png",
  "David Seaman": "images/david-seaman.png",
  "David James": "images/david-james.png",
  "Jerzy Dudek": "images/jerzy-dudek.png",
  "Tim Howard": "images/tim-howard.png",
  "Shaka Hislop": "images/shaka-hislop.png",
  "Paul Robinson": "images/paul-robinson.png",
  "Neville Southall": "images/neville-southall.png",
  "Heurelho Gomes": "images/heurelho-gomes.png",
  "Robert Green": "images/robert-green.png",
  "Massimo Taibi": "images/massimo-taibi.png",
  "Rio Ferdinand": "images/rio-ferdinand.png",
  "John Terry": "images/john-terry.png",
  "Ashley Cole": "images/ashley-cole.png",
  "Nemanja Vidiƒá": "images/nemanja-vidic.png",
  "Stuart Pearce": "images/stuart-pearce.png",
  "Vinnie Jones": "images/vinnie-jones.png",
  "Gary Neville": "images/gary-neville.png",
  "Patrice Evra": "images/patrice-evra.png",
  "Virgil van Dijk": "images/virgil-van-dijk.png",
  "Jaap Stam": "images/jaap-stam.png",
  "Martin Keown": "images/martin-keown.png",
  "Micah Richards": "images/micah-richards.png",
  "Titus Bramble": "images/titus-bramble.png",
  "Paul Gascoigne": "images/paul-gascoigne.png",
  "David Beckham": "images/david-beckham.png",
  "Steven Gerrard": "images/steven-gerrard.png",
  "Frank Lampard": "images/frank-lampard.png",
  "Roy Keane": "images/roy-keane.png",
  "Patrick Vieira": "images/patrick-vieira.png",
  "Paul Scholes": "images/paul-scholes.png",
  "Matt Le Tissier": "images/matt-le-tissier.png",
  "Jack Grealish": "images/jack-grealish.png",
  "Cole Palmer": "images/cole-palmer.png",
  "Joey Barton": "images/joey-barton.png",
  "Lee Bowyer": "images/lee-bowyer.png",
  "Kieron Dyer": "images/kieron-dyer.png",
  "Thierry Henry": "images/thierry-henry.png",
  "Alan Shearer": "images/alan-shearer.png",
  "Wayne Rooney": "images/wayne-rooney.png",
  "Eric Cantona": "images/eric-cantona.png",
  "Sergio Ag√ºero": "images/sergio-aguero.png",
  "Cristiano Ronaldo": "images/cristiano-ronaldo.png",
  "Erling Haaland": "images/erling-haaland.png",
  "Mo Salah": "images/mo-salah.png",
  "Jamie Vardy": "images/jamie-vardy.png",
  "Luis Su√°rez": "images/luis-suarez.png",
  "Paolo Di Canio": "images/paolo-di-canio.png",
  "Mario Balotelli": "images/mario-balotelli.png",
  "Ali Dia": "images/ali-dia.png",
};

async function fetchPlayerImages() {
  // First: apply local images
  ALL_CARDS.forEach(c => {
    if (LOCAL_IMAGES[c.name]) c.img = LOCAL_IMAGES[c.name];
  });

  // Then: fetch remaining from Wikipedia for cards without local images
  const missing = ALL_CARDS.filter(c => !c.img);
  if (missing.length === 0) return;

  const names = missing.map(c => WIKI_SEARCH_NAMES[c.name] || c.name);
  for (let i = 0; i < names.length; i += 10) {
    const batch = names.slice(i, i + 10);
    const titles = batch.map(n => encodeURIComponent(n)).join('|');
    try {
      const resp = await fetch(`https://en.wikipedia.org/w/api.php?action=query&titles=${titles}&prop=pageimages&pithumbsize=500&format=json&origin=*`);
      const data = await resp.json();
      if (data.query && data.query.pages) {
        Object.values(data.query.pages).forEach(page => {
          if (page.thumbnail) {
            const card = missing.find(c => {
              const wikiName = WIKI_SEARCH_NAMES[c.name] || c.name;
              return page.title === wikiName || page.title.includes(c.name.split(' ').pop());
            });
            if (card && !card.img) card.img = page.thumbnail.source;
          }
        });
      }
    } catch(e) { /* silently fail */ }
  }
}
const HAND_SIZE = 5;
const WAR_THRESHOLD = 5;
const COMEBACK_THRESHOLD = 5;
const HIGH_STAKES_INTERVAL = 5; // Every 5th round is high stakes
const HALFTIME_ROUND = 13;      // Halftime at round 13 (of ~26)
const STREAK_BONUS_THRESHOLDS = [2, 3, 5]; // Streak levels: Hot, Fire, Inferno

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let state = {
  playerPile: [],      // undrawn cards
  cpuPile: [],         // undrawn cards
  playerWon: [],       // won cards pile
  cpuWon: [],          // won cards pile
  playerHand: [],      // current hand (up to HAND_SIZE)
  cpuHand: [],         // cpu hand
  playerCard: null,    // card played to battlefield
  cpuCard: null,       // card played to battlefield
  warPot: [],          // cards in the war pot
  isPlayerTurn: true,
  phase: 'idle',       // idle | select-card | select-stat | reveal | resolve | war | ability | gameover
  abilityUsed: false,  // per-round flag
  abilityActive: null, // active ability object
  cantonaUsed: false,  // once per game
  roundStats: {},      // temp stat modifications for the round
  comebackPlayer: false,
  comebackCPU: false,
  roundsWon: 0,
  roundsLost: 0,
  roundsDrawn: 0,
  currentStreak: 0,
  bestStreak: 0,
  abilitiesUsed: 0,
  warsWon: 0,
  // ‚îÄ‚îÄ NEW GAMEPLAY FEATURES ‚îÄ‚îÄ
  roundNumber: 0,          // current round (1-based)
  energy: 1,               // energy for abilities (replaces flat cap)
  maxEnergy: 5,            // energy cap
  isHighStakes: false,     // current round is high stakes
  highStakesDeclined: false, // player folded this round
  halftimeDone: false,     // halftime already shown
  halftimeTactic: null,    // 'attack' | 'defend' | 'balanced' | null
  streakBonus: 0,          // current streak stat bonus (0, +3, +5, +8)
  cpuDifficulty: 0,        // 0=casual 1=smart 2=ruthless (progressive)
  warLevel: 0,             // escalation level in current war chain
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function posClass(card) { return POS_CLASS[card.position] || ''; }
function totalCards(side) {
  if (side === 'player') return state.playerPile.length + state.playerHand.length + state.playerWon.length + (state.playerCard ? 1 : 0);
  return state.cpuPile.length + state.cpuHand.length + state.cpuWon.length + (state.cpuCard ? 1 : 0);
}

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

function getStat(card, stat, mods) {
  let v = card[stat];
  if (mods && mods[stat] !== undefined) v = mods[stat];
  return Math.max(0, Math.min(99, v));
}

function screenFlash(color, duration = 200) {
  const el = document.getElementById('screen-flash');
  el.className = `screen-flash ${color} show`;
  setTimeout(() => el.classList.remove('show'), duration);
}

function screenShake() {
  document.body.classList.add('shake');
  setTimeout(() => document.body.classList.remove('shake'), 500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI UPDATES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateCounts() {
  document.getElementById('player-count').textContent = totalCards('player');
  document.getElementById('cpu-count').textContent = totalCards('cpu');
}

function updateWarPile() {
  const el = document.getElementById('war-pile');
  if (state.warPot.length > 0) {
    el.textContent = `‚öîÔ∏è War pot: ${state.warPot.length} cards`;
  } else {
    el.textContent = '';
  }
}

function updateComeback() {
  const el = document.getElementById('comeback-indicator');
  const pc = totalCards('player');
  const cc = totalCards('cpu');
  state.comebackPlayer = pc <= COMEBACK_THRESHOLD && pc > 0;
  state.comebackCPU = cc <= COMEBACK_THRESHOLD && cc > 0;

  if (state.comebackPlayer) {
    el.className = 'comeback-indicator player-comeback';
    el.textContent = '‚ö° COMEBACK MODE ‚Äî Abilities auto-activate';
  } else if (state.comebackCPU) {
    el.className = 'comeback-indicator cpu-comeback';
    el.textContent = '‚ö° CPU COMEBACK MODE';
  } else {
    el.className = 'comeback-indicator';
    el.textContent = '';
  }
}

function setTurn(text) {
  document.getElementById('turn-indicator').textContent = text;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOMENTUM & STREAK SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateMomentum() {
  const bar = document.getElementById('momentum-bar');
  if (!bar) return;
  const s = state.currentStreak;
  if (s >= 5) {
    state.streakBonus = 8;
    bar.innerHTML = '<span class="streak-fire">üî•üî•üî•</span> <span class="bonus-text">INFERNO +8 ALL STATS</span>';
  } else if (s >= 3) {
    state.streakBonus = 5;
    bar.innerHTML = '<span class="streak-fire">üî•üî•</span> <span class="bonus-text">ON FIRE +5 ALL STATS</span>';
  } else if (s >= 2) {
    state.streakBonus = 3;
    bar.innerHTML = '<span class="streak-fire">üî•</span> <span class="bonus-text">HOT STREAK +3 ALL STATS</span>';
  } else {
    state.streakBonus = 0;
    bar.innerHTML = '';
  }
  // Apply golden glow to player card if streaking
  const pw = document.querySelector('#player-card .card-wrapper, #player-card');
  if (pw) {
    if (s >= 2) pw.classList.add('streak-glow');
    else pw.classList.remove('streak-glow');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENERGY SYSTEM (replaces flat ability cap)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateEnergyDisplay() {
  const bar = document.getElementById('momentum-bar');
  if (!bar) return;
  const existing = bar.querySelector('.energy-display');
  if (existing) existing.remove();
  const el = document.createElement('span');
  el.className = 'energy-display';
  el.style.cssText = 'margin-left:0.5rem; color:#4a90d9;';
  let bolts = '';
  for (let i = 0; i < state.maxEnergy; i++) {
    bolts += i < state.energy ? '‚ö°' : '¬∑';
  }
  el.textContent = bolts;
  bar.appendChild(el);

  // Update the persistent superpower HUD
  const spCount = document.getElementById('superpower-count');
  const spMax = document.getElementById('superpower-max');
  const spHud = document.getElementById('superpower-hud');
  if (spCount) spCount.textContent = state.energy;
  if (spMax) spMax.textContent = state.maxEnergy;
  if (spHud) {
    if (state.energy <= 0) {
      spHud.style.opacity = '0.3';
      spHud.style.color = '#666';
      spHud.style.animation = 'none';
    } else {
      spHud.style.opacity = '';
      spHud.style.color = '';
      spHud.style.animation = '';
    }
  }
}

function gainEnergy(amount) {
  state.energy = Math.min(state.maxEnergy, state.energy + amount);
  updateEnergyDisplay();
}

function spendEnergy() {
  if (state.energy <= 0) return false;
  state.energy--;
  updateEnergyDisplay();
  return true;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROGRESSIVE CPU INTELLIGENCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateCPUDifficulty() {
  const r = state.roundNumber;
  if (r <= 8) state.cpuDifficulty = 0;        // casual
  else if (r <= 18) state.cpuDifficulty = 1;   // smart
  else state.cpuDifficulty = 2;                // ruthless
}

function cpuPickBestCard() {
  // Difficulty 0: 70% best, 30% random (existing behavior)
  // Difficulty 1: 85% best, 15% random, considers position synergy
  // Difficulty 2: 95% best, also considers opponent's likely stat
  const diff = state.cpuDifficulty;
  const smartChance = diff === 0 ? 0.7 : diff === 1 ? 0.85 : 0.95;

  if (Math.random() < smartChance) {
    let best = 0, bestScore = 0;
    state.cpuHand.forEach((c, i) => {
      let score = Math.max(c.pace, c.shooting, c.passing, c.defending);
      // At difficulty 2, also factor in second-best stat (harder to counter)
      if (diff >= 2) {
        const sorted = [c.pace, c.shooting, c.passing, c.defending].sort((a,b) => b-a);
        score = sorted[0] * 0.7 + sorted[1] * 0.3;
      }
      if (score > bestScore) { bestScore = score; best = i; }
    });
    return best;
  }
  return Math.floor(Math.random() * state.cpuHand.length);
}

function cpuPickBestStat() {
  // Difficulty 0: 80% best stat, 20% random (existing)
  // Difficulty 1: 90% best, avoids opponent's obvious strengths
  // Difficulty 2: 95% best, also factors in opponent's likely weak stat
  const diff = state.cpuDifficulty;
  const randomChance = diff === 0 ? 0.2 : diff === 1 ? 0.1 : 0.05;

  if (Math.random() < randomChance) {
    return STATS[Math.floor(Math.random() * STATS.length)];
  }

  let bestStat = 'pace', bestVal = 0;
  STATS.forEach(s => {
    let v = getStat(state.cpuCard, s, state.roundStats.cpu);
    // At diff 2, also consider the *gap* vs player card (if visible)
    if (diff >= 2 && state.playerCard) {
      const pv = getStat(state.playerCard, s, state.roundStats.player);
      v = v - pv; // maximize advantage
    }
    if (v > bestVal) { bestVal = v; bestStat = s; }
  });
  return bestStat;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HIGH STAKES ROUNDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function checkHighStakes() {
  if (state.roundNumber % HIGH_STAKES_INTERVAL !== 0 || state.roundNumber === 0) {
    state.isHighStakes = false;
    state.highStakesDeclined = false;
    return;
  }
  state.isHighStakes = true;
  state.highStakesDeclined = false;

  // Show high stakes prompt
  showBanner('‚ö° HIGH STAKES ROUND ‚ö°', 'war');
  screenFlash('gold', 400);
  setTurn('DOUBLE OR NOTHING ‚Äî Win 2x cards, lose 2x!');
  await delay(2000);
  hideBanner();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HALFTIME TACTICS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function showHalftime() {
  if (state.halftimeDone) return false;
  if (state.roundNumber !== HALFTIME_ROUND) return false;
  state.halftimeDone = true;

  const htEl = document.getElementById('halftime-screen');
  const statsEl = document.getElementById('ht-stats');
  const twistEl = document.getElementById('ht-twist');

  // Populate halftime stats
  const lead = totalCards('player') - totalCards('cpu');
  const status = lead > 5 ? 'Dominating' : lead > 0 ? 'Ahead' : lead === 0 ? 'Level' : lead > -5 ? 'Behind' : 'Struggling';
  statsEl.innerHTML = `
    <div style="text-align:center"><div style="font-size:1.8rem;font-weight:700;color:var(--gold)">${state.roundsWon}</div><div style="font-size:0.65rem;color:#888;text-transform:uppercase;letter-spacing:0.15em">Won</div></div>
    <div style="text-align:center"><div style="font-size:1.8rem;font-weight:700;color:#e74c3c">${state.roundsLost}</div><div style="font-size:0.65rem;color:#888;text-transform:uppercase;letter-spacing:0.15em">Lost</div></div>
    <div style="text-align:center"><div style="font-size:1.8rem;font-weight:700;color:#aaa">${state.roundsDrawn}</div><div style="font-size:0.65rem;color:#888;text-transform:uppercase;letter-spacing:0.15em">Draws</div></div>
    <div style="text-align:center"><div style="font-size:1.8rem;font-weight:700;color:#4a90d9">${state.bestStreak}</div><div style="font-size:0.65rem;color:#888;text-transform:uppercase;letter-spacing:0.15em">Best Streak</div></div>
    <div style="text-align:center"><div style="font-size:1.8rem;font-weight:700;color:${lead >= 0 ? 'var(--gold)' : '#e74c3c'}">${status}</div><div style="font-size:0.65rem;color:#888;text-transform:uppercase;letter-spacing:0.15em">Status</div></div>
  `;

  // Replace the single button with tactic choices
  twistEl.innerHTML = `
    <div style="margin-bottom:0.5rem">Choose your second-half tactic:</div>
    <div style="display:flex; gap:0.8rem; flex-wrap:wrap; justify-content:center; margin-top:0.8rem">
      <button class="btn-deal" onclick="pickHalftimeTactic('attack')" style="font-size:0.85rem; padding:0.6rem 1.5rem; border-color:#e74c3c; color:#e74c3c">‚öîÔ∏è Attack<br><span style="font-size:0.55rem;color:#888;-webkit-text-fill-color:#888">+5 Shooting & Pace<br>‚àí3 Defending</span></button>
      <button class="btn-deal" onclick="pickHalftimeTactic('defend')" style="font-size:0.85rem; padding:0.6rem 1.5rem; border-color:#4a90d9; color:#4a90d9">üõ°Ô∏è Defend<br><span style="font-size:0.55rem;color:#888;-webkit-text-fill-color:#888">+5 Defending & Passing<br>‚àí3 Pace</span></button>
      <button class="btn-deal" onclick="pickHalftimeTactic('balanced')" style="font-size:0.85rem; padding:0.6rem 1.5rem; border-color:var(--gold); color:var(--gold)">‚öñÔ∏è Balanced<br><span style="font-size:0.55rem;color:#888;-webkit-text-fill-color:#888">+2 All Stats<br>+1 Energy</span></button>
    </div>
  `;

  // Remove the old "Second Half" button since tactics buttons replace it
  const oldBtn = htEl.querySelector('button.btn-deal:last-child');
  if (oldBtn && oldBtn.textContent.includes('Second Half')) oldBtn.style.display = 'none';

  // Switch to halftime music
  playHalftimeMusic();

  htEl.style.display = 'flex';
  return true;
}

function pickHalftimeTactic(tactic) {
  state.halftimeTactic = tactic;

  let msg = '';
  switch(tactic) {
    case 'attack':
      msg = '‚öîÔ∏è ATTACK MODE ‚Äî Shooting & Pace boosted!';
      break;
    case 'defend':
      msg = 'üõ°Ô∏è DEFENSIVE MODE ‚Äî Defending & Passing boosted!';
      break;
    case 'balanced':
      msg = '‚öñÔ∏è BALANCED ‚Äî All stats +2, +1 Energy!';
      gainEnergy(1);
      break;
  }

  // Resume gameplay music after halftime
  playGameplayMusic();

  document.getElementById('halftime-screen').style.display = 'none';
  showBanner(msg, 'ability');
  screenFlash('gold', 300);
  setTimeout(() => {
    hideBanner();
    nextRound();
  }, 1500);
}

// Called from the old button as fallback
function resumeFromHalfTime() {
  pickHalftimeTactic('balanced');
}

// Apply halftime tactic bonus to player stats (uses card base values)
function applyHalftimeTactic(card, mods) {
  if (!state.halftimeTactic || !card) return;
  switch(state.halftimeTactic) {
    case 'attack':
      mods.shooting = (mods.shooting !== undefined ? mods.shooting : card.shooting) + 5;
      mods.pace = (mods.pace !== undefined ? mods.pace : card.pace) + 5;
      mods.defending = (mods.defending !== undefined ? mods.defending : card.defending) - 3;
      break;
    case 'defend':
      mods.defending = (mods.defending !== undefined ? mods.defending : card.defending) + 5;
      mods.passing = (mods.passing !== undefined ? mods.passing : card.passing) + 5;
      mods.pace = (mods.pace !== undefined ? mods.pace : card.pace) - 3;
      break;
    case 'balanced':
      STATS.forEach(s => { mods[s] = (mods[s] !== undefined ? mods[s] : card[s]) + 2; });
      break;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STREAK BONUS ‚Äî applied to player stats each round
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyStreakBonus(card, mods) {
  if (state.streakBonus <= 0 || !card) return;
  STATS.forEach(s => {
    mods[s] = (mods[s] !== undefined ? mods[s] : card[s]) + state.streakBonus;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER CARD (for battlefield)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCard(card, el, mods) {
  const pc = posClass(card);
  const color = POS_COLOR[card.position];
  el.className = `card-face card-front ${pc}`;

  let statsHTML = '';
  STATS.forEach(s => {
    const val = getStat(card, s, mods);
    const isModified = mods && mods[s] !== undefined && mods[s] !== card[s];
    const modClass = isModified ? (mods[s] > card[s] ? 'boosted' : 'nerfed') : '';
    statsHTML += `
      <div class="stat-row ${modClass}" data-stat="${s}">
        <span class="stat-icon">${STAT_ICONS[s]}</span>
        <span class="stat-label">${s}</span>
        <div class="stat-bar-bg">
          <div class="stat-bar-fill" style="width:${val}%; background:${color}"></div>
        </div>
        <span class="stat-value">${val}</span>
      </div>`;
  });

  const imgHTML = card.img ? `<div class="card-photo-wrapper"><img class="card-photo" src="${card.img}" alt="${card.name}" loading="lazy" onload="this.dataset.loaded='true'" onerror="this.style.display='none'"></div>` : `<div class="card-photo-wrapper"></div>`;

  el.innerHTML = `
    <div class="card-header">
      <span class="card-suit">${card.suit}</span>
      <span class="card-rank">${card.rankLabel}</span>
    </div>
    <div class="card-position">${card.position}</div>
    ${imgHTML}
    <div class="card-name">${card.name}</div>
    <div class="card-nickname">"${card.nickname}"</div>
    <div class="card-ability">‚ö° ${card.ability.name}</div>
    <div class="card-stats">${statsHTML}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER HAND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHand() {
  const handEl = document.getElementById('player-hand');
  handEl.innerHTML = '';

  state.playerHand.forEach((card, i) => {
    const div = document.createElement('div');
    div.className = `hand-card ${posClass(card)}`;
    if (state.playerCard === card) div.classList.add('selected');
    div.innerHTML = `
      <div class="hc-ability-dot" title="‚ö° ${card.ability.name}"></div>
      <span class="hc-rank">${card.rankLabel}</span>
      <span class="hc-suit">${card.suit}</span>
      <span class="hc-name">${card.name.split(' ').pop()}</span>`;
    div.onclick = () => selectCard(i);
    handEl.appendChild(div);
  });
}

function drawToHand(side) {
  const pile = side === 'player' ? state.playerPile : state.cpuPile;
  const hand = side === 'player' ? state.playerHand : state.cpuHand;
  const won = side === 'player' ? state.playerWon : state.cpuWon;

  while (hand.length < HAND_SIZE && (pile.length > 0 || won.length > 0)) {
    if (pile.length === 0) {
      // Recycle won pile
      const recycled = shuffle(won.splice(0));
      pile.push(...recycled);
    }
    if (pile.length > 0) {
      hand.push(pile.shift());
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMMENTARY SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function showCommentary(card, isAbility) {
  const overlay = document.getElementById('commentary-overlay');
  const nameEl = document.getElementById('commentary-name');
  const nickEl = document.getElementById('commentary-nickname');
  const abilEl = document.getElementById('commentary-ability-name');

  const color = POS_COLOR[card.position];
  nameEl.textContent = card.name.toUpperCase();
  nameEl.style.color = '#fff';
  nickEl.textContent = `"${card.nickname}"`;
  abilEl.textContent = isAbility ? `‚ö° ${card.ability.name}` : '';

  overlay.classList.add('show');
  screenShake();
  screenFlash('white', 150);

  await delay(1400);
  overlay.classList.remove('show');
  await delay(200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAFT PHASE ‚Äî Pick your starting hand before the game
// Each round shows 4 cards (1 per position). You pick, then CPU picks from the rest.
// 5 rounds total = 5 cards each.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DRAFT_ROUNDS = 5;
const POSITIONS = ['Goalkeeper', 'Defender', 'Midfielder', 'Striker'];

let draftState = {
  rounds: [],         // Pre-generated rounds of 4 cards each
  currentRound: 0,
  roundCards: [],      // Current 4 cards to pick from
  playerPicks: [],
  cpuPicks: [],
  isPlayerTurn: true,
  remaining: [],       // Unused cards
  onComplete: null,
};

function startDraft(fullDeck, onComplete) {
  const shuffled = shuffle(fullDeck);

  // Build rounds: each round has 4 random cards (any position)
  const rounds = [];
  const usedCards = new Set();
  const pool = [...shuffled];
  for (let r = 0; r < DRAFT_ROUNDS; r++) {
    const roundCards = [];
    const available = pool.filter(c => !usedCards.has(c));
    for (let i = 0; i < 4 && available.length > 0; i++) {
      const idx = Math.floor(Math.random() * available.length);
      const card = available.splice(idx, 1)[0];
      roundCards.push(card);
      usedCards.add(card);
    }
    rounds.push(roundCards);
  }

  // Everything not used in draft rounds
  const remaining = shuffled.filter(c => !usedCards.has(c));

  draftState = {
    rounds,
    currentRound: 0,
    roundCards: rounds[0] || [],
    playerPicks: [],
    cpuPicks: [],
    isPlayerTurn: true,
    remaining,
    onComplete,
  };

  // Switch to menu music during draft
  playMenuMusic();

  const screen = document.getElementById('draft-screen');
  screen.style.display = 'flex';
  document.getElementById('exit-btn').style.display = 'block';
  updateDraftInfo();
  renderDraftPool();
  renderDraftSquads();
}

function updateDraftInfo() {
  const el = document.getElementById('draft-info');
  const roundLabel = document.getElementById('draft-round-label');
  const roundNum = draftState.currentRound + 1;
  const totalRounds = DRAFT_ROUNDS;
  roundLabel.textContent = `Round ${roundNum} of ${totalRounds}`;

  if (draftState.isPlayerTurn) {
    el.textContent = `Your pick ‚Äî choose a card`;
    el.style.color = 'var(--gold)';
  } else {
    el.textContent = `CPU is picking...`;
    el.style.color = '#e74c3c';
  }
}

function renderDraftPool() {
  const pool = document.getElementById('draft-pool');
  pool.innerHTML = '';
  draftState.roundCards.forEach((card, i) => {
    const pickedByPlayer = draftState.playerPicks.includes(card);
    const pickedByCpu = draftState.cpuPicks.includes(card);
    const picked = pickedByPlayer || pickedByCpu;
    const div = document.createElement('div');
    div.className = `draft-card ${posClass(card)}${picked ? (pickedByPlayer ? ' picked' : ' cpu-picked') : ''}`;
    const color = POS_COLOR[card.position] || '#888';
    div.innerHTML = `
      <div class="dc-pos" style="color:${color}">${card.position}</div>
      <div style="font-family:'Oswald',sans-serif;font-size:1.1rem;font-weight:700;color:#fff;text-transform:uppercase;text-align:center;line-height:1.2">${card.name}</div>
      <div style="font-size:0.65rem;color:#999;font-style:italic;text-align:center;margin:0.2rem 0;line-height:1.2">${card.nickname || ''}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.3rem 0.8rem;margin-top:0.4rem;font-size:0.75rem;color:#aaa">
        <span>‚ö° Pace <b style="color:#fff">${card.pace}</b></span>
        <span>üéØ Shot <b style="color:#fff">${card.shooting}</b></span>
        <span>üéØ Pass <b style="color:#fff">${card.passing}</b></span>
        <span>üõ° Def <b style="color:#fff">${card.defending}</b></span>
      </div>
      <div style="font-size:0.65rem;color:${color};margin-top:0.3rem;text-align:center" title="${card.ability.desc}">‚ö° ${card.ability.name}</div>`;
    if (!picked && draftState.isPlayerTurn) {
      div.style.cursor = 'pointer';
      div.onclick = () => draftPickCard(i);
    }
    pool.appendChild(div);
  });
}

function renderDraftSquads() {
  const pEl = document.getElementById('draft-player-squad');
  const cEl = document.getElementById('draft-cpu-squad');
  pEl.innerHTML = '';
  cEl.innerHTML = '';

  draftState.playerPicks.forEach(card => {
    const div = document.createElement('div');
    const color = POS_COLOR[card.position] || '#888';
    div.style.cssText = `padding:0.3rem 0.6rem;border:2px solid ${color};border-radius:4px;font-size:0.7rem;color:${color};font-family:'Oswald',sans-serif;text-transform:uppercase;letter-spacing:0.05em`;
    div.textContent = card.name.split(' ').pop();
    pEl.appendChild(div);
  });

  draftState.cpuPicks.forEach(card => {
    const div = document.createElement('div');
    div.style.cssText = `padding:0.3rem 0.6rem;border:2px solid #e74c3c;border-radius:4px;font-size:0.7rem;color:#e74c3c;font-family:'Oswald',sans-serif;text-transform:uppercase;letter-spacing:0.05em`;
    div.textContent = card.name.split(' ').pop();
    cEl.appendChild(div);
  });
}

async function draftPickCard(index) {
  if (!draftState.isPlayerTurn) return;
  const card = draftState.roundCards[index];
  if (draftState.playerPicks.includes(card) || draftState.cpuPicks.includes(card)) return;

  draftState.playerPicks.push(card);
  screenFlash('gold', 150);

  // CPU picks from remaining cards in this round
  draftState.isPlayerTurn = false;
  updateDraftInfo();
  renderDraftPool();
  renderDraftSquads();

  await delay(800);
  cpuDraftPick();
}

async function cpuDraftPick() {
  // CPU picks randomly from remaining cards in this round
  const available = draftState.roundCards.filter(card =>
    !draftState.playerPicks.includes(card) && !draftState.cpuPicks.includes(card)
  );

  if (available.length > 0) {
    const pick = available[Math.floor(Math.random() * available.length)];
    draftState.cpuPicks.push(pick);
    screenFlash('red', 100);
  }

  renderDraftPool();
  renderDraftSquads();

  // Short pause to show CPU's pick, then advance round
  await delay(600);

  draftState.currentRound++;

  // Check if draft is complete
  if (draftState.currentRound >= DRAFT_ROUNDS) {
    return completeDraft();
  }

  // Set up next round
  draftState.roundCards = draftState.rounds[draftState.currentRound];
  draftState.isPlayerTurn = true;
  updateDraftInfo();
  renderDraftPool();
}

function completeDraft() {
  document.getElementById('draft-screen').style.display = 'none';
  screenFlash('gold', 300);
  if (draftState.onComplete) {
    draftState.onComplete(draftState.playerPicks, draftState.cpuPicks, draftState.remaining);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRADE WINDOW ‚Äî Swap a card from hand with won pile after a win
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TRADE_INTERVAL = 5;     // Offer trade every N rounds won
let tradeState = { handIdx: null, wonIdx: null };

function shouldOfferTrade() {
  // Offer a trade every TRADE_INTERVAL player wins, if they have won cards to trade
  return state.roundsWon > 0 && state.roundsWon % TRADE_INTERVAL === 0 && state.playerWon.length > 0 && state.playerHand.length > 0;
}

function showTradeWindow() {
  tradeState = { handIdx: null, wonIdx: null };

  const screen = document.getElementById('trade-screen');
  screen.style.display = 'flex';

  renderTradeCards();
  document.getElementById('trade-confirm-btn').disabled = true;
  document.getElementById('trade-confirm-btn').style.opacity = '0.4';
}

function renderTradeCards() {
  const handEl = document.getElementById('trade-hand');
  const wonEl = document.getElementById('trade-won');
  handEl.innerHTML = '';
  wonEl.innerHTML = '';

  state.playerHand.forEach((card, i) => {
    const div = document.createElement('div');
    const color = POS_COLOR[card.position] || '#888';
    const selected = tradeState.handIdx === i;
    div.style.cssText = `padding:0.35rem 0.6rem;border:1px solid ${selected ? 'var(--gold)' : color};border-radius:3px;font-size:0.6rem;color:${selected ? 'var(--gold)' : color};font-family:'Oswald',sans-serif;text-transform:uppercase;letter-spacing:0.05em;cursor:pointer;background:${selected ? 'rgba(212,175,55,0.1)' : 'transparent'};transition:all 0.2s`;
    div.innerHTML = `${card.name.split(' ').pop()}<br><span style="font-size:0.45rem;color:#666">${card.position}</span>`;
    div.onclick = () => selectTradeHand(i);
    handEl.appendChild(div);
  });

  // Show up to 8 from won pile (most recent)
  const wonSlice = state.playerWon.slice(-8);
  const offset = state.playerWon.length - wonSlice.length;
  wonSlice.forEach((card, i) => {
    const realIdx = offset + i;
    const div = document.createElement('div');
    const color = POS_COLOR[card.position] || '#888';
    const selected = tradeState.wonIdx === realIdx;
    div.style.cssText = `padding:0.35rem 0.6rem;border:1px solid ${selected ? 'var(--gold)' : color};border-radius:3px;font-size:0.6rem;color:${selected ? 'var(--gold)' : color};font-family:'Oswald',sans-serif;text-transform:uppercase;letter-spacing:0.05em;cursor:pointer;background:${selected ? 'rgba(212,175,55,0.1)' : 'transparent'};transition:all 0.2s`;
    div.innerHTML = `${card.name.split(' ').pop()}<br><span style="font-size:0.45rem;color:#666">${card.position} ‚Äî ‚ö°${card.pace} üéØ${card.shooting} üìê${card.passing} üõ°${card.defending}</span>`;
    div.onclick = () => selectTradeWon(realIdx);
    wonEl.appendChild(div);
  });
}

function selectTradeHand(idx) {
  tradeState.handIdx = tradeState.handIdx === idx ? null : idx;
  renderTradeCards();
  updateTradeButton();
}

function selectTradeWon(idx) {
  tradeState.wonIdx = tradeState.wonIdx === idx ? null : idx;
  renderTradeCards();
  updateTradeButton();
}

function updateTradeButton() {
  const btn = document.getElementById('trade-confirm-btn');
  const ready = tradeState.handIdx !== null && tradeState.wonIdx !== null;
  btn.disabled = !ready;
  btn.style.opacity = ready ? '1' : '0.4';
}

function executeTrade() {
  if (tradeState.handIdx === null || tradeState.wonIdx === null) return;

  const handCard = state.playerHand[tradeState.handIdx];
  const wonCard = state.playerWon[tradeState.wonIdx];

  // Swap: hand card goes to won pile, won card goes to hand
  state.playerHand[tradeState.handIdx] = wonCard;
  state.playerWon[tradeState.wonIdx] = handCard;

  document.getElementById('trade-screen').style.display = 'none';
  screenFlash('gold', 200);
  showBanner('üîÑ TRADE COMPLETE', 'ability');
  renderHand();
  setTimeout(() => { hideBanner(); nextRound(); }, 1200);
}

function skipTrade() {
  document.getElementById('trade-screen').style.display = 'none';
  nextRound();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME FLOW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGame() {
  document.getElementById('title-screen').style.display = 'none';
  document.getElementById('game-over').style.display = 'none';
  document.getElementById('leaderboard-screen').style.display = 'none';
  document.getElementById('exit-btn').style.display = 'block';

  // Update scoreboard names
  document.getElementById('p1-name-display').textContent = playerName || 'YOU';
  if (gameMode === 'pvp' && peerConn) {
    sendPeer({ type: 'name', name: playerName });
  } else {
    document.getElementById('p2-name-display').textContent = 'CPU';
    document.getElementById('opponent-label').textContent = 'CPU Card';
  }

  const fullDeck = shuffle(ALL_CARDS.map(c => ({...c, ability: {...c.ability}})));

  // DRAFT PHASE ‚Äî player and CPU pick starting cards
  startDraft(fullDeck, (playerPicks, cpuPicks, remaining) => {
    // Build piles: drafted cards go to hand first, remaining split evenly
    const leftover = shuffle(remaining);
    const half = Math.floor(leftover.length / 2);

    state = {
      playerPile: leftover.slice(0, half),
      cpuPile: leftover.slice(half),
      playerWon: [],
      cpuWon: [],
      playerHand: playerPicks,
      cpuHand: cpuPicks,
      playerCard: null,
      cpuCard: null,
      warPot: [],
      isPlayerTurn: Math.random() > 0.5,
      phase: 'idle',
      abilityUsed: false,
      abilityActive: null,
      cantonaUsed: false,
      roundStats: {},
      comebackPlayer: false,
      comebackCPU: false,
      roundsWon: 0,
      roundsLost: 0,
      roundsDrawn: 0,
      currentStreak: 0,
      bestStreak: 0,
      abilitiesUsed: 0,
      abilitiesRemaining: ABILITY_CAP,
      warsWon: 0,
      pendingScore: null,
      // ‚îÄ‚îÄ NEW ‚îÄ‚îÄ
      roundNumber: 0,
      energy: 1,
      maxEnergy: 5,
      isHighStakes: false,
      highStakesDeclined: false,
      halftimeDone: false,
      halftimeTactic: null,
      streakBonus: 0,
      cpuDifficulty: 0,
      warLevel: 0,
    };

    // Show the game screen
    document.getElementById('game-screen').style.display = 'flex';

    // Switch to gameplay music
    playGameplayMusic();

    renderHand();
    updateCounts();
    updateWarPile();
    updateComeback();

    nextRound();
  });
}

async function nextRound() {
  // Check end conditions
  const pc = totalCards('player');
  const cc = totalCards('cpu');
  if (pc === 0) return endGame(false);
  if (cc === 0) return endGame(true);

  // Increment round counter
  state.roundNumber++;
  state.warLevel = 0;

  // Update CPU difficulty based on round
  updateCPUDifficulty();

  // Update momentum display
  updateMomentum();
  updateEnergyDisplay();

  // Check for halftime (pauses the game)
  const halftimeShown = await showHalftime();
  if (halftimeShown) return; // pickHalftimeTactic will call nextRound

  // Check for high stakes round
  await checkHighStakes();

  // Reset round state
  state.playerCard = null;
  state.cpuCard = null;
  state.abilityUsed = false;
  state.abilityActive = null;
  state.roundStats = {};

  // Draw up hands
  drawToHand('player');
  drawToHand('cpu');

  // Reset battlefield visuals
  document.getElementById('player-card').classList.remove('flipped');
  document.getElementById('cpu-card').classList.remove('flipped');
  document.getElementById('stat-buttons').classList.remove('active');
  document.getElementById('ability-btn').classList.remove('active');

  renderHand();
  updateCounts();
  updateComeback();

  if (state.playerHand.length === 0 && state.cpuHand.length === 0) {
    // Both hands empty and piles empty ‚Äî shouldn't happen, but safety
    return endGame(totalCards('player') >= totalCards('cpu'));
  }

  // Round number display
  const roundLabel = state.isHighStakes ? `‚ö° Round ${state.roundNumber} ‚Äî HIGH STAKES` : `Round ${state.roundNumber}`;

  if (state.isPlayerTurn) {
    state.phase = 'select-card';
    setTurn(`${roundLabel} ‚Äî Pick a card`);
  } else {
    state.phase = 'select-card';
    setTurn(`${roundLabel} ‚Äî CPU is choosing...`);
    await delay(800);
    cpuSelectCard();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAYER: SELECT CARD FROM HAND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function selectCard(index) {
  if (state.phase !== 'select-card' || !state.isPlayerTurn) return;

  state.playerCard = state.playerHand.splice(index, 1)[0];
  renderHand();

  // Apply streak bonus + halftime tactic to player stats
  if (!state.roundStats.player) state.roundStats.player = {};
  const pm = state.roundStats.player;
  applyStreakBonus(state.playerCard, pm);
  applyHalftimeTactic(state.playerCard, pm);

  // Show player card (with bonuses reflected)
  renderCard(state.playerCard, document.getElementById('player-card-front'), Object.keys(pm).length ? pm : undefined);
  document.getElementById('player-card').classList.add('flipped');

  // Play card-specific sound effect
  playCardSound(state.playerCard);

  // Commentary for player card
  await showCommentary(state.playerCard, false);

  // Show stat selection (blind ‚Äî CPU card still hidden)
  state.phase = 'select-stat';
  const hsLabel = state.isHighStakes ? ' ‚ö° HIGH STAKES!' : '';
  setTurn(`Pick a stat ‚Äî opponent card is hidden!${hsLabel}`);
  document.getElementById('stat-buttons').classList.add('active');

  // Show ability button if available
  showAbilityButton();
}

function showAbilityButton() {
  const btn = document.getElementById('ability-btn');
  const card = state.playerCard;
  if (!card || state.abilityUsed) { btn.classList.remove('active'); return; }
  if (card.ability.name === 'Kung Fu Kick' && state.cantonaUsed) { btn.classList.remove('active'); return; }
  if (state.energy <= 0) { btn.classList.remove('active'); return; }

  // In comeback mode, abilities auto-activate (still costs energy)
  if (state.comebackPlayer && state.energy > 0) {
    btn.classList.remove('active');
    activateAbility(true); // auto
    return;
  }

  btn.innerHTML = `<span style="font-size:1.4em">‚ö°</span> ${card.ability.name} <span style="font-size:1.4em">‚ö°</span><br><span style="font-size:0.7em;opacity:0.7;letter-spacing:0.2em">TAP TO DEPLOY ‚Ä¢ ${'‚ö°'.repeat(state.energy)}/${state.maxEnergy} remaining</span>`;
  btn.title = card.ability.desc;
  btn.classList.add('active');

  // Flash the turn indicator to draw attention to the superpower
  const turnEl = document.getElementById('turn-indicator');
  if (turnEl) {
    turnEl.innerHTML = `<span style="animation:spBlink 0.4s ease 8">‚ö° SUPERPOWER READY ‚ö°</span><br><span style="font-size:0.8em">${card.ability.name} ‚Äî tap the big button below!</span>`;
    turnEl.style.color = 'var(--gold)';
    turnEl.style.fontSize = '1.1em';
    setTimeout(() => { turnEl.style.color = ''; turnEl.style.fontSize = ''; }, 3000);
  }

  // Play a short attention sound
  try {
    ensureSfxCtx();
    const now = sfxCtx.currentTime;
    const o = sfxCtx.createOscillator(); o.type = 'triangle';
    o.frequency.setValueAtTime(880, now); o.frequency.linearRampToValueAtTime(1320, now + 0.15);
    const g = sfxCtx.createGain(); g.gain.setValueAtTime(0.08, now); g.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
    o.connect(g); g.connect(sfxGain); o.start(now); o.stop(now + 0.3);
  } catch(e) {}

  // One-time superpower tutorial
  if (!localStorage.getItem('gaffer26-tutorial-ability')) {
    localStorage.setItem('gaffer26-tutorial-ability', '1');
    showAbilityTutorial(card);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAYER: PICK STAT (BLIND)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function pickStat(stat) {
  if (state.phase !== 'select-stat') return;
  state.phase = 'reveal';
  document.getElementById('stat-buttons').classList.remove('active');
  document.getElementById('ability-btn').classList.remove('active');

  // CPU selects card from hand
  cpuPlayCard();

  // Reveal CPU card with commentary
  renderCard(state.cpuCard, document.getElementById('cpu-card-front'), state.roundStats.cpu);
  document.getElementById('cpu-card').classList.add('flipped');
  playCardSound(state.cpuCard);

  await showCommentary(state.cpuCard, false);

  // CPU might use ability (comeback or random)
  if (state.comebackCPU || Math.random() < 0.3) {
    await applyCPUAbility();
  }

  // Now resolve
  await resolveRound(stat);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CPU TURN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function cpuSelectCard() {
  if (state.cpuHand.length === 0) {
    drawToHand('cpu');
    if (state.cpuHand.length === 0) return endGame(true);
  }

  // AI: pick card using progressive difficulty
  let pick = cpuPickBestCard();

  state.cpuCard = state.cpuHand.splice(pick, 1)[0];

  // Show CPU card face-down first, then flip
  document.getElementById('cpu-card').classList.remove('flipped');
  await delay(400);

  renderCard(state.cpuCard, document.getElementById('cpu-card-front'));
  document.getElementById('cpu-card').classList.add('flipped');
  playCardSound(state.cpuCard);
  await showCommentary(state.cpuCard, false);

  // CPU might use ability
  if (state.comebackCPU || Math.random() < 0.3) {
    await applyCPUAbility();
  }

  // CPU picks stat using progressive difficulty
  await delay(500);
  let bestStat = cpuPickBestStat();

  setTurn(`CPU chose ${bestStat.toUpperCase()} ‚Äî pick your card!`);

  // Now player must pick a card from hand, knowing the stat
  state.phase = 'select-card';
  state.cpuChosenStat = bestStat;

  // Wait for player to select card ‚Äî the pickStat flow changes
  // When it's CPU turn, player picks card, then auto-resolves with CPU's stat
}

// Overload: when CPU already picked stat, clicking a hand card resolves
async function selectCardForCPUTurn(index) {
  state.playerCard = state.playerHand.splice(index, 1)[0];
  renderHand();

  // Apply streak bonus + halftime tactic
  if (!state.roundStats.player) state.roundStats.player = {};
  const pm = state.roundStats.player;
  applyStreakBonus(state.playerCard, pm);
  applyHalftimeTactic(state.playerCard, pm);

  renderCard(state.playerCard, document.getElementById('player-card-front'), Object.keys(pm).length ? pm : undefined);
  document.getElementById('player-card').classList.add('flipped');
  playCardSound(state.playerCard);
  await showCommentary(state.playerCard, false);

  // Show ability button
  if (!state.abilityUsed) {
    if (state.comebackPlayer) {
      await activateAbility(true);
    } else {
      // Brief window for ability
      const card = state.playerCard;
      if (card.ability.name !== 'Kung Fu Kick' || !state.cantonaUsed) {
        const btn = document.getElementById('ability-btn');
        btn.textContent = `‚ö° ${card.ability.name} ‚Äî TAP TO DEPLOY`;
        btn.title = card.ability.desc;
        btn.classList.add('active');
        state.phase = 'ability-window';

        // Auto-continue after 3 seconds if no ability used
        state._abilityTimer = setTimeout(async () => {
          if (state.phase === 'ability-window') {
            document.getElementById('ability-btn').classList.remove('active');
            state.phase = 'reveal';
            await resolveRound(state.cpuChosenStat);
          }
        }, 3000);
        return;
      }
    }
  }

  state.phase = 'reveal';
  await resolveRound(state.cpuChosenStat);
}

// Patch selectCard to handle both turns
const _origSelectCard = selectCard;
selectCard = async function(index) {
  if (state.phase === 'select-card' && !state.isPlayerTurn) {
    return selectCardForCPUTurn(index);
  }
  return _origSelectCard(index);
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CPU PLAYS A CARD (for player's turn)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cpuPlayCard() {
  if (state.cpuCard) return; // already played
  if (state.cpuHand.length === 0) {
    drawToHand('cpu');
  }
  if (state.cpuHand.length === 0) return;

  // CPU picks randomly (they don't know what stat was chosen yet)
  const pick = Math.floor(Math.random() * state.cpuHand.length);
  state.cpuCard = state.cpuHand.splice(pick, 1)[0];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ABILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function activateAbility(auto = false) {
  if (state.abilityUsed || !state.playerCard) return;
  if (state.energy <= 0) return;
  const card = state.playerCard;
  const ab = card.ability;

  if (ab.name === 'Kung Fu Kick' && state.cantonaUsed) return;

  // Clear ability timer if in ability-window phase
  if (state._abilityTimer) {
    clearTimeout(state._abilityTimer);
    state._abilityTimer = null;
  }

  state.abilityUsed = true;
  state.abilitiesUsed++;
  spendEnergy();
  document.getElementById('ability-btn').classList.remove('active');

  // Superpower GIF flash effect
  showSuperpowerFlash(card);

  screenFlash('gold', 300);

  if (!state.roundStats.player) state.roundStats.player = {};
  if (!state.roundStats.cpu) state.roundStats.cpu = {};
  const pm = state.roundStats.player;
  const cm = state.roundStats.cpu;
  const p = state.playerCard;

  // Apply ability effects
  switch (ab.name) {
    case 'Star-Fish':
      // Reduce opponent's highest stat by 20
      if (state.cpuCard) {
        let best = 'pace', bv = 0;
        STATS.forEach(s => { if (state.cpuCard[s] > bv) { bv = state.cpuCard[s]; best = s; } });
        cm[best] = (cm[best] || state.cpuCard[best]) - 20;
      }
      break;

    case 'The Helmet':
      state.abilityActive = { type: 'keep-on-loss' };
      break;

    case 'Unhinged':
      if (state.cpuCard) {
        STATS.forEach(s => { cm[s] = (cm[s] || state.cpuCard[s]) - 10; });
      }
      break;

    case 'The Ponytail':
      { let vals = STATS.map(s => pm[s] || p[s]);
        let hi = Math.max(...vals), lo = Math.min(...vals);
        let hiS = STATS[vals.indexOf(hi)], loS = STATS[vals.indexOf(lo)];
        pm[hiS] = lo; pm[loS] = hi; }
      break;

    case 'Calamity':
      STATS.forEach(s => {
        pm[s] = 30 + Math.floor(Math.random() * 60);
        if (state.cpuCard) cm[s] = 30 + Math.floor(Math.random() * 60);
      });
      break;

    case 'Wobbly Legs':
      state.abilityActive = { type: 'cpu-worst-stat' };
      break;

    case 'Long Bomb':
      pm.shooting = 92;
      break;

    case 'Name Power':
      { let best = 'pace', bv = 0;
        STATS.forEach(s => { if ((pm[s] || p[s]) > bv) { bv = pm[s] || p[s]; best = s; } });
        pm[best] = (pm[best] || p[best]) + 15; }
      break;

    case 'Goal Kick':
      pm.shooting = 85;
      break;

    case 'Twitter Rant':
      state.abilityActive = { type: 'reveal-cpu' };
      break;

    case 'Chaos Merchant':
      state.abilityActive = { type: 'coin-flip', result: Math.random() > 0.5 };
      break;

    case 'The Fumble':
      state.abilityActive = { type: 'fumble-debuff' };
      break;

    case 'Through the Legs':
      state.abilityActive = { type: 'double-reward' };
      break;

    case 'Rolls Royce':
      STATS.forEach(s => { pm[s] = (pm[s] || p[s]) + 8; });
      break;

    case 'Full Kit':
      state.abilityActive = { type: 'pick-both-stats' };
      break;

    case 'Air Rifle':
      pm.pace = (pm.pace || p.pace) + 15;
      state.abilityActive = { type: 'discard-on-win' };
      break;

    case 'Zero Fear':
      pm.defending = 99;
      break;

    case 'Psycho':
      pm.shooting = (pm.shooting || p.shooting) + 20;
      pm.defending = (pm.defending || p.defending) - 15;
      break;

    case 'The Grab':
      if (state.cpuCard) {
        let best = 'pace', bv = 0;
        STATS.forEach(s => { if ((cm[s] || state.cpuCard[s]) > bv) { bv = cm[s] || state.cpuCard[s]; best = s; } });
        cm[best] = (cm[best] || state.cpuCard[best]) - 25;
      }
      break;

    case 'Pundit Mode':
      state.abilityActive = { type: 'reveal-cpu' };
      break;

    case 'Raw Chicken':
      state.abilityActive = { type: 'keep-on-loss' };
      break;

    case 'Colossus':
      state.abilityActive = { type: 'win-if-close', threshold: 15 };
      break;

    case 'The Stare':
      if (state.cpuCard) {
        STATS.forEach(s => { cm[s] = (cm[s] || state.cpuCard[s]) - 12; });
      }
      break;

    case 'The Snarl':
      state.abilityActive = { type: 'ties-win' };
      break;

    case 'Big Laugh':
      pm.pace = 95;
      break;

    case 'Walking Disaster':
      state.abilityActive = { type: 'own-goal-steal' };
      break;

    case 'Dentist\'s Chair':
      STATS.forEach(s => { pm[s] = (pm[s] || p[s]) + 10; });
      state.abilityActive = { type: 'extra-loss-penalty' };
      break;

    case 'Free Kick':
      pm.shooting = 99;
      pm.passing = 99;
      break;

    case 'The Slip':
      state.abilityActive = { type: 'slip', wins: Math.random() < 0.9 };
      break;

    case 'Ghost Goal':
      pm.shooting = 95;
      state.abilityActive = { type: 'ghost-goal' };
      break;

    case 'Red Mist':
      state.abilityActive = { type: 'red-mist' };
      break;

    case 'Tunnel Wars':
      state.abilityActive = { type: 'force-stat', stat: 'defending' };
      break;

    case 'Tree Shot':
      pm.passing = 99;
      if (state.cpuCard) {
        const rs = STATS[Math.floor(Math.random() * STATS.length)];
        cm[rs] = (cm[rs] || state.cpuCard[rs]) - 20;
      }
      break;

    case 'Loyalty':
      if (state.isPlayerTurn) {
        STATS.forEach(s => { pm[s] = (pm[s] || p[s]) + 15; });
      }
      break;

    case 'Tiny Shin Pads':
      state.abilityActive = { type: 'draw-if-close', threshold: 10 };
      break;

    case 'Cold Palmer':
      state.abilityActive = { type: 'immune' };
      break;

    case 'Cigar Burn':
      if (Math.random() < 0.25) {
        state.abilityActive = { type: 'sent-off' };
      } else if (state.cpuCard) {
        let best = 'pace', bv = 0;
        STATS.forEach(s => { if ((cm[s] || state.cpuCard[s]) > bv) { bv = cm[s] || state.cpuCard[s]; best = s; } });
        cm[best] = (cm[best] || state.cpuCard[best]) - 30;
      }
      break;

    case 'Friendly Fire':
      if (state.cpuCard) {
        const rs = STATS[Math.floor(Math.random() * STATS.length)];
        const pv = pm[rs] || p[rs];
        const cv = cm[rs] || state.cpuCard[rs];
        pm[rs] = cv;
        cm[rs] = pv;
      }
      break;

    case 'Glass Legs':
      pm.pace = 95;
      ['shooting','passing','defending'].forEach(s => { pm[s] = (pm[s] || p[s]) - 10; });
      break;

    case 'Va Va Voom':
      STATS.forEach(s => { pm[s] = (pm[s] || p[s]) + 5; });
      state.abilityActive = { type: 'reveal-cpu' };
      break;

    case 'The Celebration':
      pm.shooting = 99;
      state.abilityActive = { type: 'extra-win-card' };
      break;

    case 'Overhead Kick':
      state.abilityActive = { type: 'overhead-kick' };
      break;

    case 'Kung Fu Kick':
      state.cantonaUsed = true;
      state.abilityActive = { type: 'cantona-replay' };
      break;

    case 'AGUEROOOO':
      state.abilityActive = { type: 'aguero', chance: 0.4 };
      break;

    case 'SIUUU':
      STATS.forEach(s => { pm[s] = 90; });
      break;

    case 'Viking Mode':
      { let best = 'pace', bv = 0;
        STATS.forEach(s => { if ((pm[s] || p[s]) > bv) { bv = pm[s] || p[s]; best = s; } });
        pm[best] = (pm[best] || p[best]) + 15; }
      break;

    case 'Cut Inside':
      { let pa = pm.pace || p.pace, sh = pm.shooting || p.shooting;
        pm.pace = sh; pm.shooting = pa;
        let higher = pm.pace > pm.shooting ? 'pace' : 'shooting';
        pm[higher] += 10; }
      break;

    case 'Chat Shit':
      pm.pace = 99;
      if (state.cpuCard) {
        STATS.forEach(s => { cm[s] = (cm[s] || state.cpuCard[s]) - 8; });
      }
      break;

    case 'The Bite':
      state.abilityActive = { type: 'steal-from-won' };
      break;

    case 'The Volley':
      pm.shooting = 98;
      pm.defending = 5;
      break;

    case 'Why Always Me':
      state.abilityActive = { type: 'random-stat' };
      break;

    case 'The Con':
      state.abilityActive = { type: 'the-con' };
      break;
  }

  // Re-render cards with mods
  if (state.playerCard) renderCard(state.playerCard, document.getElementById('player-card-front'), pm);
  if (state.cpuCard && document.getElementById('cpu-card').classList.contains('flipped')) {
    renderCard(state.cpuCard, document.getElementById('cpu-card-front'), cm);
  }

  // If in ability-window (CPU turn), proceed to resolve
  if (state.phase === 'ability-window') {
    state.phase = 'reveal';
    resolveRound(state.cpuChosenStat);
  }
}

// CPU ability application (simplified)
async function applyCPUAbility() {
  if (!state.cpuCard) return;
  const ab = state.cpuCard.ability;
  if (!state.roundStats.cpu) state.roundStats.cpu = {};
  const cm = state.roundStats.cpu;
  const c = state.cpuCard;

  screenFlash('red', 200);
  setTurn(`CPU activates ‚ö° ${ab.name}!`);
  await delay(800);

  // Apply a subset of abilities for CPU
  switch (ab.name) {
    case 'Rolls Royce':
      STATS.forEach(s => { cm[s] = (cm[s] || c[s]) + 8; }); break;
    case 'Unhinged':
      if (state.playerCard) {
        if (!state.roundStats.player) state.roundStats.player = {};
        const pm = state.roundStats.player;
        if (!state.abilityActive || state.abilityActive.type !== 'immune') {
          STATS.forEach(s => { pm[s] = (pm[s] || state.playerCard[s]) - 10; });
        }
      }
      break;
    case 'Zero Fear':
      cm.defending = 99; break;
    case 'Free Kick':
      cm.shooting = 99; cm.passing = 99; break;
    case 'SIUUU':
      STATS.forEach(s => { cm[s] = 90; }); break;
    case 'Viking Mode':
      { let best = 'pace', bv = 0;
        STATS.forEach(s => { if ((cm[s] || c[s]) > bv) { bv = cm[s] || c[s]; best = s; } });
        cm[best] = (cm[best] || c[best]) + 15; }
      break;
    case 'The Grab':
      if (state.playerCard && (!state.abilityActive || state.abilityActive.type !== 'immune')) {
        if (!state.roundStats.player) state.roundStats.player = {};
        const pm = state.roundStats.player;
        let best = 'pace', bv = 0;
        STATS.forEach(s => { if ((pm[s] || state.playerCard[s]) > bv) { bv = pm[s] || state.playerCard[s]; best = s; } });
        pm[best] = (pm[best] || state.playerCard[best]) - 25;
      }
      break;
    case 'The Stare':
      if (state.playerCard && (!state.abilityActive || state.abilityActive.type !== 'immune')) {
        if (!state.roundStats.player) state.roundStats.player = {};
        const pm = state.roundStats.player;
        STATS.forEach(s => { pm[s] = (pm[s] || state.playerCard[s]) - 12; });
      }
      break;
    case 'Chat Shit':
      cm.pace = 99;
      if (state.playerCard && (!state.abilityActive || state.abilityActive.type !== 'immune')) {
        if (!state.roundStats.player) state.roundStats.player = {};
        STATS.forEach(s => { state.roundStats.player[s] = (state.roundStats.player[s] || state.playerCard[s]) - 8; });
      }
      break;
    case 'Big Laugh':
      cm.pace = 95; break;
    case 'Psycho':
      cm.shooting = (cm.shooting || c.shooting) + 20;
      cm.defending = (cm.defending || c.defending) - 15;
      break;
    case 'Long Bomb':
      cm.shooting = 92; break;
    // Other CPU abilities just get a visual flash but no mechanical effect (keeps it fair)
  }

  // Re-render
  if (state.cpuCard) renderCard(state.cpuCard, document.getElementById('cpu-card-front'), cm);
  if (state.playerCard) renderCard(state.playerCard, document.getElementById('player-card-front'), state.roundStats.player);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESOLVE ROUND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function resolveRound(stat) {
  if (!state.playerCard || !state.cpuCard) return;
  state.phase = 'resolve';

  const pm = state.roundStats.player || {};
  const cm = state.roundStats.cpu || {};
  const aa = state.abilityActive;

  // Handle special abilities that override stat
  if (aa && aa.type === 'force-stat') stat = aa.stat;
  if (aa && aa.type === 'random-stat') stat = STATS[Math.floor(Math.random() * STATS.length)];

  let pVal = getStat(state.playerCard, stat, pm);
  let cVal = getStat(state.cpuCard, stat, cm);

  // Red Mist: double player's stat
  if (aa && aa.type === 'red-mist') {
    pVal = Math.min(99, pVal * 2);
  }

  // Handle The Con (Ali Dia)
  if (aa && aa.type === 'the-con') {
    pVal = 99;
    // CPU decides to call bluff: 50% chance
    const cpuCalls = Math.random() < 0.5;
    if (cpuCalls) {
      showBanner('CALLED YOUR BLUFF!', 'lose');
      screenShake();
      await delay(1000);
      // Auto-lose
      state.roundsLost++; state.currentStreak = 0;
      awardCards('cpu', [state.playerCard, state.cpuCard, ...state.warPot]);
      state.warPot = [];
      state.isPlayerTurn = false;
      state.playerCard = null;
      state.cpuCard = null;
      updateCounts();
      updateWarPile();
      await delay(800);
      return nextRound();
    } else {
      showBanner('THE CON WORKS!', 'ability');
      screenFlash('gold', 300);
      await delay(1000);
      state.roundsWon++; state.currentStreak++;
      if (state.currentStreak > state.bestStreak) state.bestStreak = state.currentStreak;
      awardCards('player', [state.playerCard, state.cpuCard, ...state.warPot]);
      state.warPot = [];
      state.isPlayerTurn = true;
      state.playerCard = null;
      state.cpuCard = null;
      updateCounts();
      updateWarPile();
      await delay(800);
      return nextRound();
    }
  }

  // Handle Coin Flip (Gomes)
  if (aa && aa.type === 'coin-flip') {
    if (aa.result) {
      showBanner('HEADS ‚Äî YOU WIN!', 'win');
      screenFlash('gold', 300);
      await delay(1000);
      state.roundsWon++; state.currentStreak++;
      if (state.currentStreak > state.bestStreak) state.bestStreak = state.currentStreak;
      awardCards('player', [state.playerCard, state.cpuCard, ...state.warPot]);
    } else {
      showBanner('TAILS ‚Äî YOU LOSE!', 'lose');
      screenFlash('red', 300);
      await delay(1000);
      state.roundsLost++; state.currentStreak = 0;
      awardCards('cpu', [state.playerCard, state.cpuCard, ...state.warPot]);
    }
    state.warPot = [];
    state.isPlayerTurn = aa.result;
    state.playerCard = null;
    state.cpuCard = null;
    updateCounts(); updateWarPile();
    await delay(800);
    return nextRound();
  }

  // Handle Sent Off (Barton)
  if (aa && aa.type === 'sent-off') {
    showBanner('RED CARD!', 'lose');
    screenShake(); screenFlash('red', 400);
    await delay(1000);
    state.roundsLost++; state.currentStreak = 0;
    awardCards('cpu', [state.playerCard, state.cpuCard, ...state.warPot]);
    state.warPot = [];
    state.isPlayerTurn = false;
    state.playerCard = null;
    state.cpuCard = null;
    updateCounts(); updateWarPile();
    await delay(800);
    return nextRound();
  }

  // Handle Walking Disaster (Bramble)
  if (aa && aa.type === 'own-goal-steal') {
    showBanner('OWN GOAL!', 'lose');
    screenShake();
    await delay(800);
    // Lose the round
    state.roundsLost++; state.currentStreak = 0;
    awardCards('cpu', [state.playerCard, state.cpuCard, ...state.warPot]);
    state.warPot = [];
    // But steal 2 from CPU won pile
    let stolen = 0;
    for (let i = 0; i < 2 && state.cpuWon.length > 0; i++) {
      state.playerWon.push(state.cpuWon.pop());
      stolen++;
    }
    if (stolen > 0) {
      showBanner(`STOLE ${stolen} CARDS!`, 'ability');
      await delay(800);
    }
    state.isPlayerTurn = false;
    state.playerCard = null;
    state.cpuCard = null;
    updateCounts(); updateWarPile();
    await delay(500);
    return nextRound();
  }

  // Handle The Bite (Su√°rez)
  if (aa && aa.type === 'steal-from-won') {
    if (state.cpuWon.length > 0) {
      const stolen = state.cpuWon.pop();
      state.playerWon.push(stolen);
      showBanner(`BITTEN! Stole ${stolen.name}`, 'ability');
      screenFlash('gold', 300);
      await delay(1000);
    }
    // Round still plays normally after steal
  }

  // Handle The Slip (Gerrard)
  if (aa && aa.type === 'slip') {
    if (aa.wins) {
      showBanner('HEROIC!', 'win');
      screenFlash('gold', 300);
      await delay(1000);
      state.roundsWon++; state.currentStreak++;
      if (state.currentStreak > state.bestStreak) state.bestStreak = state.currentStreak;
      awardCards('player', [state.playerCard, state.cpuCard, ...state.warPot]);
      state.warPot = [];
      state.isPlayerTurn = true;
      state.playerCard = null;
      state.cpuCard = null;
      updateCounts(); updateWarPile();
      await delay(800);
      return nextRound();
    } else {
      showBanner('HE SLIPPED!', 'lose');
      screenShake(); screenFlash('red', 400);
      await delay(1000);
      state.roundsLost++; state.currentStreak = 0;
      awardCards('cpu', [state.playerCard, state.cpuCard, ...state.warPot]);
      state.warPot = [];
      state.isPlayerTurn = false;
      state.playerCard = null;
      state.cpuCard = null;
      updateCounts(); updateWarPile();
      await delay(800);
      return nextRound();
    }
  }

  // Handle Overhead Kick (Rooney)
  if (aa && aa.type === 'overhead-kick') {
    const pShoot = getStat(state.playerCard, 'shooting', pm);
    const cDef = getStat(state.cpuCard, 'defending', cm);
    if (pShoot > cDef) {
      showBanner('OVERHEAD KICK!', 'win');
      screenShake(); screenFlash('gold', 500);
      await delay(1000);
      state.roundsWon++; state.currentStreak++;
      if (state.currentStreak > state.bestStreak) state.bestStreak = state.currentStreak;
      awardCards('player', [state.playerCard, state.cpuCard, ...state.warPot]);
      state.warPot = [];
      state.isPlayerTurn = true;
      state.playerCard = null;
      state.cpuCard = null;
      updateCounts(); updateWarPile();
      await delay(800);
      return nextRound();
    }
    // Otherwise, fall through to normal comparison
  }

  // Handle AGUEROOOO
  if (aa && aa.type === 'aguero' && pVal < cVal) {
    if (Math.random() < aa.chance) {
      showBanner('AGUEROOOO!', 'win');
      screenShake(); screenFlash('gold', 500);
      await delay(1200);
      state.roundsWon++; state.currentStreak++;
      if (state.currentStreak > state.bestStreak) state.bestStreak = state.currentStreak;
      awardCards('player', [state.playerCard, state.cpuCard, ...state.warPot]);
      state.warPot = [];
      state.isPlayerTurn = true;
      state.playerCard = null;
      state.cpuCard = null;
      updateCounts(); updateWarPile();
      await delay(800);
      return nextRound();
    }
  }

  // Highlight stats
  highlightStat('player-card-front', stat, pVal > cVal ? 'won' : pVal < cVal ? 'lost' : 'won');
  highlightStat('cpu-card-front', stat, cVal > pVal ? 'won' : cVal < pVal ? 'lost' : 'won');

  // Determine result
  let playerWins = pVal > cVal;
  let cpuWins = cVal > pVal;
  let isDraw = pVal === cVal;

  // Colossus: win if close
  if (aa && aa.type === 'win-if-close' && cpuWins && (cVal - pVal) <= aa.threshold) {
    playerWins = true; cpuWins = false; isDraw = false;
    showBanner('COLOSSUS!', 'ability');
    screenFlash('gold', 200);
    await delay(600);
  }

  // Draw-if-close (Grealish)
  if (aa && aa.type === 'draw-if-close' && cpuWins && (cVal - pVal) <= aa.threshold) {
    playerWins = false; cpuWins = false; isDraw = true;
    showBanner('DREW THE FOUL!', 'ability');
    await delay(600);
  }

  // Ties-win (Keown)
  if (aa && aa.type === 'ties-win' && isDraw) {
    playerWins = true; isDraw = false;
  }

  // Ghost Goal (Lampard): loss becomes draw
  if (aa && aa.type === 'ghost-goal' && cpuWins) {
    playerWins = false; cpuWins = false; isDraw = true;
    showBanner("DID IT CROSS THE LINE?", 'draw');
    await delay(600);
  }

  // Check for WAR (close call)
  const diff = Math.abs(pVal - cVal);
  if (isDraw || (diff <= WAR_THRESHOLD && diff > 0 && !playerWins && !cpuWins)) {
    // Actually, war on true ties or if diff <= threshold AND it was a draw
  }
  // Simpler: war on ties
  if (isDraw) {
    state.roundsDrawn++;
    state.currentStreak = 0;
    await triggerWar(stat);
    return;
  }

  // Normal resolution
  const banner = document.getElementById('result-banner');
  if (playerWins) {
    const allCards = [state.playerCard, state.cpuCard, ...state.warPot];

    // HIGH STAKES: win extra cards from CPU won pile
    if (state.isHighStakes) {
      const bonus = Math.min(2, state.cpuWon.length);
      for (let i = 0; i < bonus; i++) allCards.push(state.cpuWon.pop());
    }

    awardCards('player', allCards);
    state.warPot = [];
    state.isPlayerTurn = true;
    state.roundsWon++;
    state.currentStreak++;
    if (state.currentStreak > state.bestStreak) state.bestStreak = state.currentStreak;

    // Energy reward: +1 on win
    gainEnergy(1);

    // Extra card rewards
    if (aa && aa.type === 'extra-win-card' && state.cpuWon.length > 0) {
      state.playerWon.push(state.cpuWon.pop());
    }
    if (aa && aa.type === 'double-reward') {
      for (let i = 0; i < 2 && state.cpuWon.length > 0; i++) {
        state.playerWon.push(state.cpuWon.pop());
      }
    }
    if (aa && aa.type === 'discard-on-win' && state.cpuHand.length > 0) {
      state.cpuPile.push(state.cpuHand.pop()); // just move to back of pile
    }

    const hsTag = state.isHighStakes ? '‚ö° ' : '';
    showBanner(`${hsTag}YOU WIN!`, 'win');
    screenFlash('gold', 200);
  } else {
    const allCards = [state.playerCard, state.cpuCard, ...state.warPot];

    // HIGH STAKES: lose extra cards from player won pile
    if (state.isHighStakes) {
      const penalty = Math.min(2, state.playerWon.length);
      for (let i = 0; i < penalty; i++) allCards.push(state.playerWon.pop());
    }

    awardCards('cpu', allCards);
    state.warPot = [];
    state.isPlayerTurn = false;
    state.roundsLost++;
    state.currentStreak = 0;

    // Red Mist penalty
    if (aa && aa.type === 'red-mist' && state.playerWon.length > 0) {
      state.cpuWon.push(state.playerWon.pop());
    }
    // Extra loss penalty (Gascoigne)
    if (aa && aa.type === 'extra-loss-penalty' && state.playerWon.length > 0) {
      state.cpuWon.push(state.playerWon.pop());
    }

    // Cantona replay
    if (aa && aa.type === 'cantona-replay') {
      showBanner('KUNG FU KICK! REPLAY!', 'ability');
      screenShake(); screenFlash('gold', 400);
      await delay(1200);
      // Return player card to hand, discard cpu card, replay
      state.playerHand.push(state.playerCard);
      state.cpuPile.push(state.cpuCard);
      state.playerCard = null;
      state.cpuCard = null;
      state.isPlayerTurn = true;
      updateCounts(); updateWarPile();
      await delay(500);
      return nextRound();
    }

    // Keep on loss (ƒåech, Evra)
    if (aa && aa.type === 'keep-on-loss') {
      // Player keeps their card
      state.playerWon.push(state.playerCard);
      showBanner('SAVED!', 'ability');
      screenFlash('gold', 200);
    } else {
      showBanner('CPU WINS', 'lose');
      screenFlash('red', 200);
    }
  }

  state.playerCard = null;
  state.cpuCard = null;
  updateCounts();
  updateWarPile();

  await delay(1800);
  hideBanner();
  await delay(400);

  // Offer trade window after player wins (every TRADE_INTERVAL wins)
  if (playerWins && shouldOfferTrade()) {
    showTradeWindow();
    return; // Trade window calls nextRound when done
  }

  nextRound();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WAR MECHANIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function triggerWar(stat) {
  // Intense music during war
  playIntenseMusic();

  state.warLevel++;
  const warLabels = ['‚öîÔ∏è WAR! ‚öîÔ∏è', '‚öîÔ∏è‚öîÔ∏è DOUBLE WAR! ‚öîÔ∏è‚öîÔ∏è', 'üî•‚öîÔ∏è TOTAL WAR! ‚öîÔ∏èüî•'];
  const warLabel = warLabels[Math.min(state.warLevel - 1, warLabels.length - 1)];
  showBanner(warLabel, 'war');
  screenShake();
  screenFlash('red', 300 + state.warLevel * 100);
  await delay(1500);
  hideBanner();

  // Put current cards into war pot
  state.warPot.push(state.playerCard, state.cpuCard);
  state.playerCard = null;
  state.cpuCard = null;

  // WAR ESCALATION: at level 2+, each side antes extra cards from pile
  if (state.warLevel >= 2) {
    const anteCount = Math.min(state.warLevel - 1, 2); // 1 extra at level 2, 2 extra at level 3+
    for (let i = 0; i < anteCount; i++) {
      if (state.playerPile.length > 0) state.warPot.push(state.playerPile.shift());
      if (state.cpuPile.length > 0) state.warPot.push(state.cpuPile.shift());
    }
  }
  updateWarPile();

  await delay(500);

  // Each player flips from pile
  drawToHand('player');
  drawToHand('cpu');

  if (state.playerHand.length === 0 || state.cpuHand.length === 0) {
    // Can't continue war ‚Äî give pot to whoever has cards
    if (state.playerHand.length > 0) {
      awardCards('player', state.warPot);
    } else {
      awardCards('cpu', state.warPot);
    }
    state.warPot = [];
    updateCounts(); updateWarPile();
    return nextRound();
  }

  // Auto-flip top card from each hand
  state.playerCard = state.playerHand.shift();
  state.cpuCard = state.cpuHand.shift();

  renderCard(state.playerCard, document.getElementById('player-card-front'));
  renderCard(state.cpuCard, document.getElementById('cpu-card-front'));
  document.getElementById('player-card').classList.remove('flipped');
  document.getElementById('cpu-card').classList.remove('flipped');
  await delay(300);
  document.getElementById('player-card').classList.add('flipped');
  await delay(300);
  document.getElementById('cpu-card').classList.add('flipped');

  await showCommentary(state.playerCard, false);
  await showCommentary(state.cpuCard, false);

  renderHand();

  await delay(500);

  // Compare same stat
  const pVal = state.playerCard[stat];
  const cVal = state.cpuCard[stat];

  highlightStat('player-card-front', stat, pVal >= cVal ? 'won' : 'lost');
  highlightStat('cpu-card-front', stat, cVal >= pVal ? 'won' : 'lost');

  if (pVal === cVal) {
    // Chain war!
    await delay(800);
    return triggerWar(stat);
  }

  const allCards = [state.playerCard, state.cpuCard, ...state.warPot];
  if (pVal > cVal) {
    awardCards('player', allCards);
    state.isPlayerTurn = true;
    state.roundsWon++; state.warsWon++;
    state.currentStreak++;
    if (state.currentStreak > state.bestStreak) state.bestStreak = state.currentStreak;
    // War wins give +2 energy (big reward for high-risk)
    gainEnergy(2);
    const warWinLabel = state.warLevel >= 3 ? 'üî• TOTAL WAR WON!' : state.warLevel >= 2 ? 'DOUBLE WAR WON!' : 'WAR WON!';
    showBanner(warWinLabel, 'win');
    screenFlash('gold', 300);
  } else {
    awardCards('cpu', allCards);
    state.isPlayerTurn = false;
    state.roundsLost++;
    state.currentStreak = 0;
    const warLoseLabel = state.warLevel >= 3 ? 'üî• TOTAL WAR LOST' : state.warLevel >= 2 ? 'DOUBLE WAR LOST' : 'WAR LOST';
    showBanner(warLoseLabel, 'lose');
    screenFlash('red', 200);
  }

  state.warPot = [];
  state.playerCard = null;
  state.cpuCard = null;
  updateCounts();
  updateWarPile();

  // Return to gameplay music after war resolves
  playGameplayMusic();

  await delay(1800);
  hideBanner();
  await delay(400);
  nextRound();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function awardCards(side, cards) {
  const pile = side === 'player' ? state.playerWon : state.cpuWon;
  cards.forEach(c => { if (c) pile.push(c); });
}

function showBanner(text, type) {
  const b = document.getElementById('result-banner');
  b.textContent = text;
  b.className = `result-banner show ${type}`;
}

function hideBanner() {
  document.getElementById('result-banner').classList.remove('show');
}

function highlightStat(frontId, stat, result) {
  const front = document.getElementById(frontId);
  if (!front) return;
  const rows = front.querySelectorAll('.stat-row');
  rows.forEach(row => {
    if (row.dataset.stat === stat) {
      row.classList.add(result);
    }
  });
}

function calcScore(won) {
  if (!won) return Math.max(0, state.roundsWon * 10 + state.bestStreak * 5 + state.warsWon * 15);
  const totalRounds = state.roundsWon + state.roundsLost + state.roundsDrawn;
  const efficiency = totalRounds > 0 ? Math.round((state.roundsWon / totalRounds) * 100) : 0;
  const speedBonus = Math.max(0, 200 - totalRounds * 5); // bonus for fast wins
  return 1000 + (state.bestStreak * 50) + (efficiency * 5) + (state.warsWon * 40) + (state.abilitiesUsed * 10) + speedBonus - (totalRounds * 2);
}

function endGame(playerWon) {
  state.phase = 'gameover';
  document.getElementById('exit-btn').style.display = 'none';
  const goEl = document.getElementById('game-over');
  const title = document.getElementById('go-title');
  const sub = document.getElementById('go-sub');
  const statsEl = document.getElementById('go-stats');
  const scoreEl = document.getElementById('go-score');
  const nameRow = document.getElementById('go-name-row');
  const savedMsg = document.getElementById('go-saved-msg');

  const totalRounds = state.roundsWon + state.roundsLost + state.roundsDrawn;
  const score = calcScore(playerWon);

  // Play victory or defeat music
  if (playerWon) {
    playVictoryMusic();
    goEl.className = 'victory';
    title.textContent = 'You Win!';
    sub.textContent = `All 52 legends are yours, ${playerName}. You are THE GAFFER.`;
  } else {
    playDefeatMusic();
    goEl.className = 'defeat';
    title.textContent = 'Defeated';
    sub.textContent = `${playerName}, the opposition has all the cards. Time for a rematch.`;
  }

  statsEl.innerHTML = `
    <div class="go-stat"><div class="go-stat-val">${state.roundsWon}</div><div class="go-stat-label">Won</div></div>
    <div class="go-stat"><div class="go-stat-val">${state.roundsLost}</div><div class="go-stat-label">Lost</div></div>
    <div class="go-stat"><div class="go-stat-val">${state.roundsDrawn}</div><div class="go-stat-label">Draws</div></div>
    <div class="go-stat"><div class="go-stat-val">${state.bestStreak}</div><div class="go-stat-label">Best Streak</div></div>
    <div class="go-stat"><div class="go-stat-val">${state.warsWon}</div><div class="go-stat-label">Wars Won</div></div>
    <div class="go-stat"><div class="go-stat-val">${state.abilitiesUsed}</div><div class="go-stat-label">Powers Used</div></div>
    <div class="go-stat"><div class="go-stat-val">${state.roundNumber}</div><div class="go-stat-label">Rounds</div></div>
  `;
  scoreEl.textContent = `Score: ${score}`;

  // Show name input for leaderboard
  nameRow.style.display = 'flex';
  savedMsg.style.display = 'none';
  savedMsg.textContent = '';
  const nameInput = document.getElementById('go-name-input');
  nameInput.value = playerName || localStorage.getItem('gaffer26-name') || '';

  // Store pending score for submit
  state.pendingScore = { score, won: playerWon, rounds: totalRounds, streak: state.bestStreak, warsWon: state.warsWon };

  goEl.style.display = 'flex';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEADERBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getLeaderboard() {
  try { return JSON.parse(localStorage.getItem('gaffer26-lb') || '[]'); }
  catch { return []; }
}

function saveLeaderboard(lb) {
  localStorage.setItem('gaffer26-lb', JSON.stringify(lb));
}

function submitScore() {
  const nameInput = document.getElementById('go-name-input');
  const name = nameInput.value.trim() || playerName || 'Anonymous';
  localStorage.setItem('gaffer26-name', name);

  const p = state.pendingScore;
  if (!p) return;

  const entry = {
    name,
    score: p.score,
    won: p.won,
    rounds: p.rounds,
    streak: p.streak,
    wars: p.warsWon,
    date: new Date().toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'2-digit' })
  };

  const lb = getLeaderboard();
  lb.push(entry);
  lb.sort((a, b) => b.score - a.score);
  if (lb.length > 20) lb.length = 20;
  saveLeaderboard(lb);

  document.getElementById('go-name-row').style.display = 'none';
  const savedMsg = document.getElementById('go-saved-msg');
  const rank = lb.findIndex(e => e === entry) + 1;
  savedMsg.textContent = rank <= 3 ? `#${rank} ‚Äî New top score!` : `Saved ‚Äî #${rank} on the board`;
  savedMsg.style.display = 'block';
  state.pendingScore = null;
}

function renderLeaderboard() {
  const lb = getLeaderboard();
  const body = document.getElementById('lb-body');
  if (lb.length === 0) {
    body.innerHTML = '<tr><td colspan="5" class="lb-empty">No scores yet. Win a game to claim the #1 spot.</td></tr>';
    return;
  }
  const medals = ['lb-gold', 'lb-silver', 'lb-bronze'];
  body.innerHTML = lb.map((e, i) => {
    const cls = medals[i] || '';
    const icon = i === 0 ? 'üëë' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i + 1}`;
    const wl = e.won ? '<span style="color:var(--gold)">W</span>' : '<span style="color:#e74c3c">L</span>';
    return `<tr class="${cls}"><td class="lb-rank">${icon}</td><td class="lb-name">${esc(e.name)}</td><td>${wl}</td><td>${e.streak || '-'}</td><td class="lb-score">${e.score}</td></tr>`;
  }).join('');
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function showLeaderboard() {
  renderLeaderboard();
  document.getElementById('leaderboard-screen').style.display = 'flex';
}

function hideLeaderboard() {
  document.getElementById('leaderboard-screen').style.display = 'none';
}

function clearLeaderboard() {
  if (!confirm('Clear all leaderboard scores?')) return;
  localStorage.removeItem('gaffer26-lb');
  renderLeaderboard();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPERPOWER GIF FLASH EFFECT ‚Äî iconic moments for each player
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPERPOWER_GIFS = {
  "Peter Schmeichel": "https://media.giphy.com/media/l0HlFZ3c4NENSLQRi/giphy.gif",
  "Petr ƒåech": "https://media.giphy.com/media/3o6ZsYm5kaLKqBgIvu/giphy.gif",
  "Jens Lehmann": "https://media.giphy.com/media/l0HlvB82aMHlGMXeg/giphy.gif",
  "David Seaman": "https://media.giphy.com/media/3o7TKF1fSIs1R19B8k/giphy.gif",
  "David James": "https://media.giphy.com/media/26FLgGTPUDH6UGAbm/giphy.gif",
  "Jerzy Dudek": "https://media.giphy.com/media/l0MYGb1LuZ3n7dRnO/giphy.gif",
  "Tim Howard": "https://media.giphy.com/media/xTiTnwgQ8Wjs1sUB4k/giphy.gif",
  "Shaka Hislop": "https://media.giphy.com/media/3o6ZtpxSZbQRRnwCKQ/giphy.gif",
  "Paul Robinson": "https://media.giphy.com/media/l0ExayQDzrI2xOb8A/giphy.gif",
  "Neville Southall": "https://media.giphy.com/media/3o7btPCcdNniyf0ArS/giphy.gif",
  "Heurelho Gomes": "https://media.giphy.com/media/26BRBKqUiq586bRVm/giphy.gif",
  "Robert Green": "https://media.giphy.com/media/l2JhpjWPccQhsAMfu/giphy.gif",
  "Massimo Taibi": "https://media.giphy.com/media/l0HlvB82aMHlGMXeg/giphy.gif",
  "Rio Ferdinand": "https://media.giphy.com/media/3o6ZsYm5kaLKqBgIvu/giphy.gif",
  "John Terry": "https://media.giphy.com/media/26FLgGTPUDH6UGAbm/giphy.gif",
  "Ashley Cole": "https://media.giphy.com/media/l0HlFZ3c4NENSLQRi/giphy.gif",
  "Nemanja Vidiƒá": "https://media.giphy.com/media/3o7TKF1fSIs1R19B8k/giphy.gif",
  "Stuart Pearce": "https://media.giphy.com/media/l0MYGb1LuZ3n7dRnO/giphy.gif",
  "Vinnie Jones": "https://media.giphy.com/media/xTiTnwgQ8Wjs1sUB4k/giphy.gif",
  "Gary Neville": "https://media.giphy.com/media/3o6ZtpxSZbQRRnwCKQ/giphy.gif",
  "Patrice Evra": "https://media.giphy.com/media/l0ExayQDzrI2xOb8A/giphy.gif",
  "Virgil van Dijk": "https://media.giphy.com/media/3o7btPCcdNniyf0ArS/giphy.gif",
  "Jaap Stam": "https://media.giphy.com/media/26BRBKqUiq586bRVm/giphy.gif",
  "Martin Keown": "https://media.giphy.com/media/l2JhpjWPccQhsAMfu/giphy.gif",
  "Micah Richards": "https://media.giphy.com/media/26FLgGTPUDH6UGAbm/giphy.gif",
  "Titus Bramble": "https://media.giphy.com/media/l0HlvB82aMHlGMXeg/giphy.gif",
  "Paul Gascoigne": "https://media.giphy.com/media/xT0xeJpnrWC3Nbo8jK/giphy.gif",
  "David Beckham": "https://media.giphy.com/media/3o6Zt481isNVuQI1l6/giphy.gif",
  "Steven Gerrard": "https://media.giphy.com/media/26BRBKqUiq586bRVm/giphy.gif",
  "Frank Lampard": "https://media.giphy.com/media/l0HlFZ3c4NENSLQRi/giphy.gif",
  "Roy Keane": "https://media.giphy.com/media/xTiTnwgQ8Wjs1sUB4k/giphy.gif",
  "Patrick Vieira": "https://media.giphy.com/media/l0MYGb1LuZ3n7dRnO/giphy.gif",
  "Paul Scholes": "https://media.giphy.com/media/3o7TKF1fSIs1R19B8k/giphy.gif",
  "Matt Le Tissier": "https://media.giphy.com/media/3o6ZtpxSZbQRRnwCKQ/giphy.gif",
  "Jack Grealish": "https://media.giphy.com/media/l0ExayQDzrI2xOb8A/giphy.gif",
  "Cole Palmer": "https://media.giphy.com/media/3o7btPCcdNniyf0ArS/giphy.gif",
  "Joey Barton": "https://media.giphy.com/media/l2JhpjWPccQhsAMfu/giphy.gif",
  "Lee Bowyer": "https://media.giphy.com/media/26FLgGTPUDH6UGAbm/giphy.gif",
  "Kieron Dyer": "https://media.giphy.com/media/l0HlvB82aMHlGMXeg/giphy.gif",
  "Thierry Henry": "https://media.giphy.com/media/l0HlFZ3c4NENSLQRi/giphy.gif",
  "Alan Shearer": "https://media.giphy.com/media/3o6ZsYm5kaLKqBgIvu/giphy.gif",
  "Wayne Rooney": "https://media.giphy.com/media/xT0xeJpnrWC3Nbo8jK/giphy.gif",
  "Eric Cantona": "https://media.giphy.com/media/3o6Zt481isNVuQI1l6/giphy.gif",
  "Sergio Ag√ºero": "https://media.giphy.com/media/26BRBKqUiq586bRVm/giphy.gif",
  "Cristiano Ronaldo": "https://media.giphy.com/media/xTiTnwgQ8Wjs1sUB4k/giphy.gif",
  "Erling Haaland": "https://media.giphy.com/media/3o7TKF1fSIs1R19B8k/giphy.gif",
  "Mo Salah": "https://media.giphy.com/media/l0MYGb1LuZ3n7dRnO/giphy.gif",
  "Jamie Vardy": "https://media.giphy.com/media/3o6ZtpxSZbQRRnwCKQ/giphy.gif",
  "Luis Su√°rez": "https://media.giphy.com/media/l0ExayQDzrI2xOb8A/giphy.gif",
  "Paolo Di Canio": "https://media.giphy.com/media/3o7btPCcdNniyf0ArS/giphy.gif",
  "Mario Balotelli": "https://media.giphy.com/media/l2JhpjWPccQhsAMfu/giphy.gif",
  "Ali Dia": "https://media.giphy.com/media/26FLgGTPUDH6UGAbm/giphy.gif",
};

// ‚îÄ‚îÄ Crowd Cheer SFX (synthesized stadium roar ‚Äî LOUD & EPIC) ‚îÄ‚îÄ
function playCrowdCheer() {
  ensureSfxCtx();
  const now = sfxCtx.currentTime;
  const dur = 3.0;

  // Layer 1: Dense crowd noise ‚Äî 10 bandpassed noise layers
  for (let i = 0; i < 10; i++) {
    const bufLen = sfxCtx.sampleRate * dur;
    const buf = sfxCtx.createBuffer(1, bufLen, sfxCtx.sampleRate);
    const data = buf.getChannelData(0);
    for (let j = 0; j < bufLen; j++) {
      // Shape: fast attack, sustained, slow fade
      const env = j < bufLen * 0.05 ? j / (bufLen * 0.05) : j < bufLen * 0.4 ? 1.0 : Math.pow(1 - (j - bufLen * 0.4) / (bufLen * 0.6), 0.7);
      data[j] = (Math.random() * 2 - 1) * env;
    }
    const src = sfxCtx.createBufferSource(); src.buffer = buf;
    const bp = sfxCtx.createBiquadFilter(); bp.type = 'bandpass';
    bp.frequency.value = 200 + i * 180 + Math.random() * 400; bp.Q.value = 0.3 + Math.random() * 1.2;
    const g = sfxCtx.createGain();
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(0.18, now + 0.06);
    g.gain.setValueAtTime(0.18, now + 0.5);
    g.gain.linearRampToValueAtTime(0.12, now + dur * 0.5);
    g.gain.exponentialRampToValueAtTime(0.001, now + dur);
    src.connect(bp); bp.connect(g); g.connect(sfxGain);
    src.start(now + Math.random() * 0.02);
  }

  // Layer 2: "OHHH!" rising vocal tone
  for (let h = 0; h < 3; h++) {
    const osc2 = sfxCtx.createOscillator(); osc2.type = 'sawtooth';
    const baseFreq = 180 + h * 60;
    osc2.frequency.setValueAtTime(baseFreq, now);
    osc2.frequency.linearRampToValueAtTime(baseFreq * 1.8, now + 0.4);
    osc2.frequency.linearRampToValueAtTime(baseFreq * 1.3, now + 1.5);
    const g2 = sfxCtx.createGain();
    g2.gain.setValueAtTime(0, now);
    g2.gain.linearRampToValueAtTime(0.06, now + 0.1);
    g2.gain.exponentialRampToValueAtTime(0.001, now + 1.8);
    const lp2 = sfxCtx.createBiquadFilter(); lp2.type = 'lowpass'; lp2.frequency.value = 800;
    osc2.connect(lp2); lp2.connect(g2); g2.connect(sfxGain);
    osc2.start(now); osc2.stop(now + 2);
  }

  // Layer 3: Rising excitement swell
  const osc = sfxCtx.createOscillator(); osc.type = 'sawtooth';
  osc.frequency.setValueAtTime(150, now);
  osc.frequency.linearRampToValueAtTime(450, now + 0.5);
  osc.frequency.linearRampToValueAtTime(280, now + dur);
  const og = sfxCtx.createGain();
  og.gain.setValueAtTime(0, now);
  og.gain.linearRampToValueAtTime(0.05, now + 0.15);
  og.gain.exponentialRampToValueAtTime(0.001, now + dur * 0.8);
  const lp = sfxCtx.createBiquadFilter(); lp.type = 'lowpass'; lp.frequency.value = 600; lp.Q.value = 1;
  osc.connect(lp); lp.connect(og); og.connect(sfxGain);
  osc.start(now); osc.stop(now + dur);
}

function showSuperpowerFlash(card) {
  // CROWD CHEER! Always play it ‚Äî it's the moment!
  playCrowdCheer();

  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:160;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);pointer-events:none';

  // Flashing strobe border effect
  const strobeStyle = document.createElement('style');
  strobeStyle.textContent = `
    @keyframes spFlash { 0%,100%{opacity:1} 15%{opacity:0.3} 30%{opacity:1} 45%{opacity:0.4} 60%{opacity:1} }
    @keyframes spStrobe { 0%,100%{box-shadow:0 0 40px rgba(212,175,55,0.3),inset 0 0 80px rgba(212,175,55,0.05)} 50%{box-shadow:0 0 80px rgba(212,175,55,0.7),inset 0 0 120px rgba(212,175,55,0.1)} }
    @keyframes spSlam { 0%{transform:scale(0.3) rotate(-5deg);opacity:0} 60%{transform:scale(1.1) rotate(1deg);opacity:1} 100%{transform:scale(1) rotate(0deg);opacity:1} }
    @keyframes spBlink { 0%,100%{opacity:1} 50%{opacity:0.5} }
  `;
  document.head.appendChild(strobeStyle);

  overlay.innerHTML = '<div style="position:absolute;inset:0;background:radial-gradient(circle at center,rgba(212,175,55,0.2),transparent 60%);animation:spStrobe 0.4s ease infinite"></div>';

  const inner = document.createElement('div');
  inner.style.cssText = 'text-align:center;animation:spSlam 0.5s cubic-bezier(0.2,0,0.1,1);z-index:1;position:relative';

  const gifUrl = SUPERPOWER_GIFS[card.name];
  const gifHTML = gifUrl ? `<div style="width:clamp(200px,55vw,340px);height:clamp(150px,40vw,250px);margin:0 auto 1rem;border-radius:12px;overflow:hidden;border:3px solid var(--gold);box-shadow:0 0 50px rgba(212,175,55,0.4);animation:spBlink 0.3s ease 3"><img src="${gifUrl}" style="width:100%;height:100%;object-fit:cover" onerror="this.parentElement.style.display='none'"></div>` : '';

  const emojiMap = {
    'Star-Fish':'üåü', 'The Helmet':'‚õëÔ∏è', 'Unhinged':'üò§', 'The Ponytail':'üíá', 'Calamity':'üí•',
    'Wobbly Legs':'ü¶µ', 'Long Bomb':'üöÄ', 'Name Power':'‚ú®', 'Goal Kick':'ü•Ö', 'Twitter Rant':'üì±',
    'Chaos Merchant':'üé∞', 'The Fumble':'ü§¶', 'Through the Legs':'ü´£', 'Rolls Royce':'üöó',
    'Full Kit':'üëï', 'Air Rifle':'üî´', 'Zero Fear':'üòà', 'Psycho':'ü§¨', 'The Grab':'‚úä',
    'Pundit Mode':'üì∫', 'Raw Chicken':'üçó', 'Colossus':'üóø', 'The Stare':'üëÄ', 'The Snarl':'üò°',
    'Big Laugh':'üòÇ', 'Walking Disaster':'üôà', "Dentist's Chair":'üç∫', 'Free Kick':'üéØ',
    'The Slip':'üçå', 'Ghost Goal':'üëª', 'Red Mist':'üî¥', 'Tunnel Wars':'ü§ú', 'Tree Shot':'üå≥',
    'Loyalty':'üíõ', 'Tiny Shin Pads':'ü©≥', 'Cold Palmer':'ü•∂', 'Cigar Burn':'üö¨',
    'Friendly Fire':'üëä', 'Glass Legs':'ü¶ø', 'Va Va Voom':'üí´', 'The Celebration':'üôã',
    'Overhead Kick':'ü§∏', 'Kung Fu Kick':'ü•ã', 'AGUEROOOO':'‚è±Ô∏è', 'SIUUU':'üí™', 'Viking Mode':'‚öîÔ∏è',
    'Cut Inside':'‚Ü©Ô∏è', 'Chat Shit':'üó£Ô∏è', 'The Bite':'ü¶∑', 'The Volley':'üéÜ',
    'Why Always Me':'ü§∑', 'The Con':'üé≠',
  };
  const emoji = emojiMap[card.ability.name] || '‚ö°';

  inner.innerHTML = `
    <div style="font-family:'Oswald',sans-serif;font-size:clamp(0.6rem,1.5vw,0.8rem);text-transform:uppercase;letter-spacing:0.4em;color:var(--gold);margin-bottom:0.5rem;animation:spBlink 0.5s ease 4">‚ö° SUPERPOWER ACTIVATED ‚ö°</div>
    ${gifHTML}
    <div style="font-size:clamp(3rem,12vw,6rem);line-height:1;animation:spFlash 0.6s ease">${emoji}</div>
    <div style="font-family:'Oswald',sans-serif;font-size:clamp(2rem,6vw,3.5rem);color:var(--gold);text-transform:uppercase;letter-spacing:0.12em;margin-top:0.3rem;text-shadow:0 0 30px rgba(212,175,55,0.6);animation:spBlink 0.4s ease 5">${card.ability.name}</div>
    <div style="font-size:0.9rem;color:#ccc;margin-top:0.5rem;max-width:320px;margin-left:auto;margin-right:auto">${card.ability.desc}</div>
    <div style="font-family:'Oswald',sans-serif;font-size:0.75rem;color:#666;margin-top:0.6rem;text-transform:uppercase;letter-spacing:0.2em">${'‚ö°'.repeat(state.energy)}${'¬∑'.repeat(state.maxEnergy - state.energy)} ${state.energy}/${state.maxEnergy} energy remaining</div>
  `;

  overlay.appendChild(inner);
  document.body.appendChild(overlay);

  // Quick white flash on entry
  const flashEl = document.createElement('div');
  flashEl.style.cssText = 'position:fixed;inset:0;z-index:161;background:rgba(255,255,255,0.4);pointer-events:none;transition:opacity 0.15s';
  document.body.appendChild(flashEl);
  setTimeout(() => { flashEl.style.opacity = '0'; setTimeout(() => flashEl.remove(), 200); }, 80);

  setTimeout(() => {
    overlay.style.opacity = '0';
    overlay.style.transition = 'opacity 0.6s';
    setTimeout(() => { overlay.remove(); strobeStyle.remove(); }, 600);
  }, 3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPERPOWER TUTORIAL (one-time popup)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showAbilityTutorial(card) {
  const overlay = document.createElement('div');
  overlay.className = 'tutorial-overlay';
  overlay.innerHTML = `
    <div class="tutorial-box">
      <div class="tut-icon" style="font-size:3rem;animation:spBlink 0.5s ease 6">‚ö°</div>
      <h3 style="font-size:1.8rem;margin-bottom:0.5rem">SUPERPOWER!</h3>
      <p style="font-size:1rem;color:#ddd;margin-bottom:0.8rem">Every card has a <span class="tut-highlight">unique superpower</span> ‚Äî a game-changing special ability.</p>
      <div class="tut-example" style="padding:1rem;margin-bottom:1rem">
        <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:0.2em;color:#666;margin-bottom:0.3rem">Your card's power:</div>
        <strong style="font-size:1.1rem">${card.name}</strong><br>
        <span style="color:var(--gold);font-size:1.1rem;font-weight:700">‚ö° ${card.ability.name}</span><br>
        <em style="color:#aaa;font-size:0.85rem">${card.ability.desc}</em>
      </div>
      <div style="background:rgba(212,175,55,0.08);border:1px solid rgba(212,175,55,0.2);border-radius:6px;padding:0.8rem;margin-bottom:1rem;text-align:left">
        <div style="font-size:0.7rem;color:var(--gold);text-transform:uppercase;letter-spacing:0.15em;margin-bottom:0.4rem;font-weight:600">How it works:</div>
        <div style="font-size:0.85rem;color:#bbb;line-height:1.6">
          <div>1. Play your card as normal</div>
          <div>2. Look for the <span style="color:var(--gold);font-weight:700">blinking ‚ö° button</span></div>
          <div>3. Tap it <strong style="color:#fff">before</strong> picking your stat!</div>
        </div>
      </div>
      <p style="color:#e74c3c;font-weight:600;font-size:1rem">‚ö†Ô∏è Only <span class="tut-highlight">${ABILITY_CAP} superpowers per game</span></p>
      <p style="color:#777;font-size:0.82rem">Choose your moments ‚Äî the crowd goes wild when you deploy one.</p>
      <button class="tut-btn" onclick="this.closest('.tutorial-overlay').remove()" style="font-size:1rem;padding:0.7rem 2.5rem;margin-top:0.5rem">Let's Go!</button>
    </div>
  `;
  document.body.appendChild(overlay);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOBY MUSIC ENGINE ‚Äî Functions (variables declared at top of script)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function shuffleGameplayTracks() {
  shuffledGameplayTracks = [...ALL_GAMEPLAY_TRACKS].sort(() => Math.random() - 0.5);
  gameplayTrackIndex = 0;
}
shuffleGameplayTracks();

function getNextGameplayTrack() {
  if (gameplayTrackIndex >= shuffledGameplayTracks.length) shuffleGameplayTracks();
  return shuffledGameplayTracks[gameplayTrackIndex++];
}

function preloadTracks() {
  const urls = new Set(Object.values(MUSIC_TRACKS).concat(ALL_GAMEPLAY_TRACKS));
  urls.forEach(url => {
    if (!audioCache[url]) {
      const a = new Audio(url);
      a.preload = 'auto';
      a.volume = 0;
      audioCache[url] = a;
    }
  });
}

// Smooth fade helper
function fadeAudio(audio, fromVol, toVol, duration, onDone) {
  const steps = Math.max(1, Math.round(duration * 30)); // 30fps
  const stepMs = (duration * 1000) / steps;
  const volStep = (toVol - fromVol) / steps;
  let step = 0;
  const iv = setInterval(() => {
    step++;
    const v = fromVol + volStep * step;
    audio.volume = Math.max(0, Math.min(1, v));
    if (step >= steps) {
      clearInterval(iv);
      audio.volume = Math.max(0, Math.min(1, toVol));
      if (onDone) onDone();
    }
  }, stepMs);
  return iv;
}

// Play a track with crossfade
function playTrack(url, { crossfade = 1.5, loop = true, volume = 0.7, autoShuffle = false } = {}) {
  // Don't restart same track
  if (currentTrack === url && currentAudio && !currentAudio.paused) return;

  const targetVol = musicMuted ? 0 : volume;
  musicVolume = volume;

  // Clear any pending auto-advance
  if (autoAdvanceTimer) { clearTimeout(autoAdvanceTimer); autoAdvanceTimer = null; }

  // Fade out old track
  if (currentAudio && !currentAudio.paused) {
    const oldAudio = currentAudio;
    fadingOutAudio = oldAudio;
    fadeAudio(oldAudio, oldAudio.volume, 0, crossfade, () => {
      oldAudio.pause();
      oldAudio.currentTime = 0;
      if (fadingOutAudio === oldAudio) fadingOutAudio = null;
    });
  }

  // Get or create Audio element
  let audio = audioCache[url];
  if (!audio) {
    audio = new Audio(url);
    audioCache[url] = audio;
  }

  audio.loop = loop;
  audio.currentTime = 0;
  audio.volume = 0;

  const playPromise = audio.play();
  if (playPromise) {
    playPromise.catch(e => {
      console.warn('Music play blocked:', e);
      // Retry once on next user interaction
      const retryOnce = () => {
        audio.play().catch(() => {});
        document.removeEventListener('click', retryOnce);
        document.removeEventListener('touchstart', retryOnce);
      };
      document.addEventListener('click', retryOnce, { once: true });
      document.addEventListener('touchstart', retryOnce, { once: true });
    });
  }

  // Fade in
  fadeAudio(audio, 0, targetVol, crossfade);

  // Auto-advance to next track when this one nears end (for gameplay variety)
  if (autoShuffle) {
    const setupAdvance = () => {
      if (audio.duration && audio.duration > 10) {
        const advanceAt = (audio.duration - crossfade - 1) * 1000;
        if (advanceAt > 0) {
          autoAdvanceTimer = setTimeout(() => {
            if (musicPlaying && currentAudio === audio && currentTrack === url) {
              const nextUrl = getNextGameplayTrack();
              playTrack(nextUrl, { crossfade: 3, loop: false, volume, autoShuffle: true });
            }
          }, advanceAt);
        }
      }
    };
    if (audio.duration) setupAdvance();
    else audio.addEventListener('loadedmetadata', setupAdvance, { once: true });
  }

  // For non-looping tracks, play next when it ends
  if (!loop && autoShuffle) {
    audio.onended = () => {
      if (musicPlaying && currentAudio === audio) {
        const nextUrl = getNextGameplayTrack();
        playTrack(nextUrl, { crossfade: 1, loop: false, volume, autoShuffle: true });
      }
    };
  }

  currentAudio = audio;
  currentTrack = url;
  musicPlaying = true;
  document.getElementById('volume-control').style.display = 'flex';
}

// ‚îÄ‚îÄ High-level music functions called by game logic ‚îÄ‚îÄ
function playIntroMusic() {
  playTrack(MUSIC_TRACKS.intro, { crossfade: 0.5, loop: true, volume: 0.6 });
}

function playMenuMusic() {
  playTrack(MUSIC_TRACKS.menu, { crossfade: 1.5, loop: true, volume: 0.65 });
}

function playGameplayMusic() {
  shuffleGameplayTracks();
  const track = getNextGameplayTrack();
  playTrack(track, { crossfade: 2, loop: false, volume: 0.55, autoShuffle: true });
}

function playIntenseMusic() {
  playTrack(MUSIC_TRACKS.intense, { crossfade: 1, loop: true, volume: 0.7 });
}

function playHalftimeMusic() {
  playTrack(MUSIC_TRACKS.halftime, { crossfade: 2, loop: true, volume: 0.5 });
}

function playVictoryMusic() {
  playTrack(MUSIC_TRACKS.victory, { crossfade: 1, loop: false, volume: 0.75 });
}

function playDefeatMusic() {
  playTrack(MUSIC_TRACKS.defeat, { crossfade: 1, loop: false, volume: 0.65 });
}

function playDrawMusic() {
  playTrack(MUSIC_TRACKS.draw, { crossfade: 0.5, loop: false, volume: 0.7 });
}

function stopMusic() {
  if (autoAdvanceTimer) { clearTimeout(autoAdvanceTimer); autoAdvanceTimer = null; }
  if (currentAudio) {
    fadeAudio(currentAudio, currentAudio.volume, 0, 0.5, () => {
      if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; }
    });
  }
  currentTrack = null;
  musicPlaying = false;
}

function initMusic() {
  // Called by ensureMusic ‚Äî music is already playing by then,
  // so just preload remaining tracks
  preloadTracks();
}

function toggleMusic() {
  // If music hasn't started yet, start it on this user gesture
  if (!musicConfirmed) { ensureMusic(); return; }
  musicMuted = !musicMuted;
  const btn = document.getElementById('vol-btn');
  if (musicMuted) {
    if (currentAudio) fadeAudio(currentAudio, currentAudio.volume, 0, 0.2);
    btn.textContent = 'üîá';
    btn.classList.add('muted');
  } else {
    if (currentAudio) fadeAudio(currentAudio, 0, musicVolume, 0.3);
    btn.textContent = 'üîä';
    btn.classList.remove('muted');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PER-PLAYER CARD DEPLOYMENT SOUND EFFECTS
// Each player gets a unique sound when their card is played
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PLAYER_SOUNDS = {
  // Goalkeepers ‚Äî dramatic saves, diving sounds
  "Peter Schmeichel": { freq: 220, type: 'sawtooth', sweep: 880, dur: 0.3, filter: 2000 }, // big roar
  "Petr ƒåech": { freq: 400, type: 'sine', sweep: 200, dur: 0.25, filter: 1500 }, // helmet clang
  "Jens Lehmann": { freq: 600, type: 'square', sweep: 150, dur: 0.2, filter: 3000 }, // sharp whistle
  "David Seaman": { freq: 300, type: 'triangle', sweep: 100, dur: 0.35, filter: 1000 }, // ponytail swoosh
  "David James": { freq: 180, type: 'sawtooth', sweep: 500, dur: 0.15, filter: 800 }, // fumble thud
  "Jerzy Dudek": { freq: 350, type: 'square', sweep: 700, dur: 0.3, filter: 2500 }, // wobbly
  "Tim Howard": { freq: 100, type: 'sine', sweep: 800, dur: 0.4, filter: 3000 }, // long bomb whoosh
  "Shaka Hislop": { freq: 440, type: 'triangle', sweep: 880, dur: 0.25, filter: 4000 }, // power chord
  "Paul Robinson": { freq: 150, type: 'sine', sweep: 600, dur: 0.35, filter: 2000 }, // goal kick boom
  "Neville Southall": { freq: 200, type: 'sawtooth', sweep: 400, dur: 0.2, filter: 1200 }, // tweet ding
  "Heurelho Gomes": { freq: 500, type: 'square', sweep: 100, dur: 0.15, filter: 2000 }, // chaos zap
  "Robert Green": { freq: 250, type: 'triangle', sweep: 80, dur: 0.3, filter: 600 }, // sad trombone
  "Massimo Taibi": { freq: 180, type: 'sine', sweep: 60, dur: 0.4, filter: 400 }, // ball through legs

  // Defenders ‚Äî hard tackles, walls
  "Rio Ferdinand": { freq: 300, type: 'sine', sweep: 600, dur: 0.3, filter: 3000 }, // smooth cruise
  "John Terry": { freq: 160, type: 'sawtooth', sweep: 320, dur: 0.25, filter: 1500 }, // captain bark
  "Ashley Cole": { freq: 500, type: 'square', sweep: 1000, dur: 0.15, filter: 4000 }, // rifle crack
  "Nemanja Vidiƒá": { freq: 120, type: 'sawtooth', sweep: 240, dur: 0.35, filter: 800 }, // header crunch
  "Stuart Pearce": { freq: 200, type: 'square', sweep: 800, dur: 0.2, filter: 3000 }, // psycho scream
  "Vinnie Jones": { freq: 100, type: 'sawtooth', sweep: 200, dur: 0.4, filter: 600 }, // menacing growl
  "Gary Neville": { freq: 400, type: 'triangle', sweep: 800, dur: 0.2, filter: 2500 }, // pundit analysis
  "Patrice Evra": { freq: 350, type: 'sine', sweep: 700, dur: 0.3, filter: 3500 }, // I LOVE THIS GAME
  "Virgil van Dijk": { freq: 130, type: 'sine', sweep: 260, dur: 0.4, filter: 1000 }, // colossus step
  "Jaap Stam": { freq: 110, type: 'sawtooth', sweep: 220, dur: 0.35, filter: 700 }, // death stare
  "Martin Keown": { freq: 250, type: 'square', sweep: 500, dur: 0.15, filter: 2000 }, // snarl snap
  "Micah Richards": { freq: 440, type: 'triangle', sweep: 880, dur: 0.25, filter: 4000 }, // big laugh
  "Titus Bramble": { freq: 180, type: 'square', sweep: 90, dur: 0.3, filter: 500 }, // disaster wobble

  // Midfielders ‚Äî flair, technique
  "Paul Gascoigne": { freq: 440, type: 'sine', sweep: 880, dur: 0.35, filter: 4000 }, // genius sparkle
  "David Beckham": { freq: 500, type: 'triangle', sweep: 1000, dur: 0.3, filter: 5000 }, // free kick whip
  "Steven Gerrard": { freq: 300, type: 'sawtooth', sweep: 600, dur: 0.25, filter: 2500 }, // thunderbolt
  "Frank Lampard": { freq: 350, type: 'sine', sweep: 700, dur: 0.3, filter: 3000 }, // ghost run
  "Roy Keane": { freq: 150, type: 'sawtooth', sweep: 300, dur: 0.2, filter: 1000 }, // tackle crunch
  "Patrick Vieira": { freq: 180, type: 'square', sweep: 360, dur: 0.3, filter: 1500 }, // tunnel stomp
  "Paul Scholes": { freq: 400, type: 'triangle', sweep: 800, dur: 0.25, filter: 3500 }, // ping pass
  "Matt Le Tissier": { freq: 520, type: 'sine', sweep: 260, dur: 0.4, filter: 4000 }, // genius touch
  "Jack Grealish": { freq: 450, type: 'triangle', sweep: 900, dur: 0.2, filter: 3000 }, // dribble shimmy
  "Cole Palmer": { freq: 380, type: 'sine', sweep: 190, dur: 0.3, filter: 2500 }, // ice cold
  "Joey Barton": { freq: 200, type: 'sawtooth', sweep: 400, dur: 0.15, filter: 1200 }, // cigar sizzle
  "Lee Bowyer": { freq: 250, type: 'square', sweep: 500, dur: 0.2, filter: 2000 }, // punch thwack
  "Kieron Dyer": { freq: 600, type: 'triangle', sweep: 300, dur: 0.15, filter: 4000 }, // sprint burst

  // Strikers ‚Äî goals, power
  "Thierry Henry": { freq: 500, type: 'sine', sweep: 1000, dur: 0.35, filter: 5000 }, // va va voom
  "Alan Shearer": { freq: 220, type: 'sawtooth', sweep: 440, dur: 0.3, filter: 2000 }, // celebration
  "Wayne Rooney": { freq: 300, type: 'square', sweep: 900, dur: 0.25, filter: 3000 }, // overhead smash
  "Eric Cantona": { freq: 350, type: 'sine', sweep: 700, dur: 0.4, filter: 3500 }, // kung fu swoosh
  "Sergio Ag√ºero": { freq: 600, type: 'sawtooth', sweep: 1200, dur: 0.35, filter: 5000 }, // AGUEROOOO rising
  "Cristiano Ronaldo": { freq: 440, type: 'square', sweep: 880, dur: 0.3, filter: 4000 }, // SIUUU
  "Erling Haaland": { freq: 120, type: 'sawtooth', sweep: 480, dur: 0.35, filter: 1500 }, // viking hammer
  "Mo Salah": { freq: 480, type: 'triangle', sweep: 960, dur: 0.25, filter: 4500 }, // cut inside zip
  "Jamie Vardy": { freq: 550, type: 'square', sweep: 275, dur: 0.2, filter: 3000 }, // chat shit bark
  "Luis Su√°rez": { freq: 350, type: 'sawtooth', sweep: 175, dur: 0.3, filter: 2000 }, // bite snap
  "Paolo Di Canio": { freq: 600, type: 'sine', sweep: 1200, dur: 0.3, filter: 5000 }, // volley crack
  "Mario Balotelli": { freq: 400, type: 'square', sweep: 200, dur: 0.25, filter: 2500 }, // firework pop
  "Ali Dia": { freq: 150, type: 'triangle', sweep: 75, dur: 0.4, filter: 500 }, // sad wobble
};

// Shared AudioContext for sound effects (separate from music)
let sfxCtx = null;
let sfxGain = null;

function ensureSfxCtx() {
  if (!sfxCtx) {
    sfxCtx = new (window.AudioContext || window.webkitAudioContext)();
    sfxGain = sfxCtx.createGain();
    sfxGain.gain.value = 0.4;
    sfxGain.connect(sfxCtx.destination);
  }
  if (sfxCtx.state === 'suspended') sfxCtx.resume();
}

function playCardSound(card) {
  if (musicMuted) return;
  const s = PLAYER_SOUNDS[card.name];
  if (!s) return;
  ensureSfxCtx();
  const now = sfxCtx.currentTime;

  // Main tone with frequency sweep
  const osc = sfxCtx.createOscillator();
  osc.type = s.type;
  osc.frequency.setValueAtTime(s.freq, now);
  osc.frequency.exponentialRampToValueAtTime(Math.max(s.sweep, 20), now + s.dur * 0.7);

  // Filter sweep for character
  const flt = sfxCtx.createBiquadFilter();
  flt.type = 'lowpass';
  flt.frequency.setValueAtTime(s.filter, now);
  flt.frequency.exponentialRampToValueAtTime(200, now + s.dur);
  flt.Q.value = 2;

  // Envelope
  const g = sfxCtx.createGain();
  g.gain.setValueAtTime(0, now);
  g.gain.linearRampToValueAtTime(0.15, now + 0.01);
  g.gain.setTargetAtTime(0.001, now + s.dur * 0.5, s.dur * 0.3);

  // Impact noise layer
  const noiseBuf = sfxCtx.createBuffer(1, sfxCtx.sampleRate * 0.05, sfxCtx.sampleRate);
  const nd = noiseBuf.getChannelData(0);
  for (let i = 0; i < nd.length; i++) nd[i] = (Math.random() * 2 - 1) * Math.pow(1 - i/nd.length, 4);
  const noise = sfxCtx.createBufferSource(); noise.buffer = noiseBuf;
  const ng = sfxCtx.createGain(); ng.gain.value = 0.06;
  const nf = sfxCtx.createBiquadFilter(); nf.type = 'bandpass'; nf.frequency.value = s.filter * 0.8; nf.Q.value = 1;

  osc.connect(flt); flt.connect(g); g.connect(sfxGain);
  noise.connect(nf); nf.connect(ng); ng.connect(sfxGain);
  osc.start(now); osc.stop(now + s.dur);
  noise.start(now);
}

// Ensure music is playing when game starts
// Music is now handled inside startGame() via playGameplayMusic()

// Fetch player images on page load (so they're ready before game starts)
fetchPlayerImages();
</script>
</body>
</html>
